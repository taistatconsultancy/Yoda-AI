
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>YodaAI - Assistant</title>
  <meta content="Transform your agile retrospectives with AI-powered facilitation. YodaAI guides teams through structured 4Ls retrospectives." name="description">
  <meta content="retrospective, agile, scrum, AI, 4Ls, team management" name="keywords">
  
  <!-- Favicon -->
  <link rel="icon" href="/ui/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/ui/favicon.png" type="image/png">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  
  <style>
    :root {
      --primary-color: #4154f1;
      --secondary-color: #717ff5;
      --dark-color: #012970;
      --light-color: #f6f9ff;
      --gray-color: #899bbd;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Open Sans", sans-serif;
      color: #444444;
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }

    a:hover {
      color: var(--secondary-color);
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: "Nunito", sans-serif;
    }

    /* ==================== LANDING PAGE ==================== */
    .landing-page {
      display: block;
    }

    .header {
      background: #fff;
      transition: all 0.5s;
      z-index: 997;
      padding: 15px 0;
      box-shadow: 0px 2px 20px rgba(1, 41, 112, 0.1);
    }

    .header .logo {
      font-size: 30px;
      margin: 0;
      padding: 0;
      line-height: 1;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-family: "Nunito", sans-serif;
    }

    .header .logo span {
      color: var(--primary-color);
    }

    .navbar {
      padding: 0;
    }

    .navbar .getstarted {
      background: var(--primary-color);
      padding: 8px 20px;
      margin-left: 30px;
      border-radius: 4px;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .navbar .getstarted:hover {
      background: var(--secondary-color);
    }

    /* Mobile landing page header */
    @media (max-width: 768px) {
      .header {
        padding: 12px 0;
      }

      .header .logo {
        font-size: 24px;
      }

      .navbar ul {
        flex-wrap: wrap;
        gap: 10px;
      }

      .navbar .getstarted {
        margin-left: 15px;
        padding: 8px 16px;
        font-size: 14px;
      }

      .navbar li a {
        font-size: 14px;
        margin-left: 15px !important;
      }
    }

    @media (max-width: 480px) {
      .header .logo {
        font-size: 20px;
      }

      .navbar .getstarted {
        margin-left: 10px;
        padding: 6px 12px;
        font-size: 13px;
      }

      .navbar li a {
        font-size: 13px;
        margin-left: 10px !important;
      }
    }

    .hero {
      width: 100%;
      height: 100vh;
      min-height: 600px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
    }

    /* Mobile hero section */
    @media (max-width: 768px) {
      .hero {
        height: auto;
        min-height: auto;
        padding: 80px 0 60px;
      }

      .hero h1 {
        font-size: 2rem !important;
      }

      .hero h2 {
        font-size: 1.1rem !important;
      }

      .btn-get-started {
        padding: 10px 20px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .hero {
        padding: 60px 0 40px;
      }

      .hero h1 {
        font-size: 1.75rem !important;
      }

      .hero h2 {
        font-size: 1rem !important;
      }
    }

    .hero::before {
      content: "";
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
    }

    .hero h1 {
      margin: 0;
      font-size: 48px;
      font-weight: 700;
      color: #fff;
    }

    .hero h2 {
      color: rgba(255, 255, 255, 0.9);
      margin: 15px 0 0 0;
      font-size: 24px;
    }

    .hero .btn-get-started {
      margin-top: 30px;
      line-height: 0;
      padding: 15px 40px;
      border-radius: 4px;
      transition: 0.5s;
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      font-weight: 600;
      cursor: pointer;
    }

    .hero .btn-get-started:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .features {
      background: #fff;
      padding: 80px 0;
    }

    .section-header {
      text-align: center;
      padding-bottom: 40px;
    }

    .section-header h2 {
      font-size: 13px;
      letter-spacing: 1px;
      font-weight: 700;
      color: var(--primary-color);
      text-transform: uppercase;
    }

    .section-header p {
      margin: 10px 0 0 0;
      font-size: 38px;
      font-weight: 700;
      color: var(--dark-color);
    }

    .feature-box {
      padding: 30px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0px 0 25px 0 rgba(0, 0, 0, 0.1);
      transition: 0.3s;
      height: 100%;
    }

    .feature-box:hover {
      transform: translateY(-10px);
      box-shadow: 0px 0 30px 0 rgba(1, 41, 112, 0.15);
    }

    .feature-box i {
      font-size: 48px;
      color: var(--primary-color);
      margin-bottom: 20px;
      display: block;
    }

    .feature-box h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--dark-color);
    }

    .values {
      background: var(--light-color);
      padding: 80px 0;
    }

    .values .box {
      padding: 30px;
      box-shadow: 0px 0 5px rgba(1, 41, 112, 0.08);
      text-align: center;
      transition: 0.3s;
      height: 100%;
      background: #fff;
      border-radius: 10px;
    }

    .values .box:hover {
      box-shadow: 0px 0 30px rgba(1, 41, 112, 0.15);
      transform: translateY(-5px);
    }

    .values .box h3 {
      font-size: 24px;
      color: var(--dark-color);
      font-weight: 700;
      margin-bottom: 18px;
    }

    .cta {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 80px 0;
    }

    .cta h3 {
      color: #fff;
      font-size: 28px;
      font-weight: 700;
    }

    .cta .cta-btn {
      font-weight: 600;
      display: inline-block;
      padding: 12px 40px;
      border-radius: 4px;
      border: 2px solid #fff;
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
      cursor: pointer;
    }

    .cta .cta-btn:hover {
      background: #fff;
      color: var(--primary-color);
    }

    .testimonials .testimonial-item {
      padding: 30px;
      margin: 40px 30px;
      box-shadow: 0px 0 20px rgba(1, 41, 112, 0.1);
      background: #fff;
      border-radius: 10px;
    }

    .testimonials .testimonial-item h3 {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0 5px 0;
      color: var(--dark-color);
    }

    .testimonials .testimonial-item h4 {
      font-size: 14px;
      color: #999;
      margin: 0;
    }

    .testimonials .testimonial-item .stars i {
      color: #ffc107;
      margin: 0 1px;
    }

    /* Login Modal */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .login-modal.active {
      display: flex;
    }

    .login-modal-content {
      background: white;
      border-radius: 20px;
      padding: 32px 24px;
      max-width: 420px;
      width: 100%;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
      -webkit-overflow-scrolling: touch;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .login-modal-content h1 { 
      margin-bottom: 10px; 
      font-size: 1.75rem;
    }
    
    .login-modal-content h2 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .login-modal-content .mb-4 { 
      margin-bottom: 20px !important; 
    }

    .close-modal {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .close-modal:hover { 
      background: rgba(0, 0, 0, 0.1);
      color: #000; 
      transform: rotate(90deg);
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .login-modal {
        padding: 0;
        align-items: flex-end;
      }

      .login-modal-content {
        border-radius: 20px 20px 0 0;
        max-width: 100%;
        max-height: 90vh;
        padding: 24px 20px;
        margin: 0;
        animation: modalSlideUp 0.3s ease-out;
      }

      @keyframes modalSlideUp {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .login-modal-content h1 {
        font-size: 1.5rem;
      }

      .login-modal-content h2 {
        font-size: 1.25rem;
      }

      .close-modal {
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .login-modal-content {
        padding: 20px 16px;
        border-radius: 16px 16px 0 0;
      }

      .login-modal-content h2 {
        font-size: 1.1rem;
      }

      .login-modal-content .bi-robot {
        font-size: 48px !important;
      }
    }

    /* Ultra-small phones and short viewports (e.g., landscape phones) */
    @media (max-width: 360px), (max-height: 640px) {
      .login-modal {
        padding: 0;
        align-items: stretch;
      }
      .login-modal-content {
        border-radius: 0;
        max-height: 100vh;
        height: 100vh;
        padding: 16px 14px;
      }
      .login-modal-content .btn {
        min-height: 44px;
      }
      .login-modal-content .form-control {
        min-height: 44px;
      }
    }

    /* Modern Form Styling */
    .login-modal-content .form-control {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 16px;
      transition: all 0.3s ease;
      background-color: #fafafa;
    }

    .login-modal-content .form-control:focus {
      border-color: var(--primary-color);
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(65, 84, 241, 0.1);
      outline: none;
    }

    .login-modal-content .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* Modern Button Styling */
    .login-modal-content .btn {
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      border: none;
      min-height: 48px; /* Touch-friendly minimum height */
    }

    .login-modal-content .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      box-shadow: 0 4px 15px rgba(65, 84, 241, 0.3);
    }

    .login-modal-content .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(65, 84, 241, 0.4);
    }

    .login-modal-content .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .login-modal-content .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .login-modal-content .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      background: transparent;
    }

    .login-modal-content .btn-outline-primary:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }

    .login-modal-content .btn-link {
      padding: 8px;
      min-height: auto;
    }

    /* Mobile form improvements */
    @media (max-width: 768px) {
      .login-modal-content .form-control {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 14px 16px;
      }

      .login-modal-content .btn {
        padding: 14px 24px;
        font-size: 16px;
      }

      .login-modal-content .form-label {
        font-size: 14px;
      }
    }

    /* Prevent input zoom on iOS */
    @media screen and (max-width: 768px) {
      input[type="email"],
      input[type="password"],
      input[type="text"] {
        font-size: 16px !important;
      }
    }

    /* ==================== PROFILE OVERLAY ==================== */
    .profile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow-y: auto;
    }

    .profile-overlay-content {
      background: white;
      border-radius: 20px;
      padding: 32px 24px;
      max-width: 500px;
      width: 100%;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    .country-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .country-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }

    .country-dropdown-item:hover,
    .country-dropdown-item.selected {
      background-color: #f0f4ff;
      color: var(--primary-color);
    }

    .country-dropdown-item:last-child {
      border-bottom: none;
    }

    @media (max-width: 768px) {
      .profile-overlay-content {
        padding: 24px 20px;
        max-width: 100%;
      }
    }

    /* ==================== APP (Hidden until login) ==================== */
    .app-container {
      display: none;
    }

    .app-header {
      background: #fff;
      padding: 15px 0;
      box-shadow: 0px 2px 20px rgba(1, 41, 112, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 997;
    }

    .sidebar {
      position: fixed;
      top: 60px;
      left: 0;
      bottom: 0;
      width: 280px;
      z-index: 996;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0px 0px 20px rgba(1, 41, 112, 0.1);
      background-color: #fff;
    }

    @media (max-width: 1199px) {
      .sidebar { 
        left: -280px;
        width: 280px;
        transition: left 0.3s ease;
      }
      .sidebar.show { 
        left: 0;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
      }
    }

    /* Mobile sidebar improvements */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        max-width: 280px;
        z-index: 998;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      }
    }

    .sidebar-nav {
      padding: 0;
      list-style: none;
    }

    .sidebar-nav .nav-link {
      display: flex;
      align-items: center;
      font-size: 15px;
      font-weight: 600;
      color: #4154f1;
      background: #f6f9ff;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 5px;
      cursor: pointer;
      text-decoration: none;
    }

    .sidebar-nav .nav-link i {
      font-size: 16px;
      margin-right: 10px;
    }

    .sidebar-nav .nav-link.active {
      color: #012970;
    }

    #main {
      margin-top: 60px;
      margin-left: 280px;
      padding: 20px 30px;
      min-height: calc(100vh - 60px);
      background: var(--light-color);
    }

    @media (max-width: 1199px) {
      #main { 
        margin-left: 0;
        padding: 20px 15px;
      }
    }

    /* Mobile app header and main content */
    @media (max-width: 768px) {
      .app-header {
        padding: 12px 0;
      }

      #main {
        margin-top: 56px;
        padding: 15px 12px;
      }

      .app-header .container-fluid {
        padding-left: 12px !important;
        padding-right: 12px !important;
      }

      .app-header .logo span {
        font-size: 20px !important;
      }

      .app-header .btn {
        padding: 6px 12px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      #main {
        padding: 12px 10px;
      }

      .card {
        margin-bottom: 15px;
        padding: 15px;
      }
    }

    .card {
      margin-bottom: 30px;
      border: none;
      border-radius: 5px;
      box-shadow: 0px 0 30px rgba(1, 41, 112, 0.1);
      background: #fff;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* Workspace Tabs */
    .workspace-tab {
      display: none;
    }

    .workspace-tab.active {
      display: block;
    }

    /* Chat */
    .chat-messages {
      height: 500px;
      overflow-y: auto;
      padding: 20px;
      background: var(--light-color);
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .message {
      display: flex;
      margin-bottom: 20px;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
      font-size: 20px;
    }

    .message.ai .message-avatar {
      background: linear-gradient(135deg, #4154f1 0%, #717ff5 100%);
      color: #fff;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #2eca6a 0%, #56d97b 100%);
      color: #fff;
    }

    .message-content {
      background: #fff;
      padding: 15px 20px;
      border-radius: 10px;
      max-width: 70%;
      box-shadow: 0px 0 10px rgba(1, 41, 112, 0.1);
    }

    .message.user .message-content {
      margin-left: auto;
      background: linear-gradient(135deg, #4154f1 0%, #717ff5 100%);
      color: #fff;
    }

    /* Steps */
    .steps-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .step-card {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0px 0 15px rgba(1, 41, 112, 0.1);
      border: 2px solid transparent;
      transition: all 0.3s;
      cursor: pointer;
    }

    .step-card:hover {
      transform: translateY(-5px);
    }

    .step-card.active {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, rgba(65, 84, 241, 0.05) 0%, rgba(113, 127, 245, 0.05) 100%);
    }

    .step-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      color: #fff;
      font-size: 24px;
    }

    /* Team */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .team-member-card {
      background: #fff;
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      box-shadow: 0px 0 15px rgba(1, 41, 112, 0.1);
      transition: all 0.3s;
    }

    .team-member-card:hover {
      transform: translateY(-5px);
    }

    .member-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4154f1 0%, #717ff5 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      color: #fff;
      font-size: 28px;
      font-weight: 700;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    
    /* 4Ls Category Styles */
    .fourls-category {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }
    
    .fourls-category.liked { border-color: #10b981; }
    .fourls-category.learned { border-color: #3b82f6; }
    .fourls-category.lacked { border-color: #f59e0b; }
    .fourls-category.longed { border-color: #8b5cf6; }
    
    .theme-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px 15px;
      margin-bottom: 10px;
      cursor: move;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .theme-item:hover {
      background: #f3f4f6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .theme-item.dragging {
      opacity: 0.5;
    }
    
    .themes-list {
      min-height: 50px;
    }
    
    .da-recommendation {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid #f59e0b;
    }
    
    .da-recommendation h5 {
      color: #92400e;
      font-weight: 600;
      margin-bottom: 15px;
    }
  </style>
</head>

<body>

  <!-- ==================== LANDING PAGE ==================== -->
  <div id="landingPage" class="landing-page">
    
    <!-- Header -->
    <header class="header fixed-top">
      <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
        <a href="#" class="logo d-flex align-items-center">
          <i class="bi bi-robot" style="font-size: 32px; color: var(--primary-color); margin-right: 10px;"></i>
          <span>Yoda<span>AI</span></span>
        </a>
        <nav class="navbar">
          <ul class="d-flex align-items-center list-unstyled m-0">
            <li><a class="scrollto" href="#hero">Home</a></li>
            <li><a class="scrollto" href="#about" style="margin-left: 30px;">About</a></li>
            <li><a class="scrollto" href="#features" style="margin-left: 30px;">Features</a></li>
            <li><button class="getstarted" onclick="showLoginModal()">Get Started</button></li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Hero -->
    <section id="hero" class="hero d-flex align-items-center">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 d-flex flex-column justify-content-center" data-aos="fade-up">
            <h1>Transform Your Agile Retrospectives with AI</h1>
            <h2>Your intelligent co-facilitator for structured, productive, and engaging team retrospectives using the proven 4Ls framework</h2>
            <div data-aos="fade-up" data-aos-delay="600">
              <button class="btn-get-started me-3" onclick="showLoginModal()">
                <i class="bi bi-rocket"></i> Get Started Free
              </button>
              <button class="btn-get-started" onclick="demoLogin()">
                <i class="bi bi-play-circle"></i> Try Demo
              </button>
            </div>
          </div>
          <div class="col-lg-6" data-aos="zoom-out" data-aos-delay="200">
            <img src="https://images.unsplash.com/photo-1552664730-d307ca884978?w=800&h=600&fit=crop&q=80" class="img-fluid rounded shadow-lg" alt="Team Collaboration">
          </div>
        </div>
      </div>
    </section>

    <!-- About -->
    <section id="about" class="about" style="padding: 80px 0; background: #fff;">
      <div class="container" data-aos="fade-up">
        <div class="row align-items-center">
          <div class="col-lg-6" data-aos="fade-up" data-aos-delay="200">
            <div style="background: var(--light-color); padding: 40px; border-radius: 10px;">
              <h3 style="color: var(--primary-color); text-transform: uppercase; font-size: 14px; font-weight: 700;">Who We Help</h3>
              <h2 style="color: var(--dark-color); font-size: 32px; font-weight: 700; margin: 15px 0;">Perfect for Junior PMs, Scrum Masters, and Distributed Teams</h2>
              <p>YodaAI serves as your intelligent co-facilitator, not a replacement. Whether you're new to retrospectives or managing multiple teams, we provide the structure and guidance you need.</p>
              <p><strong>Main Challenges We Solve:</strong></p>
              <ul>
                <li>New to retrospectives and unsure how to conduct them</li>
                <li>Keeping retrospectives organized despite disruptions</li>
                <li>Ensuring action items are tracked and completed</li>
                <li>Making retrospectives engaging for distributed teams</li>
              </ul>
            </div>
          </div>
          <div class="col-lg-6" data-aos="zoom-out" data-aos-delay="200">
            <img src="https://images.unsplash.com/photo-1531482615713-2afd69097998?w=600&h=450&fit=crop&q=80" class="img-fluid rounded shadow" alt="Agile Team">
          </div>
        </div>
      </div>
    </section>

    <!-- Values/How It Works -->
    <section id="values" class="values">
      <div class="container" data-aos="fade-up">
        <div class="section-header">
          <h2>How It Works</h2>
          <p>Your Complete Retrospective Journey</p>
        </div>

        <div class="row g-4">
          <div class="col-lg-4" data-aos="fade-up" data-aos-delay="200">
            <div class="box">
              <img src="https://images.unsplash.com/photo-1553877522-43269d4ea984?w=300&h=200&fit=crop&q=80" class="img-fluid rounded mb-3" alt="Pre-Retrospective">
              <h3>Pre-Retrospective Prep</h3>
              <p>One week before: AI sends team prep prompts, reviews past action items, and generates a draft agenda from sprint data</p>
            </div>
          </div>

          <div class="col-lg-4" data-aos="fade-up" data-aos-delay="400">
            <div class="box">
              <img src="https://images.unsplash.com/photo-1531482615713-2afd69097998?w=300&h=200&fit=crop&q=80" class="img-fluid rounded mb-3" alt="During Retrospective">
              <h3>AI-Guided Discussion</h3>
              <p>During retro: AI facilitates 4Ls conversation, identifies patterns, suggests talking points, and keeps time</p>
            </div>
          </div>

          <div class="col-lg-4" data-aos="fade-up" data-aos-delay="600">
            <div class="box">
              <img src="https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=300&h=200&fit=crop&q=80" class="img-fluid rounded mb-3" alt="Post-Retrospective">
              <h3>Automated Follow-Up</h3>
              <p>After retro: Summary sent within 1 hour, action items tracked, weekly check-ins, and monthly trend reports</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Features -->
    <section id="features" class="features">
      <div class="container" data-aos="fade-up">
        <div class="section-header">
          <h2>Features</h2>
          <p>Everything You Need for Successful Retrospectives</p>
        </div>

        <div class="row g-4">
          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="200">
            <div class="feature-box">
              <i class="bi bi-chat-dots"></i>
              <h3>4Ls Framework</h3>
              <p>Structured conversation through Liked, Learned, Lacked, and Longed For - proven methodology for effective retrospectives</p>
            </div>
          </div>

          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="300">
            <div class="feature-box">
              <i class="bi bi-robot"></i>
              <h3>AI Co-Facilitation</h3>
              <p>Intelligent prompts, pattern recognition, and real-time guidance based on PMI's Disciplined Agile best practices</p>
            </div>
          </div>

          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="400">
            <div class="feature-box">
              <i class="bi bi-people"></i>
              <h3>Team Management</h3>
              <p>Role-based access for Scrum Masters, Product Owners, Developers, QA, and other team members</p>
            </div>
          </div>

          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="500">
            <div class="feature-box">
              <i class="bi bi-check2-square"></i>
              <h3>Action Item Tracking</h3>
              <p>AI-drafted action items with priority levels, owner assignments, deadlines, and automated follow-ups</p>
            </div>
          </div>

          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="600">
            <div class="feature-box">
              <i class="bi bi-graph-up"></i>
              <h3>Pattern Recognition</h3>
              <p>Surface similar patterns from past retrospectives and provide insights from your team's history</p>
            </div>
          </div>

          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="700">
            <div class="feature-box">
              <i class="bi bi-envelope"></i>
              <h3>Automated Summaries</h3>
              <p>Detailed summaries emailed within an hour, with personalized action item reminders and progress tracking</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Testimonials -->
    <section class="testimonials" style="padding: 80px 0; background: var(--light-color);">
      <div class="container" data-aos="fade-up">
        <div class="section-header">
          <h2>Testimonials</h2>
          <p>What Teams Say About YodaAI</p>
        </div>

        <div class="row">
          <div class="col-lg-6" data-aos="fade-up" data-aos-delay="200">
            <div class="testimonial-item">
              <div class="stars mb-2">
                <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
              </div>
              <p>"As a junior Scrum Master, I was intimidated by facilitating retrospectives. YodaAI gave me the confidence and structure I needed. The AI prompts kept the conversation flowing naturally."</p>
              <h3>Sarah Chen</h3>
              <h4>Scrum Master, TechCorp</h4>
            </div>
          </div>

          <div class="col-lg-6" data-aos="fade-up" data-aos-delay="400">
            <div class="testimonial-item">
              <div class="stars mb-2">
                <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
              </div>
              <p>"Managing 3 distributed teams meant retrospectives were time-consuming. YodaAI automated the prep work and follow-ups, saving us hours while improving action item completion rates."</p>
              <h3>Brian Richard</h3>
              <h4>Senior Project Manager, InnovateLabs</h4>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="cta">
      <div class="container" data-aos="zoom-out">
        <div class="row">
          <div class="col-lg-9 text-center text-lg-start">
            <h3>Ready to Transform Your Retrospectives?</h3>
            <p style="color: #fff;">Join teams who are conducting more productive, engaging, and action-oriented retrospectives with AI assistance.</p>
          </div>
          <div class="col-lg-3 text-center">
            <button class="cta-btn" onclick="showLoginModal()">Get Started Free</button>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal" onclick="if(event.target === this) closeLoginModal()">
    <div class="login-modal-content" onclick="event.stopPropagation()">
      <button class="close-modal" onclick="closeLoginModal()">&times;</button>
      
      <div class="text-center mb-4">
        <i class="bi bi-robot" style="font-size: 64px; color: var(--primary-color);"></i>
        <h2 class="mt-3">Welcome to YodaAI</h2>
        <p class="text-muted">Sign in to transform your retrospectives</p>
      </div>

      <form>
        <!-- Full Name Field (for registration) -->
        <div class="mb-3" id="fullNameField" style="display: none;">
          <label class="form-label">Full Name (First and Last)</label>
          <input type="text" class="form-control" id="loginFullName" placeholder="John Doe">
        </div>

        <div class="mb-3">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-control" id="loginEmail" placeholder="your@email.com">
        </div>

        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="Min. 6 characters">
        </div>

        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary btn-lg" id="signInBtn" onclick="signIn()">
            <i class="bi bi-box-arrow-in-right"></i> Sign In
          </button>
          <button type="button" class="btn btn-success btn-lg" id="signUpBtn" onclick="toggleSignUpMode()">
            <i class="bi bi-person-plus"></i> Sign Up
          </button>
          <div class="text-center my-2">
            <small class="text-muted">or continue with</small>
          </div>
          <button type="button" class="btn btn-outline-primary" id="googleSignInBtn" onclick="signInWithGoogle(event)">
            <i class="bi bi-google"></i> Sign in with Google
          </button>
          <button type="button" class="btn btn-link text-muted" onclick="demoLogin()">
            <i class="bi bi-play-circle"></i> Try Demo Mode
          </button>
        </div>
      </form>

      <div id="authError" class="alert alert-danger mt-3" style="display: none;"></div>
      <div id="authLoading" class="text-center mt-3" style="display: none;">
        <div class="spinner me-2"></div> Processing...
      </div>
    </div>
  </div>

  <!-- Profile Completion Overlay -->
  <div id="profileOverlay" class="profile-overlay" style="display: none;">
    <div class="profile-overlay-content">
      <div class="text-center mb-4">
        <i class="bi bi-person-circle" style="font-size: 64px; color: var(--primary-color);"></i>
        <h2 class="mt-3">Complete Your Profile</h2>
        <p class="text-muted">Please provide your country and company information</p>
      </div>

      <form id="profileForm">
        <div class="mb-3">
          <label class="form-label">Country <span class="text-danger">*</span></label>
          <div class="position-relative">
            <input type="text" class="form-control" id="countryInput" placeholder="Type to search country..." autocomplete="off" required>
            <div id="countryDropdown" class="country-dropdown" style="display: none;"></div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Company Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="companyInput" placeholder="Enter your company name" required>
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary btn-lg" id="saveProfileBtn">
            <i class="bi bi-check-circle"></i> Save Profile
          </button>
        </div>
      </form>

      <div id="profileError" class="alert alert-danger mt-3" style="display: none;"></div>
      <div id="profileLoading" class="text-center mt-3" style="display: none;">
        <div class="spinner me-2"></div> Saving...
      </div>
    </div>
  </div>

  <!-- ==================== APP CONTAINER ==================== -->
  <div id="appContainer" class="app-container">
    
    <!-- Header -->
    <header class="app-header">
      <div class="container-fluid d-flex align-items-center justify-content-between px-4">
        <div class="d-flex align-items-center">
          <button class="btn btn-link d-lg-none" onclick="toggleSidebar()">
            <i class="bi bi-list fs-4"></i>
          </button>
          <a href="#" class="logo d-flex align-items-center" onclick="showSection('dashboard')" style="text-decoration: none;">
            <i class="bi bi-robot" style="font-size: 32px; color: var(--primary-color); margin-right: 10px;"></i>
            <span style="font-size: 26px; font-weight: 700; color: var(--dark-color);">Yoda<span style="color: var(--primary-color);">AI</span></span>
          </a>
        </div>

        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; font-weight: 700;" id="userAvatar">U</div>
            <div class="ms-2 d-none d-md-block">
              <div class="fw-bold" id="userName" style="font-size: 14px;">User</div>
              <small class="text-muted" id="userEmail">user@example.com</small>
            </div>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showSection('dashboard')">
            <i class="bi bi-grid"></i><span>Dashboard</span>
          </a>
        </li>
        <!-- Onboarding and Workspace nav removed; onboarding will live inside a workspace -->
        <li class="nav-item">
          <a class="nav-link" href="/retrospective">
            <i class="bi bi-chat-dots"></i><span>Retrospectives</span>
          </a>
        </li>
        <!-- Teams nav removed per request -->
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('actionitems')">
            <i class="bi bi-check2-square"></i><span>Action Items</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('analytics')">
            <i class="bi bi-graph-up"></i><span>Analytics</span>
          </a>
        </li>
        <!-- Documents nav removed per request -->
      </ul>
    </aside>

    <!-- Main -->
    <main id="main" class="main">

      <!-- Dashboard -->
      <section id="dashboardSection" class="content-section active">
        <h1 class="mb-4">Dashboard</h1>

        <div class="card">
          <div class="card-body">
            <h5>Welcome back, <span id="welcomeName">User</span>!</h5>
            <p class="text-muted">Ready to conduct another insightful retrospective? Let's help your team reflect, learn, and improve together.</p>
          </div>
        </div>


        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Workspaces</h5>
              <button class="btn btn-info btn-sm" onclick="showCreateWorkspaceModal()">
                <i class="bi bi-plus-circle"></i> Create Workspace
              </button>
            </div>
            <div id="workspacesList">
              <p class="text-muted">No workspaces yet. Create your first workspace to get started!</p>
            </div>
          </div>
        </div>

        

        <div class="card mb-4">
          <div class="card-body">
            <h5>Recent Activity</h5>
            <div id="recentActivity">
              <p class="text-muted">No recent activity yet. Start your first retrospective to see updates here!</p>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <h5>Upcoming Retrospectives</h5>
            <div id="upcomingRetros">
              <p class="text-muted">No upcoming retrospectives. Create one to get started!</p>
            </div>
          </div>
        </div>

      </section>

      <!-- Retrospectives -->
      <section id="retrospectivesSection" class="content-section">
        <h1 class="mb-4">4Ls Retrospective</h1>
        
        <!-- Button to start retro -->
        <div id="retroStartSection" class="mb-4">
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="bi bi-rocket-takeoff display-1 text-primary mb-3"></i>
              <h3>Ready to Start a Retrospective?</h3>
              <p class="text-muted">Create a new retrospective to begin the 6-phase process</p>
              <button class="btn btn-primary btn-lg" onclick="showCreateRetroModal()">
                <i class="bi bi-plus-circle"></i> Create Retrospective
              </button>
            </div>
          </div>
        </div>

        <!-- 4Ls Chat Interface (hidden until retro starts) -->
        <div id="retroChatSection" style="display:none;">
          <div class="row">
            <!-- Chat Area (Full Width) -->
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-3">
                    <h5><i class="bi bi-robot"></i> YodaAI Assistant</h5>
                    <span class="badge bg-success">Active</span>
                  </div>

                  <div class="chat-messages" id="retroChatMessages" style="height: 400px; overflow-y: auto; margin-bottom: 15px; padding: 15px; background: #fafafa; border-radius: 8px;">
                    <div class="message ai">
                      <div class="message-avatar"><i class="bi bi-robot"></i></div>
                      <div class="message-content">
                        Hi! I'm YodaAI. Let's start with what you <strong>Liked</strong> about this sprint. What went well that you'd like to continue?
                      </div>
                    </div>
                  </div>

                  <div class="d-flex gap-2">
                    <input type="text" id="retroChatInput" class="form-control" placeholder="Type your response..." onkeypress="if(event.key==='Enter') sendRetroMessage()">
                    <button id="sendRetroBtn" class="btn btn-primary" onclick="sendRetroMessage()" style="min-width: 100px;">
                      <i class="bi bi-send-fill"></i> Send
                    </button>
                  </div>
                  
                  <!-- Finish Button -->
                  <div class="mt-3">
                    <button id="retroFinishButton" onclick="finishRetroAndProceed()" class="btn btn-success w-100">
                      <i class="bi bi-check-circle"></i> Finish & Proceed to Grouping
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Schedule -->
      <section id="scheduleSection" class="content-section">
        <h1 class="mb-4">Schedule Retrospective</h1>

        <div class="card">
          <div class="card-body">
            <h5>New Retrospective</h5>
            <form>
              <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="scheduleTitle" placeholder="Sprint 6 Retrospective">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Date & Time *</label>
                  <input type="datetime-local" class="form-control" id="scheduleDate">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Duration</label>
                  <select class="form-select" id="scheduleDuration">
                    <option value="30">30 min</option>
                    <option value="60" selected>60 min</option>
                    <option value="90">90 min</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Team *</label>
                <select class="form-select" id="scheduleTeam">
                  <option value="">Select team...</option>
                  <option value="1">Development Team</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="scheduleDescription" rows="3"></textarea>
              </div>
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6>Automated Reminders</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="reminder1Week" checked>
                    <label class="form-check-label">Send prep 1 week before</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="reminder24Hour" checked>
                    <label class="form-check-label">Remind 24 hours before</label>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-primary" onclick="scheduleRetro()">
                <i class="bi bi-calendar-check"></i> Schedule
              </button>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5>Upcoming Retrospectives</h5>
            <div id="scheduledList">
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No retrospectives scheduled yet.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Workspace Detail View -->
      <section id="workspaceDetailSection" class="content-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <button class="btn btn-outline-secondary btn-sm mb-2" onclick="exitWorkspace()">
              <i class="bi bi-arrow-left"></i> Back to Dashboard
            </button>
            <h1 class="mb-0" id="workspaceDetailName">Workspace</h1>
            <p class="text-muted" id="workspaceDetailDesc"></p>
          </div>
          <div>
            <button class="btn btn-primary" onclick="showCreateRetroModal()">
              <i class="bi bi-plus-circle"></i> Create Retrospective
            </button>
          </div>
        </div>

        <!-- Workspace Tabs -->
        <ul class="nav nav-tabs mb-4" id="workspaceTabs">
          <li class="nav-item">
            <a class="nav-link active" href="#" onclick="showWorkspaceTab('onboarding'); return false;">
              <i class="bi bi-rocket-takeoff"></i> Getting Started
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showWorkspaceTab('retrospectives'); return false;">
              <i class="bi bi-chat-dots"></i> Retrospectives
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showWorkspaceTab('action-items'); return false;">
              <i class="bi bi-check2-square"></i> Action Items
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showWorkspaceTab('team'); return false;">
              <i class="bi bi-people"></i> Team Members
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showWorkspaceTab('summary'); return false;">
              <i class="bi bi-file-text"></i> Summary
            </a>
          </li>
        </ul>

        <!-- Workspace Tab Content -->
        <div id="workspaceTabContent">
          
          <!-- Onboarding Tab -->
          <div id="workspace-onboarding-tab" class="workspace-tab active">
            <h3 class="mb-4">Welcome! Let's Get Started</h3>

            <div class="card">
              <div class="card-body">
                <h5>Setup Progress</h5>
                <div class="progress mb-4" style="height: 20px;">
                  <div class="progress-bar" id="workspaceProgressBar" style="width: 0%">
                    <span id="workspaceOnboardingProgress">0%</span>
                  </div>
                </div>

            <div id="onboardingSteps">
              <div class="onboarding-step" data-step="1">
                    <div class="card border-start border-primary border-4">
                      <div class="card-body">
                        <h6><i class="bi bi-1-circle-fill text-primary"></i> Workspace Setup</h6>
                        <p class="text-muted small">Workspace created successfully!</p>
                        <button class="btn btn-sm btn-success" disabled>
                          <i class="bi bi-check-lg"></i> Completed
                        </button>
                      </div>
                    </div>
                  </div>

              <div class="onboarding-step" data-step="2">
                    <div class="card border-start border-success border-4">
                      <div class="card-body">
                    <h6><i class="bi bi-2-circle-fill text-success"></i> Generate AI Summary</h6>
                    <p class="text-muted small">Upload a file (.txt, .md, .pdf) and generate an AI summary</p>
                    <div class="row g-2 align-items-center mb-2">
                      <div class="col-12 col-md-8">
                        <input type="file" class="form-control form-control-sm" id="summaryUploadInput" accept=".txt,.md,.pdf">
                          </div>
                      <div class="col-12 col-md-4 d-flex gap-2">
                        <button id="generateSummaryBtn" class="btn btn-sm btn-info" onclick="generateDocumentSummary()">
                          <i class="bi bi-cpu"></i> Generate AI Summary
                          </button>
                      </div>
                    </div>
                    <div id="workspaceDocumentStatus">
                        </div>
                        <div id="uploadedDocsList" class="mt-3"></div>
                        <div id="docSummary" class="mt-3" style="display:none;">
                          <div class="alert alert-info">
                            <strong>AI Summary:</strong>
                            <p class="mb-0 mt-2" id="docSummaryText"></p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

              <div class="onboarding-step" data-step="3">
                    <div class="card border-start border-warning border-4">
                      <div class="card-body">
                        <h6><i class="bi bi-3-circle-fill text-warning"></i> Add Team Members</h6>
                        <p class="text-muted small">Invite team to workspace</p>
                        <button class="btn btn-sm btn-warning" onclick="showWorkspaceTab('team')">
                          <i class="bi bi-person-plus"></i> Add Members
                        </button>
                      </div>
                    </div>
                  </div>

              <div class="onboarding-step" data-step="4">
                    <div class="card border-start border-danger border-4">
                      <div class="card-body">
                    <h6><i class="bi bi-4-circle-fill text-danger"></i> Create First Retrospective</h6>
                        <p class="text-muted small">Start your first retro session</p>
                        <button class="btn btn-sm btn-danger" onclick="showCreateRetroModal()">
                          <i class="bi bi-plus-circle"></i> Create Retro
                        </button>
                  </div>
                      </div>
                    </div>
                  </div>

            <div class="mt-4 p-3 bg-light rounded border-start border-primary border-4">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-info-circle text-primary me-2" style="font-size: 1.2rem;"></i>
                <strong class="text-primary">Ready to continue?</strong>
                </div>
              <p class="mb-2 text-muted small" id="onboardingHint">Click the <strong>"Next"</strong> button below to proceed to the next step in your setup.</p>
              <p class="mb-0 text-muted small" id="onboardingStepInfo"><span id="currentStepNum">1</span> of <span id="totalStepsNum">4</span> steps</p>
            </div>

            <div class="d-flex justify-content-between mt-3 align-items-center">
              <button class="btn btn-outline-secondary" id="onboardingPrevBtn" onclick="prevWorkspaceWizardStep()">
                <i class="bi bi-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary btn-lg px-4" id="onboardingNextBtn" onclick="nextWorkspaceWizardStep()" style="box-shadow: 0 2px 8px rgba(0,123,255,0.3);">
                <span id="nextButtonText">Next</span> <i class="bi bi-arrow-right ms-1"></i>
              </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Retrospectives Tab -->
          <div id="workspace-retrospectives-tab" class="workspace-tab">
            <h3 class="mb-4">Retrospectives</h3>
            <div class="card">
              <div class="card-body text-center py-5">
                <i class="bi bi-rocket-takeoff display-1 text-primary mb-3"></i>
                <h4>Ready to Start a Retrospective?</h4>
                <p class="text-muted">Create a new retrospective to begin the 4Ls process</p>
                <button class="btn btn-primary btn-lg" onclick="showCreateRetroModal()">
                  <i class="bi bi-plus-circle"></i> Create Retrospective
                </button>
              </div>
            </div>
            <div id="workspaceRetrosList" class="mt-4"></div>
          </div>

          <!-- Action Items Tab -->
          <div id="workspace-action-items-tab" class="workspace-tab">
            <h3 class="mb-4">Action Items</h3>
            <button class="btn btn-primary mb-3" onclick="showCreateActionItemModal()">
              <i class="bi bi-plus-lg"></i> New Action Item
            </button>
            <div id="workspaceActionItemsList"></div>
          </div>

          <!-- Team Members Tab -->
          <div id="workspace-team-tab" class="workspace-tab">
            <h3 class="mb-4">Team Members</h3>
            <div class="card mb-4">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <i class="bi bi-person-plus-fill text-primary me-2" style="font-size: 1.5rem;"></i>
                  <h5 class="mb-0">Invite Team Members</h5>
                </div>
                <p class="text-muted small mb-3">Send an invitation to add a new member to your workspace. They'll receive an email with instructions to join.</p>
                
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label class="form-label">
                      <i class="bi bi-envelope me-1"></i> Email Address <span class="text-danger">*</span>
                    </label>
                    <input type="email" class="form-control" id="inviteEmail" placeholder="team.member@example.com" oninput="validateInviteEmail(this.value)">
                    <div id="inviteEmailFeedback" class="form-text mt-1" style="min-height: 20px;"></div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">
                      <i class="bi bi-person-badge me-1"></i> Role <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="inviteRole">
                      <option value="Scrum Master">Scrum Master</option>
                      <option value="Project Manager">Project Manager</option>
                      <option value="Product Owner">Product Owner</option>
                      <option value="Developer" selected>Developer</option>
                      <option value="QA">QA</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary btn-lg w-100" id="inviteBtn" onclick="inviteTeamMember()" disabled style="box-shadow: 0 2px 8px rgba(0,123,255,0.3);">
                      <i class="bi bi-send-fill me-1"></i> <span id="inviteBtnText">Send Invite</span>
                    </button>
                  </div>
                </div>
                
                <div class="alert alert-info mb-0 mt-3" style="background-color: #e7f3ff; border-color: #b3d9ff;">
                  <i class="bi bi-info-circle-fill me-2"></i>
                  <small>The invitee will receive an email notification with a link to accept the invitation and join your workspace.</small>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-body">
                <h5>Current Members</h5>
                <div id="workspaceTeamList"></div>
              </div>
            </div>
          </div>

          <!-- Summary Tab -->
          <div id="workspace-summary-tab" class="workspace-tab">
            <h3 class="mb-4">Workspace Summary</h3>
            <div class="card">
              <div class="card-body">
                <div id="workspaceSummaryContainer">
                  <p class="text-muted">Loading summary...</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Teams -->
      <section id="teamsSection" class="content-section">
        <h1 class="mb-4">Team Management</h1>

        <div class="card">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">Team Members</h5>
              <small class="text-muted">Add existing users to this workspace</small>
            </div>
            <button type="button" class="btn btn-primary" onclick="showAddMemberModal()">
              <i class="bi bi-person-plus"></i> Add Member
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5>Team Members <span id="teamCount" class="text-muted"></span></h5>
            <div class="team-grid" id="teamGrid"></div>
          </div>
        </div>
      </section>

      <!-- Action Items -->
      <section id="actionitemsSection" class="content-section">
        <h1 class="mb-4">Action Items</h1>

        <div class="d-flex justify-content-between mb-3">
          <button class="btn btn-primary" onclick="showCreateActionItemModal()">
            <i class="bi bi-plus-lg"></i> New Action Item
          </button>
        </div>

        <!-- Filter Tabs -->
        <ul class="nav nav-tabs mb-3" id="actionItemTabs">
          <li class="nav-item">
            <a class="nav-link active" href="#" onclick="filterActionItems('all'); return false;">All</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="filterActionItems('pending'); return false;">Pending</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="filterActionItems('in_progress'); return false;">In Progress</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="filterActionItems('completed'); return false;">Completed</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="filterActionItems('cancelled'); return false;">Cancelled</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="filterActionItems('blocked'); return false;">Blocked</a>
          </li>
        </ul>

        <!-- Action Items List -->
        <div id="actionItemsList" class="mb-4">
          <div class="text-center py-5">
            <i class="bi bi-hourglass-split text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3">Loading action items...</p>
          </div>
        </div>
      </section>

      <!-- Create/Edit Action Item Modal -->
      <div class="modal fade" id="actionItemModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="actionItemModalTitle">Create Action Item</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="actionItemForm">
                <input type="hidden" id="actionItemId">
                <input type="hidden" id="actionItemRetrospectiveId">
                <input type="hidden" id="actionItemWorkspaceId">
                <input type="hidden" id="actionItemDiscussionTopicId">
                
                <div class="mb-3">
                  <label class="form-label">Title *</label>
                  <input type="text" class="form-control" id="actionItemTitle" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="actionItemDescription" rows="3"></textarea>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="actionItemPriority">
                      <option value="low">Low</option>
                      <option value="medium" selected>Medium</option>
                      <option value="high">High</option>
                      <option value="critical">Critical</option>
                    </select>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="actionItemStatus">
                      <option value="pending">Pending</option>
                      <option value="in_progress">In Progress</option>
                      <option value="completed">Completed</option>
                      <option value="cancelled">Cancelled</option>
                      <option value="blocked">Blocked</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="actionItemDueDate">
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label">Assigned To</label>
                    <select class="form-select" id="actionItemAssignedTo">
                      <option value="">Unassigned</option>
                      <option value="0">Assignee list loading...</option>
                    </select>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Progress</label>
                  <div class="d-flex align-items-center">
                    <input type="range" class="form-range me-3" id="actionItemProgress" min="0" max="100" value="0" oninput="updateProgressDisplay(this.value)">
                    <span class="badge bg-primary" id="progressDisplay" style="min-width: 50px;">0%</span>
                  </div>
                  <small class="text-muted">Track completion progress from 0% to 100%</small>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="saveActionItem()">Save</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Invitation Acceptance Modal -->
      <div class="modal fade" id="invitationModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">
                <i class="bi bi-envelope-check"></i> Workspace Invitation
              </h5>
            </div>
            <div class="modal-body text-center py-4">
              <div class="mb-4">
                <i class="bi bi-envelope-heart" style="font-size: 4rem; color: #667eea;"></i>
              </div>
              <h4 id="invitationModalMessage">You've been invited!</h4>
              <p class="text-muted mt-3" id="invitationModalDetails">
                Loading invitation details...
              </p>
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" class="btn btn-outline-secondary" onclick="declineInvitationFromModal()">
                <i class="bi bi-x-circle"></i> Decline
              </button>
              <button type="button" class="btn btn-success btn-lg px-5" onclick="acceptInvitationFromModal()" id="acceptInviteBtn">
                <i class="bi bi-check-circle"></i> Accept & Join
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Invitation Success Modal -->
      <div class="modal fade" id="invitationSuccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">
                <i class="bi bi-check-circle"></i> Welcome to the Team!
              </h5>
            </div>
            <div class="modal-body text-center py-4">
              <div class="mb-4">
                <i class="bi bi-rocket-takeoff" style="font-size: 4rem; color: #28a745;"></i>
              </div>
              <h4 id="invitationSuccessMessage">Invitation Accepted!</h4>
              <p class="text-muted mt-3" id="invitationSuccessDetails">
                You're now a member of the workspace.
              </p>
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" class="btn btn-primary btn-lg px-5" onclick="goToDashboardFromInvitation()">
                <i class="bi bi-speedometer2"></i> Go to Dashboard
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analytics -->
      <section id="analyticsSection" class="content-section">
        <h1 class="mb-4" id="analyticsTitle">Analytics & Insights</h1>

        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h3 class="text-primary" id="totalRetros">0</h3>
                <p class="text-muted mb-0">Total Retros</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h3 class="text-success" id="activeRetros">0</h3>
                <p class="text-muted mb-0">Active</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h3 class="text-warning" id="completedActions">0</h3>
                <p class="text-muted mb-0">Completed</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h3 class="text-info" id="engagement">0%</h3>
                <p class="text-muted mb-0">Engagement</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5>AI Insights</h5>
            <div id="aiInsights">
              <p class="text-muted">Complete retrospectives to see AI-powered insights and patterns.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Documents -->
      <section id="documentsSection" class="content-section">
        <h1 class="mb-4">Document Analysis</h1>

        <div class="card">
          <div class="card-body">
            <div class="text-center py-5 border-2 border-dashed rounded" onclick="document.getElementById('docFileInput').click()" style="border-style: dashed; cursor: pointer;">
              <i class="bi bi-cloud-upload display-1 text-primary"></i>
              <h5 class="mt-3">Drop files or click to browse</h5>
              <p class="text-muted">PDF, DOC, DOCX</p>
              <input type="file" id="docFileInput" style="display: none;" accept=".pdf,.doc,.docx" onchange="handleDocUpload(event)">
            </div>

            <div id="docInfo" class="mt-4" style="display: none;">
              <div class="alert alert-success d-flex justify-content-between">
                <div>
                  <strong id="docFileName"></strong><br>
                  <small id="docFileSize"></small>
                </div>
                <button class="btn btn-primary" onclick="analyzeDoc()">
                  <i class="bi bi-cpu"></i> Analyze
                </button>
              </div>
            </div>

            <div id="docAnalysis" class="mt-4" style="display: none;"></div>
          </div>
        </div>
      </section>

    </main>

  </div>

  <!-- Vendor JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    // Initialize AOS animations
    AOS.init({
      duration: 1000,
      easing: "ease-in-out",
      once: true,
      mirror: false
    });

    // Global variables
    let currentUser = null;
    let currentStep = 'liked';
    let chatHistory = [];
    let teamMembers = [];
    let onboardingProgress = 0;
    let awaitingResponse = false;
    let authToken = null;
    
    // NEW: Workspace & Retrospective State
    let currentWorkspace = null;
    let userWorkspaces = [];
    let currentRetrospective = null;
    let currentChatSession = null;
    let progressData = {
      liked: false,
      learned: false,
      lacked: false,
      longed_for: false
    };

    // ==================== FIREBASE INITIALIZATION ====================
    // Initialize Firebase with actual configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD6xgrttBIm9vw07xRltKsqHZNpS1jJ8xw",
      authDomain: "taistat-f0e1d.firebaseapp.com",
      projectId: "taistat-f0e1d",
      storageBucket: "taistat-f0e1d.firebasestorage.app",
      messagingSenderId: "196742294604",
      appId: "1:196742294604:web:4cfbff121b69ddbdb898e9"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // ==================== INACTIVITY TRACKING ====================
    let inactivityTimer = null;
    let inactivityCheckInterval = null;
    const INACTIVITY_TIMEOUT = 60 * 60 * 1000; // 1 hour in milliseconds
    
    function resetInactivityTimer() {
      // Update last activity timestamp
      localStorage.setItem('yodaai_last_activity', Date.now().toString());
    }
    
    function checkInactivity() {
      const lastActivity = localStorage.getItem('yodaai_last_activity');
      if (!lastActivity) {
        resetInactivityTimer();
        return;
      }
      
      const timeSinceActivity = Date.now() - parseInt(lastActivity);
      
      if (timeSinceActivity >= INACTIVITY_TIMEOUT) {
        // User has been inactive for 1 hour, log them out (logout will clear cache)
        console.log('User inactive for 1 hour, logging out and clearing cache...');
        logout();
      }
    }
    
    function startInactivityTracking() {
      // Reset timer on any user activity
      const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
      
      activityEvents.forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
      });
      
      // Set initial activity timestamp
      resetInactivityTimer();
      
      // Check inactivity every minute
      if (inactivityCheckInterval) {
        clearInterval(inactivityCheckInterval);
      }
      inactivityCheckInterval = setInterval(checkInactivity, 60 * 1000); // Check every minute
    }
    
    function stopInactivityTracking() {
      if (inactivityCheckInterval) {
        clearInterval(inactivityCheckInterval);
        inactivityCheckInterval = null;
      }
      
      // Remove event listeners
      const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
      activityEvents.forEach(event => {
        document.removeEventListener(event, resetInactivityTimer, true);
      });
    }

    // ==================== CACHE CLEARING ====================
    function clearAllCache() {
      // Clear all YodaAI-related localStorage items
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('yodaai_')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // Also clear any pending session/retro IDs
      localStorage.removeItem('pending_session_id');
      localStorage.removeItem('pending_retro_id');
      
      // Clear user data in memory
      currentUser = null;
      authToken = null;
      teamMembers = [];
      chatHistory = [];
      onboardingProgress = 0;
    }

    // ==================== TAB CLOSE HANDLER ====================
    // Clear cache when tab is closed
    window.addEventListener('beforeunload', function() {
      // Clear all cache when tab closes
      clearAllCache();
    });

    // Also handle page visibility change (when tab becomes hidden)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // Tab is now hidden - could be closing or switching tabs
        // We'll clear cache on beforeunload, but this is a backup
      }
    });

    // ==================== CHECK LOGIN ON LOAD ====================
    document.addEventListener('DOMContentLoaded', function() {
      // Handle Google sign-in redirect result if user was redirected
      handleGoogleSignInRedirect();
      const savedUser = localStorage.getItem('yodaai_user');
      const savedToken = localStorage.getItem('yodaai_token');
      
      if (savedUser && savedToken) {
        currentUser = JSON.parse(savedUser);
        authToken = savedToken;
        showApp();
        
        // Check for session_id in URL parameters
        handleUrlSessionId();
        
        // Start inactivity tracking for logged-in users
        startInactivityTracking();
      }
    });

    // ==================== URL PARAMETER HANDLING ====================
    function handleUrlSessionId() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session_id');
      const retroId = urlParams.get('retro_id');
      
      if (sessionId) {
        console.log('Session ID found in URL:', sessionId);
        // Store session ID for after login
        localStorage.setItem('pending_session_id', sessionId);
        
        if (currentUser && authToken) {
          // User is logged in, start the session
          startChatWithSessionId(sessionId);
        } else {
          // User not logged in, show login prompt
          showNotification('Please log in to access your retrospective chat session.', 'info');
          showLoginModal();
        }
      }
      
      if (retroId) {
        console.log('Retrospective ID found in URL:', retroId);
        // Store retrospective ID for after login
        localStorage.setItem('pending_retro_id', retroId);
        
        if (currentUser && authToken) {
          // User is logged in, load the retrospective
          loadRetrospectiveById(parseInt(retroId));
        } else {
          // User not logged in, show login prompt
          showNotification('Please log in to access your retrospective.', 'info');
          showLoginModal();
        }
      }
    }

    // Check for pending session after login
    function checkPendingSession() {
      const pendingSessionId = localStorage.getItem('pending_session_id');
      const pendingRetroId = localStorage.getItem('pending_retro_id');
      
      if (pendingSessionId && currentUser && authToken) {
        localStorage.removeItem('pending_session_id');
        startChatWithSessionId(pendingSessionId);
      }
      
      if (pendingRetroId && currentUser && authToken) {
        localStorage.removeItem('pending_retro_id');
        loadRetrospectiveById(parseInt(pendingRetroId));
      }
    }

    async function loadRetrospectiveById(retroId) {
      try {
        const response = await fetch(`/api/v1/retrospectives/${retroId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const retrospective = await response.json();
          console.log('Retrospective loaded:', retrospective);
          
          // Show the retrospective details
          showRetrospectiveDetails(retrospective);
          showNotification('Retrospective loaded successfully!', 'success');
        } else {
          console.error('Failed to load retrospective:', response.statusText);
          showNotification('Failed to load retrospective. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error loading retrospective:', error);
        showNotification('Error loading retrospective. Please try again.', 'error');
      }
    }

    function showRetrospectiveDetails(retrospective) {
      // Show the retrospectives section and display the retrospective
      showSection('retrospectives');
      
      // You can add specific logic here to highlight or focus on the specific retrospective
      console.log('Showing retrospective:', retrospective.title);
    }

    async function startChatWithSessionId(sessionId) {
      try {
        // First, get the session details
        const response = await fetch(`/api/v1/fourls-chat/${sessionId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (response.ok) {
          const sessionData = await response.json();
          console.log('Session data:', sessionData);
          
          // Set the current session
          currentChatSession = sessionId;
          
          // Show the chat interface
          showChatInterface();
          
          // Load the chat messages
          loadChatMessages();
          
          // Show success message
          showNotification('Chat session loaded successfully!', 'success');
        } else {
          console.error('Failed to load session:', response.statusText);
          showNotification('Failed to load chat session. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error loading session:', error);
        showNotification('Error loading chat session. Please try again.', 'error');
      }
    }

    // ==================== AUTHENTICATION ====================
    
    function showLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
      document.getElementById('authError').style.display = 'none';
      
      // Reset form fields
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginFullName').value = '';
      
      // Reset to sign in mode
      document.getElementById('fullNameField').style.display = 'none';
      document.getElementById('signInBtn').style.display = 'block';
      document.getElementById('signUpBtn').textContent = 'Sign Up';
    }

    async function signIn() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showAuthError('Please enter both email and password');
        return;
      }

      showAuthLoading(true);

      try {
        // Use database authentication
        const response = await fetch('/api/v1/user-auth/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email, password})
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Login failed');
        }

        const data = await response.json();
        
        currentUser = {
          uid: data.user.id,
          id: data.user.id,
          email: data.user.email,
          displayName: data.user.full_name || data.user.username,
          username: data.user.username
        };
        
        authToken = data.access_token;

        // Store in localStorage
        localStorage.setItem('yodaai_user', JSON.stringify(currentUser));
        localStorage.setItem('yodaai_token', authToken);
        
        console.log('Sign in successful:', currentUser.email);
        showApp();
        startInactivityTracking(); // Start tracking inactivity
        checkPendingSession();
      } catch (error) {
        console.error('Sign in error:', error);
        showAuthError(error.message || 'Invalid email or password. Try signing up or use demo mode.');
      } finally {
        showAuthLoading(false);
      }
    }

    // Toggle between sign-in and sign-up modes
    let isSignUpMode = false;
    
    function toggleSignUpMode() {
      isSignUpMode = !isSignUpMode;
      const fullNameField = document.getElementById('fullNameField');
      const signUpBtn = document.getElementById('signUpBtn');
      const signInBtn = document.getElementById('signInBtn');
      
      if (isSignUpMode) {
        fullNameField.style.display = 'block';
        signUpBtn.innerHTML = '<i class="bi bi-check-circle"></i> Create Account';
        signUpBtn.onclick = signUp;
        signInBtn.innerHTML = '<i class="bi bi-arrow-left"></i> Back to Sign In';
        signInBtn.onclick = function() { toggleSignUpMode(); };
        signUpBtn.classList.remove('btn-success');
        signUpBtn.classList.add('btn-primary');
      } else {
        fullNameField.style.display = 'none';
        document.getElementById('loginFullName').value = '';
        signUpBtn.innerHTML = '<i class="bi bi-person-plus"></i> Sign Up';
        signUpBtn.onclick = toggleSignUpMode;
        signInBtn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Sign In';
        signInBtn.onclick = signIn;
        signUpBtn.classList.remove('btn-primary');
        signUpBtn.classList.add('btn-success');
      }
    }

    async function signUp() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const fullName = document.getElementById('loginFullName').value;

      if (!email || !password || !fullName) {
        showAuthError('Please enter your full name, email, and password');
        return;
      }

      if (fullName.trim().split(' ').length < 2) {
        showAuthError('Please enter both first and last name');
        return;
      }

      if (password.length < 6) {
        showAuthError('Password must be at least 6 characters long');
        return;
      }

      showAuthLoading(true);

      try {
        // Use database authentication
        const response = await fetch('/api/v1/user-auth/register', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            email,
            password,
            full_name: fullName.trim()
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Registration failed');
        }

        const data = await response.json();
        
        // Check if email verification is required
        // RegistrationResponse format: { message, email, requires_verification: true }
        if (data.requires_verification === true || (!data.access_token && !data.user && data.email)) {
          // Show success message with verification instructions
          const userEmail = data.email || email;
          showAuthError('Registration successful! Please check your email (' + userEmail + ') to verify your account. You can sign in after verification.', 'success');
          
          // Reset form and switch back to sign-in mode
          document.getElementById('loginEmail').value = '';
          document.getElementById('loginPassword').value = '';
          document.getElementById('loginFullName').value = '';
          
          // Switch back to sign-in mode
          if (isSignUpMode) {
            toggleSignUpMode();
          }
          
          return;
        }
        
        // If we have a token (for auto-verified accounts), proceed with login
        // TokenResponse format: { access_token, token_type, user: { id, email, username, ... } }
        if (data.access_token && data.user && data.user.id) {
          currentUser = {
            uid: data.user.id,
            id: data.user.id,
            email: data.user.email,
            displayName: data.user.full_name || data.user.username,
            username: data.user.username
          };
          
          authToken = data.access_token;

          // Store in localStorage
          localStorage.setItem('yodaai_user', JSON.stringify(currentUser));
          localStorage.setItem('yodaai_token', authToken);
          
          console.log('Sign up successful:', currentUser.email);
          showApp();
          startInactivityTracking(); // Start tracking inactivity
          checkPendingSession();
          
          // Show onboarding for new users
          setTimeout(() => {
            showSection('onboarding');
            showToast('Welcome! Let\'s get you set up.', 'success');
          }, 500);
        } else {
          // Fallback: if we don't have expected data structure, assume verification is needed
          console.warn('Unexpected registration response format:', data);
          showAuthError('Registration successful! Please check your email to verify your account. You can sign in after verification.', 'success');
          
          // Reset form and switch back to sign-in mode
          document.getElementById('loginEmail').value = '';
          document.getElementById('loginPassword').value = '';
          document.getElementById('loginFullName').value = '';
          
          if (isSignUpMode) {
            toggleSignUpMode();
          }
        }
      } catch (error) {
        console.error('Sign up error:', error);
        if (error.message.includes('already registered')) {
          showAuthError('This email is already registered. Please sign in instead.');
        } else {
          showAuthError(error.message || 'Sign up failed. Please try again.');
        }
      } finally {
        showAuthLoading(false);
      }
    }

    let isGoogleSignInInProgress = false;
    
    async function signInWithGoogle(event) {
      // Prevent multiple simultaneous sign-in attempts
      if (isGoogleSignInInProgress) {
        console.log('Google sign-in already in progress...');
        return;
      }
      
      // Prevent default and stop propagation to ensure clean event handling
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      isGoogleSignInInProgress = true;
      showAuthLoading(true);
      
      try {
        // Ensure Firebase is initialized
        if (!firebase.apps.length) {
          throw new Error('Firebase not initialized');
        }
        
        // 1. Sign in with Google using Firebase Auth
        // Create provider immediately (synchronously) within click handler
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        let result;
        try {
          // Try popup first - MUST be called synchronously within click handler
          // This is critical to avoid popup blockers - no async operations before this!
          result = await firebase.auth().signInWithPopup(provider);
        } catch (popupError) {
          // Handle popup-blocked error specifically
          if (popupError.code === 'auth/popup-blocked') {
            console.log('Popup blocked by browser');
            // Reset the flag so user can try again
            isGoogleSignInInProgress = false;
            showAuthLoading(false);
            showAuthError('Popup was blocked by your browser. Please allow popups for this site and click "Sign in with Google" again.', 'warning');
            return; // Exit early, let user try again
          } else if (popupError.code === 'auth/popup-closed-by-user') {
            console.log('User closed popup');
            // User closed the popup - just reset and let them try again
            isGoogleSignInInProgress = false;
            showAuthLoading(false);
            return; // Exit early, no error message needed
          } else {
            throw popupError;
          }
        }
        
        // 2. Get the ID token
        const idToken = await result.user.getIdToken();
        
        // 3. Send token to backend API
        const response = await fetch('/api/v1/user-auth/google', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id_token: idToken})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Google sign-in failed');
        }
        
        // 4. Get our app's JWT token
        const data = await response.json();
        
        currentUser = {
          uid: data.user.id,
          id: data.user.id,
          email: data.user.email,
          displayName: data.user.full_name,
          username: data.user.username,
          profilePicture: result.user.photoURL
        };
        
        authToken = data.access_token;
        
        // Store in localStorage
        localStorage.setItem('yodaai_user', JSON.stringify(currentUser));
        localStorage.setItem('yodaai_token', authToken);
        
        closeLoginModal();
        showApp();
        startInactivityTracking(); // Start tracking inactivity
        checkPendingSession();
        showToast('Successfully signed in with Google!', 'success');
        
      } catch (error) {
        console.error('Google sign-in error:', error);
        
        // Provide user-friendly error messages
        let errorMessage = 'Failed to sign in with Google. Please try again.';
        if (error.code === 'auth/popup-blocked') {
          errorMessage = 'Popup was blocked by your browser. Please allow popups for this site and try again.';
        } else if (error.code === 'auth/popup-closed-by-user') {
          errorMessage = 'Sign-in was cancelled. Please try again.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showAuthError(errorMessage);
      } finally {
        isGoogleSignInInProgress = false;
        showAuthLoading(false);
      }
    }
    
    // Handle redirect result when user returns from Google sign-in
    async function handleGoogleSignInRedirect() {
      try {
        const result = await firebase.auth().getRedirectResult();
        if (result.user) {
          // User signed in via redirect
          const idToken = await result.user.getIdToken();
          
          const response = await fetch('/api/v1/user-auth/google', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id_token: idToken})
          });
          
          if (response.ok) {
            const data = await response.json();
            currentUser = {
              uid: data.user.id,
              id: data.user.id,
              email: data.user.email,
              displayName: data.user.full_name,
              username: data.user.username,
              profilePicture: result.user.photoURL
            };
            
            authToken = data.access_token;
            localStorage.setItem('yodaai_user', JSON.stringify(currentUser));
            localStorage.setItem('yodaai_token', authToken);
            
            showApp();
            checkPendingSession();
            showToast('Successfully signed in with Google!', 'success');
          }
        }
      } catch (error) {
        console.error('Error handling redirect result:', error);
      }
    }

    async function demoLogin() {
      showAuthLoading(true);

      try {
        // Use demo login API
        const response = await fetch('/api/v1/user-auth/demo-login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });

        if (!response.ok) {
          throw new Error('Demo login failed');
        }

        const data = await response.json();
        
        currentUser = {
          uid: data.user.id,
          id: data.user.id,
          email: data.user.email,
          displayName: data.user.full_name || data.user.username,
          username: data.user.username,
          isDemo: true
        };
        
        authToken = data.access_token;

        // Store in localStorage
        localStorage.setItem('yodaai_user', JSON.stringify(currentUser));
        localStorage.setItem('yodaai_token', authToken);
        
        closeLoginModal();
        showApp();
        checkPendingSession();
        showToast('Welcome to Demo Mode! Explore all features.', 'info');
      } catch (error) {
        console.error('Demo login error:', error);
        showAuthError('Demo mode failed. Please try again.');
      } finally {
        showAuthLoading(false);
      }
    }

    function showAuthError(message, type = 'error') {
      const errorDiv = document.getElementById('authError');
      errorDiv.textContent = message;
      errorDiv.className = type === 'success' ? 'alert alert-success mt-3' : 'alert alert-danger mt-3';
      errorDiv.style.display = 'block';
    }

    function showAuthLoading(show) {
      document.getElementById('authLoading').style.display = show ? 'block' : 'none';
    }

    // ==================== PROFILE COMPLETION ====================
    const countries = [
      'Afghanistan', 'Albania', 'Algeria', 'Argentina', 'Australia', 'Austria', 'Bangladesh', 'Belgium', 'Brazil', 'Canada',
      'Chile', 'China', 'Colombia', 'Croatia', 'Czech Republic', 'Denmark', 'Egypt', 'Finland', 'France', 'Germany',
      'Ghana', 'Greece', 'Hungary', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy',
      'Japan', 'Kenya', 'Malaysia', 'Mexico', 'Morocco', 'Netherlands', 'New Zealand', 'Nigeria', 'Norway', 'Pakistan',
      'Philippines', 'Poland', 'Portugal', 'Romania', 'Russia', 'Saudi Arabia', 'Singapore', 'South Africa', 'South Korea', 'Spain',
      'Sweden', 'Switzerland', 'Thailand', 'Turkey', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Vietnam', 'Zimbabwe'
    ];

    let filteredCountries = [];
    let selectedCountryIndex = -1;

    function initCountryDropdown() {
      const countryInput = document.getElementById('countryInput');
      const countryDropdown = document.getElementById('countryDropdown');

      if (!countryInput || !countryDropdown) return;

      countryInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase().trim();
        filteredCountries = countries.filter(country => 
          country.toLowerCase().includes(query)
        );
        selectedCountryIndex = -1;
        renderCountryDropdown();
      });

      countryInput.addEventListener('focus', function() {
        if (this.value.trim()) {
          const query = this.value.toLowerCase().trim();
          filteredCountries = countries.filter(country => 
            country.toLowerCase().includes(query)
          );
        } else {
          filteredCountries = countries.slice(0, 10);
        }
        renderCountryDropdown();
      });

      countryInput.addEventListener('blur', function() {
        setTimeout(() => {
          countryDropdown.style.display = 'none';
        }, 200);
      });

      countryInput.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedCountryIndex = Math.min(selectedCountryIndex + 1, filteredCountries.length - 1);
          renderCountryDropdown();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedCountryIndex = Math.max(selectedCountryIndex - 1, -1);
          renderCountryDropdown();
        } else if (e.key === 'Enter' && selectedCountryIndex >= 0) {
          e.preventDefault();
          selectCountry(filteredCountries[selectedCountryIndex]);
        } else if (e.key === 'Escape') {
          countryDropdown.style.display = 'none';
        }
      });
    }

    function renderCountryDropdown() {
      const countryDropdown = document.getElementById('countryDropdown');
      if (!countryDropdown) return;

      if (filteredCountries.length === 0) {
        countryDropdown.style.display = 'none';
        return;
      }

      countryDropdown.innerHTML = filteredCountries.map((country, index) => {
        const isSelected = index === selectedCountryIndex ? 'selected' : '';
        return `<div class="country-dropdown-item ${isSelected}" data-country="${country}">${country}</div>`;
      }).join('');

      countryDropdown.style.display = 'block';

      countryDropdown.querySelectorAll('.country-dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
          selectCountry(this.dataset.country);
        });
      });
    }

    function selectCountry(country) {
      const countryInput = document.getElementById('countryInput');
      const countryDropdown = document.getElementById('countryDropdown');
      if (countryInput) {
        countryInput.value = country;
      }
      if (countryDropdown) {
        countryDropdown.style.display = 'none';
      }
      selectedCountryIndex = -1;
    }

    async function checkAndShowProfileForm() {
      if (!authToken) return false;

      try {
        const response = await fetch('/api/v1/users/me', {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) return false;

        const userData = await response.json();
        
        if (!userData.country_name || !userData.company_name) {
          showProfileOverlay();
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('Error checking user profile:', error);
        return false;
      }
    }

    function showProfileOverlay() {
      const overlay = document.getElementById('profileOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function hideProfileOverlay() {
      const overlay = document.getElementById('profileOverlay');
      if (overlay) {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    async function saveProfile() {
      const countryInput = document.getElementById('countryInput');
      const companyInput = document.getElementById('companyInput');
      const errorDiv = document.getElementById('profileError');
      const loadingDiv = document.getElementById('profileLoading');
      const saveBtn = document.getElementById('saveProfileBtn');

      if (!countryInput || !companyInput) return;

      const country = countryInput.value.trim();
      const company = companyInput.value.trim();

      if (!country || !company) {
        if (errorDiv) {
          errorDiv.textContent = 'Please fill in both country and company name';
          errorDiv.style.display = 'block';
        }
        return;
      }

      if (!countries.includes(country)) {
        if (errorDiv) {
          errorDiv.textContent = 'Please select a valid country from the list';
          errorDiv.style.display = 'block';
        }
        return;
      }

      if (errorDiv) errorDiv.style.display = 'none';
      if (loadingDiv) loadingDiv.style.display = 'block';
      if (saveBtn) saveBtn.disabled = true;

      try {
        const response = await fetch('/api/v1/users/me/profile', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            country_name: country,
            company_name: company
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to save profile');
        }

        hideProfileOverlay();
        // Show the app container after profile is saved
        const appContainer = document.getElementById('appContainer');
        if (appContainer) {
          appContainer.style.display = 'block';
        }
        // Reload dashboard data to ensure everything displays properly
        loadDashboardData();
        showToast('Profile updated successfully!', 'success');
        
      } catch (error) {
        console.error('Error saving profile:', error);
        if (errorDiv) {
          errorDiv.textContent = error.message || 'Failed to save profile. Please try again.';
          errorDiv.style.display = 'block';
        }
      } finally {
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (saveBtn) saveBtn.disabled = false;
      }
    }

    // Initialize profile form on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initCountryDropdown();
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
          profileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveProfile();
          });
        }
      });
    } else {
      initCountryDropdown();
      const profileForm = document.getElementById('profileForm');
      if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveProfile();
        });
      }
    }

    function showApp() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      closeLoginModal();
      updateUserInfo();
      loadDashboardData();
      checkAndLoadWorkspaces();
      handleInviteFromUrl();
      loadMyInvitationsBanner();
      
      // Check if profile needs completion
      setTimeout(async () => {
        const needsProfile = await checkAndShowProfileForm();
        if (needsProfile) {
          document.getElementById('appContainer').style.display = 'none';
        }
      }, 500);
    }

    function updateUserInfo() {
      if (!currentUser) return;
      
      const name = currentUser.displayName || currentUser.email.split('@')[0];
      document.getElementById('userName').textContent = name;
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('welcomeName').textContent = name;
    }

    async function logout() {
      // Stop inactivity tracking
      stopInactivityTracking();
      
      // Clear all cache
      clearAllCache();
      
      // Reload page
      window.location.reload();
    }

    // ==================== NAVIGATION ====================
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('show');
      
      // On mobile, add overlay and prevent body scroll when sidebar is open
      if (window.innerWidth <= 768) {
        if (sidebar.classList.contains('show')) {
          const overlay = document.createElement('div');
          overlay.id = 'sidebarOverlay';
          overlay.style.cssText = 'position: fixed; top: 60px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 997;';
          overlay.onclick = function() {
            toggleSidebar();
          };
          document.body.appendChild(overlay);
          document.body.style.overflow = 'hidden';
        } else {
          const overlay = document.getElementById('sidebarOverlay');
          if (overlay) {
            overlay.remove();
          }
          document.body.style.overflow = '';
        }
      }
    }

    function showSection(sectionName) {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionName + 'Section').classList.add('active');

      document.querySelectorAll('.sidebar-nav .nav-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
        if (link.getAttribute('onclick')?.includes(sectionName)) {
          link.classList.add('active');
        }
      });

      // Close sidebar on mobile after navigation
      if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar && sidebar.classList.contains('show')) {
          toggleSidebar();
        }
      }

      if (sectionName === 'analytics') {
        loadAnalytics();
      }
      if (sectionName === 'teams') {
        loadWorkspaceMembers();
      }
      if (sectionName === 'actionitems') {
        loadActionItems();
      }
    }

    // Global variable to store pending invitation token
    let pendingInvitationToken = null;
    let pendingInvitationWorkspace = null;

    async function handleInviteFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('invite');
      if (!token || !authToken) return;
      
      pendingInvitationToken = token;
      
      try {
        const statusResp = await fetch(`/api/v1/invitations/${encodeURIComponent(token)}`);
        if (!statusResp.ok) return;
        const status = await statusResp.json();
        
        if (status.status === 'expired') {
          showToast('Invitation has expired', 'danger');
          // Clean up URL
          window.history.replaceState({}, '', window.location.pathname);
          return;
        }
        
        // Fetch workspace details
        const workspaceResp = await fetch(`/api/v1/workspaces/${status.workspace_id}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        let workspaceName = `Workspace #${status.workspace_id}`;
        if (workspaceResp.ok) {
          const workspace = await workspaceResp.json();
          workspaceName = workspace.name;
          pendingInvitationWorkspace = workspace;
        }
        
        // Show beautiful modal
        const modalEl = document.getElementById('invitationModal');
        const messageEl = document.getElementById('invitationModalMessage');
        const detailsEl = document.getElementById('invitationModalDetails');
        
        if (modalEl && messageEl && detailsEl) {
          messageEl.textContent = 'You\'ve been invited!';
          detailsEl.innerHTML = `
            <strong>${escapeHtml(workspaceName)}</strong> is inviting you to join their workspace.
            <br><small class="text-muted">You'll be able to collaborate on retrospectives and team activities.</small>
          `;
          
          if (typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
          }
        }
      } catch (e) {
        console.error('Invitation error:', e);
        showToast('Unable to load invitation details', 'danger');
      }
    }
    
    async function acceptInvitationFromModal() {
      if (!pendingInvitationToken || !authToken) return;
      
      const btn = document.getElementById('acceptInviteBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Accepting...';
      }
      
      try {
        const resp = await fetch('/api/v1/invitations/accept', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: pendingInvitationToken })
        });
        
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || 'Failed to accept invitation');
        }
        
        // Close acceptance modal
        const invitationModal = document.getElementById('invitationModal');
        if (invitationModal && typeof bootstrap !== 'undefined') {
          bootstrap.Modal.getInstance(invitationModal).hide();
        }
        
        // Show success modal
        const successModal = document.getElementById('invitationSuccessModal');
        const successMessage = document.getElementById('invitationSuccessMessage');
        const successDetails = document.getElementById('invitationSuccessDetails');
        
        if (successModal && successMessage && successDetails && pendingInvitationWorkspace) {
          successDetails.innerHTML = `
            You're now a member of <strong>${escapeHtml(pendingInvitationWorkspace.name)}</strong>.
            <br><small class="text-muted">Check your dashboard to see recent activity and start collaborating!</small>
          `;
          
          if (typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(successModal);
            modal.show();
          }
        }
        
        // Reload workspaces and refresh dashboard
        await checkAndLoadWorkspaces();
        
        // Add activity to dashboard
        addWorkspaceActivityToDashboard(pendingInvitationWorkspace);
        
        // Clean up URL
        window.history.replaceState({}, '', window.location.pathname);
        
      } catch (e) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Accept & Join';
        }
        showToast(e.message || 'Failed to accept invitation', 'danger');
      }
    }
    
    async function declineInvitationFromModal() {
      if (!pendingInvitationToken) return;
      
      const invitationModal = document.getElementById('invitationModal');
      if (invitationModal && typeof bootstrap !== 'undefined') {
        bootstrap.Modal.getInstance(invitationModal).hide();
      }
      
      try {
        await fetch('/api/v1/invitations/decline', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: pendingInvitationToken })
        });
        showToast('Invitation declined', 'info');
      } catch (e) {
        console.error('Decline error:', e);
      }
      
      // Clean up
      window.history.replaceState({}, '', window.location.pathname);
      pendingInvitationToken = null;
      pendingInvitationWorkspace = null;
    }
    
    function goToDashboardFromInvitation() {
      const successModal = document.getElementById('invitationSuccessModal');
      if (successModal && typeof bootstrap !== 'undefined') {
        bootstrap.Modal.getInstance(successModal).hide();
      }
      showSection('dashboard');
      loadDashboardData();
      
      // Clean up
      pendingInvitationToken = null;
      pendingInvitationWorkspace = null;
    }
    
    function addWorkspaceActivityToDashboard(workspace) {
      if (!workspace) return;
      
      const activityContainer = document.getElementById('recentActivity');
      if (!activityContainer) return;
      
      const now = new Date();
      const timeStr = now.toLocaleString();
      
      // Check if "No activity" message exists
      if (activityContainer.querySelector('.text-muted')) {
        activityContainer.innerHTML = '';
      }
      
      // Prepend new activity
      const activityHTML = `
        <div class="d-flex align-items-start mb-3 p-3 bg-light rounded" style="animation: slideIn 0.3s ease-in;">
          <div class="flex-shrink-0 me-3">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
              <i class="bi bi-building"></i>
            </div>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div>
                <strong>Joined Workspace</strong>
                <span class="badge bg-success ms-2">New</span>
              </div>
              <small class="text-muted">${timeStr}</small>
            </div>
            <p class="text-muted mb-0">
              You joined <strong>${escapeHtml(workspace.name)}</strong>
            </p>
          </div>
        </div>
      `;
      
      activityContainer.insertAdjacentHTML('afterbegin', activityHTML);
    }

    async function loadMyInvitationsBanner() {
      if (!authToken) return;
      const banner = document.getElementById('invitesBanner');
      if (!banner) return;
      try {
        const resp = await fetch('/api/v1/invitations/mine', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!resp.ok) return;
        const invites = await resp.json();
        const pending = (invites || []).filter(i => i.status !== 'expired');
        if (pending.length === 0) { banner.innerHTML = ''; return; }
        const rows = pending.map(i => `
          <div class="alert alert-warning d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-envelope-open"></i>
              You have an invitation to join workspace ${i.workspace_id}.
              ${i.message ? `<span class="text-muted">Message: ${escapeHtml(i.message)}</span>` : ''}
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary" onclick="acceptInviteToken('${i.token}')">Accept</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="declineInviteToken('${i.token}')">Decline</button>
            </div>
          </div>
        `).join('');
        banner.innerHTML = rows;
      } catch (e) {
        // ignore
      }
    }

    async function acceptInviteToken(token) {
      if (!authToken) return;
      
      // Load invitation details and show modal
      pendingInvitationToken = token;
      
      try {
        const statusResp = await fetch(`/api/v1/invitations/${encodeURIComponent(token)}`);
        if (!statusResp.ok) {
          showToast('Invitation not found', 'danger');
          return;
        }
        const status = await statusResp.json();
        
        if (status.status === 'expired') {
          showToast('Invitation has expired', 'danger');
          return;
        }
        
        // Fetch workspace details
        const workspaceResp = await fetch(`/api/v1/workspaces/${status.workspace_id}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        let workspaceName = `Workspace #${status.workspace_id}`;
        if (workspaceResp.ok) {
          const workspace = await workspaceResp.json();
          workspaceName = workspace.name;
          pendingInvitationWorkspace = workspace;
        }
        
        // Show modal
        const modalEl = document.getElementById('invitationModal');
        const messageEl = document.getElementById('invitationModalMessage');
        const detailsEl = document.getElementById('invitationModalDetails');
        
        if (modalEl && messageEl && detailsEl) {
          messageEl.textContent = 'You\'ve been invited!';
          detailsEl.innerHTML = `
            <strong>${escapeHtml(workspaceName)}</strong> is inviting you to join their workspace.
            <br><small class="text-muted">You'll be able to collaborate on retrospectives and team activities.</small>
          `;
          
          if (typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
          }
        }
      } catch (e) {
        console.error('Invitation error:', e);
        showToast('Unable to load invitation details', 'danger');
      }
    }

    async function declineInviteToken(token) {
      if (!authToken) return;
      const resp = await fetch('/api/v1/invitations/decline', {
        method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      if (resp.ok) {
        showToast('Invitation declined', 'info');
        await loadMyInvitationsBanner();
      } else {
        const err = await resp.json().catch(() => ({}));
        showToast(err.detail || 'Failed to decline invitation', 'danger');
      }
    }

    // ==================== ONBOARDING ====================
    
    async function completeStep(step) {
      onboardingProgress += 16.67;
      updateProgress();
      
      showToast('Step completed!', 'success');
      
      // Call API with auth token
      if (authToken) {
        try {
          await fetch('/api/v1/onboarding/complete-step', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({step_name: step})
          });
        } catch (e) {
          console.log('API call (onboarding):', e);
        }
      }
    }

    function skipStep(step) {
      showToast('Step skipped', 'info');
    }

    function updateProgress() {
      const percentage = Math.min(Math.round(onboardingProgress), 100);
      document.getElementById('onboardingProgress').textContent = percentage + '%';
      document.getElementById('progressBar').style.width = percentage + '%';
    }

    // ==================== CHAT ====================
    
    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function focusStep(step) {
      currentStep = step;
      
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`[data-step="${step}"]`).classList.add('active');

      const stepMessages = {
        'liked': "Let's talk about what you <strong>Liked</strong>. What went well this sprint?",
        'learned': "What did you <strong>Learn</strong>? What new insights did you gain?",
        'lacked': "What <strong>Lacked</strong>? What challenges did you face?",
        'longed': "What do you <strong>Long For</strong>? What would you like to see improved?"
      };

      if (stepMessages[step]) {
        addMessageToChat(stepMessages[step], 'ai');
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message || awaitingResponse) return;

      addMessageToChat(message, 'user');
      input.value = '';
      chatHistory.push({role: 'user', content: message});
      awaitingResponse = true;

      // Call real AI API with streaming
      try {
        const response = await fetch('/api/v1/ai-chat/proxy/stream', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            message: message,
            current_step: currentStep,
            chat_history: chatHistory,
            workspace_id: currentWorkspace?.id || null
          })
        });

        if (response.ok && response.body) {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let aiMessage = '';
          let messageDiv = null;

          while (true) {
            const {value, done} = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n\n');

            for (const line of lines) {
              if (line.startsWith('data:')) {
                const data = line.replace('data:', '').trim();
                if (data && data !== '[DONE]') {
                  aiMessage += data;
                  
                  if (!messageDiv) {
                    messageDiv = addMessageToChat('', 'ai', true);
                  }
                  messageDiv.querySelector('.message-content').innerHTML = aiMessage;
                }
              }
            }
          }

          if (aiMessage) {
            chatHistory.push({role: 'assistant', content: aiMessage});
          }
        } else {
          const fallback = generateSimpleResponse();
          addMessageToChat(fallback, 'ai');
          chatHistory.push({role: 'assistant', content: fallback});
        }
      } catch (error) {
        console.error('Chat error:', error);
        const fallback = generateSimpleResponse();
        addMessageToChat(fallback, 'ai');
        chatHistory.push({role: 'assistant', content: fallback});
      } finally {
        awaitingResponse = false;
      }
    }

    function addMessageToChat(message, sender, returnDiv = false) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;

      const icon = sender === 'user' ? 
        '<i class="bi bi-person-circle"></i>' : 
        '<i class="bi bi-robot"></i>';

      messageDiv.innerHTML = `
        <div class="message-avatar">${icon}</div>
        <div class="message-content">${message}</div>
      `;

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (returnDiv) return messageDiv;
    }

    function generateSimpleResponse() {
      const responses = {
        'liked': [
          "That's wonderful! What specifically made this work well for the team?",
          "Excellent! Can you elaborate on what contributed to this success?",
          "Great! Are there any other things that went particularly well?"
        ],
        'learned': [
          "That's a valuable learning! How will this knowledge help in future sprints?",
          "Interesting insight! What triggered this discovery?",
          "Fantastic! Would you like to share this with the broader team?"
        ],
        'lacked': [
          "I understand this was challenging. What could have been done differently?",
          "Thank you for sharing. How did this impact the team's productivity?",
          "This is important feedback. What steps could prevent this from happening again?"
        ],
        'longed': [
          "That's a great vision for improvement! How do you think we could work towards this?",
          "Excellent suggestion! What would need to change to make this possible?",
          "I love that idea! What would be the first step towards achieving this?"
        ]
      };

      const stepResponses = responses[currentStep] || responses['liked'];
      return stepResponses[Math.floor(Math.random() * stepResponses.length)];
    }

    // ==================== TEAM MANAGEMENT ====================
    
    let verifyUserTimer = null;
    let verifiedUserCandidate = null;

    function showAddMemberModal() {
      if (!currentWorkspace) {
        showToast('Please select or create a workspace first', 'warning');
        return;
      }
      const modal = document.getElementById('addMemberModal') || createAddMemberModal();
      resetAddMemberModal();
      modal.style.display = 'flex';
    }

    function createAddMemberModal() {
      const modal = document.createElement('div');
      modal.id = 'addMemberModal';
      modal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;';
      modal.innerHTML = `
        <div style="background:white; padding:32px; border-radius:12px; max-width:560px; width:90%;">
          <h4 class="mb-3">Add Member to ${currentWorkspace ? currentWorkspace.name : 'Workspace'}</h4>
          <div class="mb-3">
            <label class="form-label">User Email *</label>
            <input type="email" class="form-control" id="addMemberEmail" placeholder="name@company.com" oninput="debouncedVerifyUser()">
            <div id="verifyStatus" class="form-text mt-1"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Workspace Role *</label>
            <select class="form-select" id="addMemberRole">
              <option value="member">Member</option>
              <option value="facilitator">Facilitator</option>
              <option value="owner">Owner</option>
            </select>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" onclick="closeAddMemberModal()">Cancel</button>
            <button id="confirmAddMemberBtn" class="btn btn-primary" onclick="confirmAddWorkspaceMember()" disabled>
              <i class="bi bi-person-plus"></i> Add to Workspace
            </button>
          </div>
          <div id="addMemberError" class="mt-2 text-danger" style="display:none;"></div>
        </div>
      `;
      modal.addEventListener('click', e => { if (e.target === modal) closeAddMemberModal(); });
      document.body.appendChild(modal);
      return modal;
    }

    function resetAddMemberModal() {
      const emailEl = document.getElementById('addMemberEmail');
      const statusEl = document.getElementById('verifyStatus');
      const errorEl = document.getElementById('addMemberError');
      const btn = document.getElementById('confirmAddMemberBtn');
      if (emailEl) emailEl.value = '';
      if (statusEl) statusEl.innerHTML = '';
      if (errorEl) { errorEl.style.display = 'none'; errorEl.textContent = ''; }
      if (btn) btn.disabled = true;
      verifiedUserCandidate = null;
    }

    function closeAddMemberModal() {
      const modal = document.getElementById('addMemberModal');
      if (modal) modal.style.display = 'none';
    }

    function debouncedVerifyUser() {
      clearTimeout(verifyUserTimer);
      verifyUserTimer = setTimeout(verifyUserByEmail, 400);
    }

    function isValidEmail(email) {
      return /.+@.+\..+/.test(email);
    }

    async function verifyUserByEmail() {
      const email = (document.getElementById('addMemberEmail')?.value || '').trim();
      const statusEl = document.getElementById('verifyStatus');
      const btn = document.getElementById('confirmAddMemberBtn');
      verifiedUserCandidate = null;
      if (!email || !isValidEmail(email)) {
        if (statusEl) statusEl.innerHTML = '<span class="text-muted">Enter a valid email to verify.</span>';
        if (btn) btn.disabled = true;
        return;
      }
      if (!authToken) {
        if (statusEl) statusEl.innerHTML = '<span class="text-danger">You are not authenticated.</span>';
        if (btn) btn.disabled = true;
        return;
      }
      try {
        if (statusEl) statusEl.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i> Verifying...</span>';
        const resp = await fetch(`/api/v1/users/lookup?email=${encodeURIComponent(email)}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (resp.status === 404) {
          if (statusEl) statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> No account found for this email.</span>';
          if (btn) btn.disabled = true;
          return;
        }
        if (!resp.ok) throw new Error('Verification failed');
        const user = await resp.json();
        verifiedUserCandidate = user;
        if (statusEl) statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Found: ${user.displayName || user.name || user.email}</span>`;
        if (btn) btn.disabled = false;
      } catch (e) {
        if (statusEl) statusEl.innerHTML = '<span class="text-danger">Could not verify right now. Try again.</span>';
        if (btn) btn.disabled = true;
      }
    }

    async function confirmAddWorkspaceMember() {
      const errorEl = document.getElementById('addMemberError');
      if (!currentWorkspace) {
        showToast('Please select or create a workspace first', 'warning');
        return;
      }
      if (!verifiedUserCandidate) {
        if (errorEl) { errorEl.style.display = 'block'; errorEl.textContent = 'Please verify a valid user email first.'; }
        return;
      }
      const role = document.getElementById('addMemberRole')?.value || 'member';
      const btn = document.getElementById('confirmAddMemberBtn');
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
        const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/invitations`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: verifiedUserCandidate.email, role })
        });
        if (resp.status === 409) {
          showToast('User is already a member of this workspace', 'info');
          closeAddMemberModal();
          return loadWorkspaceMembers();
        }
        if (resp.status === 403) {
          showToast('Only facilitators or owners can send invitations', 'danger');
          return;
        }
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || 'Failed to send invitation');
        }
        showToast('Invitation sent successfully', 'success');
        closeAddMemberModal();
        // Member list updates after acceptance
      } catch (e) {
        if (errorEl) { errorEl.style.display = 'block'; errorEl.textContent = e.message; }
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-person-plus"></i> Add to Workspace'; }
      }
    }

    async function loadWorkspaceMembers() {
      if (!currentWorkspace || !authToken) return;
      try {
        const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/members`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!resp.ok) throw new Error('Failed to load members');
        const members = await resp.json();
        renderTeamMembers(members);
      } catch (e) {
        console.error('Load members error:', e);
      }
    }

    function renderTeamMembers(members) {
      const grid = document.getElementById('teamGrid');
      const count = document.getElementById('teamCount');
      if (!grid) return;
      grid.innerHTML = '';
      (members || []).forEach(m => {
        const card = document.createElement('div');
        card.className = 'team-member-card';
        const name = m.display_name || m.name || m.email || 'User';
        const role = m.role || 'member';
        card.innerHTML = `
          <div class="member-avatar">${(name.charAt(0) || 'U').toUpperCase()}</div>
          <div class="fw-bold text-truncate" title="${name}">${name}</div>
          <div class="text-muted small text-truncate" title="${role}">${role}</div>
        `;
        grid.appendChild(card);
      });
      if (count) count.textContent = `(${members ? members.length : 0})`;
    }

    // ==================== SCHEDULE ====================
    
    async function scheduleRetro() {
      const title = document.getElementById('scheduleTitle').value;
      const date = document.getElementById('scheduleDate').value;
      const team = document.getElementById('scheduleTeam').value;

      if (!title || !date || !team) {
        showToast('Please fill in all required fields', 'danger');
        return;
      }

      // Save to backend with auth token
      if (authToken) {
        try {
          await fetch('/api/v1/scheduling/schedule', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              title,
              team_id: parseInt(team),
              scheduled_date: date,
              duration_minutes: parseInt(document.getElementById('scheduleDuration').value),
              send_1_week_reminder: document.getElementById('reminder1Week').checked,
              send_24_hour_reminder: document.getElementById('reminder24Hour').checked
            })
          });
        } catch (e) {
          console.log('Schedule API:', e);
        }
      }

      // Update UI
      document.getElementById('scheduledList').innerHTML = `
        <div class="alert alert-success">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${title}</strong><br>
              <small>${new Date(date).toLocaleString()}</small>
            </div>
            <span class="badge bg-success">Scheduled</span>
          </div>
        </div>
      `;

      showToast('Retrospective scheduled! Automated reminders will be sent.', 'success');
      completeStep('first_retrospective_scheduled');
    }

    // ==================== FILE ANALYSIS ====================
    
    async function analyzeFile() {
      const input = document.getElementById('actionFileInput');
      if (!input.files.length) {
        showToast('Please select a file first', 'warning');
        return;
      }

      const file = input.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('session_type', 'retrospective');
      formData.append('current_step', currentStep);

      document.getElementById('analysisStatus').innerHTML = '<div class="spinner me-2"></div> Analyzing with AI...';

      try {
        const response = await fetch('/api/v1/ai-chat/thematic-analysis', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          renderThemes(data.analysis);
          document.getElementById('analysisStatus').innerHTML = '<div class="alert alert-success">Analysis complete!</div>';
        } else {
          throw new Error('Analysis failed');
        }
      } catch (error) {
        console.error('Analysis error:', error);
        document.getElementById('analysisStatus').innerHTML = '<div class="alert alert-danger">Analysis failed. Please try again.</div>';
      }
    }

    function renderThemes(analysis) {
      const container = document.getElementById('groupedThemesContainer');
      
      if (!analysis.themes || analysis.themes.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No themes detected in the uploaded file.</div>';
        return;
      }

      let html = '<div class="row g-3">';
      analysis.themes.forEach((theme, i) => {
        html += `
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="text-primary">${escapeHtml(theme.theme || 'Theme ' + (i+1))}</h6>
                <ul class="list-group list-group-flush">
                  ${(theme.examples || []).slice(0, 10).map(ex => 
                    `<li class="list-group-item">${escapeHtml(ex)}</li>`
                  ).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function clearAnalysis() {
      document.getElementById('actionFileInput').value = '';
      document.getElementById('analysisStatus').innerHTML = '';
      document.getElementById('groupedThemesContainer').innerHTML = '';
    }

    // ==================== DOCUMENT UPLOAD ====================
    
    function handleDocUpload(event) {
      const file = event.target.files[0];
      if (file) {
        document.getElementById('docFileName').textContent = file.name;
        document.getElementById('docFileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        document.getElementById('docInfo').style.display = 'block';
        completeStep('project_data_imported');
      }
    }

    function analyzeDoc() {
      const docAnalysis = document.getElementById('docAnalysis');
      docAnalysis.style.display = 'block';
      docAnalysis.innerHTML = `
        <div class="card bg-light">
          <div class="card-body">
            <h6><i class="bi bi-cpu me-2"></i>AI Document Analysis</h6>
            <div class="alert alert-primary">
              <strong>Key Topics:</strong> Project planning, sprint goals, team coordination, technical requirements
            </div>
            <div class="alert alert-success">
              <strong>Success Factors:</strong> Clear objectives, regular check-ins, collaborative approach
            </div>
            <div class="alert alert-warning">
              <strong>Challenges:</strong> Resource allocation, timeline constraints, communication gaps
            </div>
            <div class="alert alert-info">
              <strong>Recommendations:</strong> Consider implementing daily standups and weekly planning sessions
            </div>
          </div>
        </div>
      `;
    }

    // ==================== DASHBOARD DATA ====================
    
    async function loadDashboardData() {
      if (!authToken) return;
      
      const headers = {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      };

      try {
        // Fetch retrospectives
        const retrosResponse = await fetch('/api/v1/retrospectives/', {headers}).catch(() => null);
        if (retrosResponse && retrosResponse.ok) {
          const retros = await retrosResponse.json();
          document.getElementById('totalRetros').textContent = retros.length || 0;
          
          if (retros.length > 0) {
            const active = retros.filter(r => r.status === 'active').length;
            document.getElementById('activeRetros').textContent = active;
          }
        }

        // Fetch dashboard retrospectives (upcoming, in_progress, completed)
        const dashboardResp = await fetch('/api/v1/retrospectives/user/dashboard', {headers}).catch(() => null);
        if (dashboardResp && dashboardResp.ok) {
          const dashboard = await dashboardResp.json();
          loadUpcomingRetros(dashboard.upcoming || []);
          // Setup collapsible sections after content renders
          setupDashboardCollapsibles();
        }

        // Fetch action items
        const actionsResponse = await fetch('/api/v1/action-items/', {headers}).catch(() => null);
        if (actionsResponse && actionsResponse.ok) {
          const actions = await actionsResponse.json();
          const completed = actions.filter(a => a.status === 'completed').length;
          document.getElementById('completedActions').textContent = completed;
          
          if (actions.length > 0) {
            const engagement = Math.round((completed / actions.length) * 100);
            document.getElementById('engagement').textContent = engagement + '%';
          }
        }
      } catch (error) {
        console.log('Dashboard load:', error);
      }
    }
    
    async function loadUpcomingRetros(retros) {
      const container = document.getElementById('upcomingRetros');
      if (!container) return;
      // Keep a map for later activity updates
      window._upcomingRetrosById = Object.create(null);
      
      if (!retros || retros.length === 0) {
        container.innerHTML = '<p class="text-muted">No upcoming retrospectives. Create one to get started!</p>';
        return;
      }
      
      container.innerHTML = retros.map(retro => {
        window._upcomingRetrosById[retro.id] = retro;
        const cardId = `retro-card-${retro.id}`;
        return `
          <div class="card mb-2 border-start border-4 border-info" id="${cardId}">
            <div class="card-body py-3">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    <i class="bi bi-calendar-event"></i> ${escapeHtml(retro.title)}
                  </h6>
                  ${retro.sprint_name ? `<small class="text-muted d-block mb-2">${escapeHtml(retro.sprint_name)}</small>` : ''}
                  <div class="d-flex gap-3 flex-wrap">
                    <div id="timer-${retro.id}">
                      <small class="text-muted">
                        <i class="bi bi-clock"></i> Loading...
                      </small>
                    </div>
                  </div>
                </div>
                <div id="action-${retro.id}">
                  <button class="btn btn-sm btn-secondary" disabled>
                    <i class="bi bi-lock"></i> Waiting
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Start countdown timers for each retrospective
      retros.forEach(retro => {
        const startDate = retro.scheduled_start_time ? new Date(retro.scheduled_start_time) : null;
        if (startDate) {
          startCountdown(retro.id, startDate);
        }
      });
    }
    
    function startCountdown(retroId, startDate) {
      const timerEl = document.getElementById(`timer-${retroId}`);
      const actionEl = document.getElementById(`action-${retroId}`);
      const cardEl = document.getElementById(`retro-card-${retroId}`);
      
      if (!timerEl || !actionEl) return;
      
      function updateCountdown() {
        const now = new Date();
        const diffMs = startDate - now;
        
        if (diffMs <= 0) {
          // Time has elapsed - show join button
          timerEl.innerHTML = `
            <small class="text-success">
              <i class="bi bi-check-circle"></i> Started
            </small>
          `;
          actionEl.innerHTML = `
            <button class="btn btn-sm btn-primary" onclick="openRetrospective(${retroId})">
              <i class="bi bi-play-circle"></i> Join Now
            </button>
          `;
          // Move from upcoming to recent activity
          try {
            const retro = window._upcomingRetrosById ? window._upcomingRetrosById[retroId] : null;
            if (retro) addRetrospectiveActivityToDashboard(retro, 'started');
            if (cardEl && cardEl.parentNode) cardEl.parentNode.removeChild(cardEl);
            // If no more cards, show placeholder text
            const container = document.getElementById('upcomingRetros');
            if (container && container.children.length === 0) {
              container.innerHTML = '<p class="text-muted">No upcoming retrospectives. Create one to get started!</p>';
            }
          } catch (e) { /* noop */ }
          return;
        }
        
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
        
        let timeStr = '';
        if (days > 0) {
          timeStr = `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
          timeStr = `${hours}h ${minutes}m ${seconds}s`;
        } else {
          timeStr = `${minutes}m ${seconds}s`;
        }
        
        timerEl.innerHTML = `
          <small class="text-info">
            <i class="bi bi-clock"></i> In ${timeStr}
          </small>
        `;
        
        // Schedule next update
        setTimeout(updateCountdown, 1000);
      }
      
      // Initial update
      updateCountdown();
    }

    // Add an item to Recent Activity when a retro starts
    function addRetrospectiveActivityToDashboard(retro, eventType = 'started') {
      const activityContainer = document.getElementById('recentActivity');
      if (!activityContainer) return;
      if (activityContainer.querySelector('.text-muted')) activityContainer.innerHTML = '';
      const nowStr = new Date().toLocaleString();
      const badge = eventType === 'started' ? 'primary' : 'secondary';
      const title = eventType === 'started' ? 'Retrospective Started' : 'Retrospective Update';
      const icon = 'bi-flag';
      const html = `
        <div class="d-flex align-items-start mb-3 p-3 bg-light rounded">
          <div class="flex-shrink-0 me-3">
            <div class="bg-${badge} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
              <i class="bi ${icon}"></i>
            </div>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div>
                <strong>${title}</strong>
                <span class="badge bg-${badge} ms-2">New</span>
              </div>
              <small class="text-muted">${nowStr}</small>
            </div>
            <p class="text-muted mb-0">
              ${escapeHtml(retro.title)}${retro.sprint_name ? `  <em>${escapeHtml(retro.sprint_name)}</em>` : ''}
            </p>
          </div>
        </div>
      `;
      activityContainer.insertAdjacentHTML('afterbegin', html);
    }

    // Collapsible sections for dashboard lists (Upcoming, Recent Activity)
    function setupDashboardCollapsibles() {
      const sections = [
        { titleSelector: '#dashboardSection h5:nth-of-type(1)', contentId: 'recentActivity', storageKey: 'dash_collapse_recent' },
        { titleSelector: '#dashboardSection h5:nth-of-type(2)', contentId: 'upcomingRetros', storageKey: 'dash_collapse_upcoming' }
      ];
      sections.forEach(({ titleSelector, contentId, storageKey }) => {
        const titleEl = document.querySelector(titleSelector);
        const contentEl = document.getElementById(contentId);
        if (!titleEl || !contentEl) return;
        if (titleEl.querySelector('.dash-collapse-btn')) return; // already added
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-secondary dash-collapse-btn ms-2';
        btn.innerHTML = '<i class="bi bi-chevron-up"></i>'; 
        const collapsed = localStorage.getItem(storageKey) === '1';
        if (collapsed) {
          contentEl.style.display = 'none';
          btn.innerHTML = '<i class="bi bi-chevron-down"></i>';
        }
        btn.addEventListener('click', () => {
          const isHidden = contentEl.style.display === 'none';
          contentEl.style.display = isHidden ? '' : 'none';
          btn.innerHTML = isHidden ? '<i class="bi bi-chevron-up"></i>' : '<i class="bi bi-chevron-down"></i>';
          localStorage.setItem(storageKey, isHidden ? '0' : '1');
        });
        titleEl.appendChild(btn);
      });
    }
    
    function getTimeUntil(date, now) {
      const diffMs = date - now;
      const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) return 'Started';
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Tomorrow';
      if (diffDays < 7) return `In ${diffDays} days`;
      if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return `In ${weeks} ${weeks === 1 ? 'week' : 'weeks'}`;
      }
      return date.toLocaleDateString();
    }
    
    async function openRetrospective(retroId) {
      try {
        showToast('Loading retrospective...', 'info');
        
        // Get retrospective to get the code
        const response = await fetch(`/api/v1/retrospectives/${retroId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const retroData = await response.json();
          
          // Navigate to retrospective with code
          window.location.href = `/retrospective/${retroData.code}`;
        } else {
          const errorData = await response.json().catch(() => ({}));
          // Handle scheduled gate
          if (response.status === 403 && errorData && errorData.detail && errorData.detail.not_started_until) {
            const until = new Date(errorData.detail.not_started_until);
            showCountdownBanner(until, () => openRetrospective(retroId));
            showToast('Retrospective is scheduled. You can join when the timer ends.', 'info');
          } else {
            const errorMsg = (errorData && (errorData.detail?.message || errorData.detail)) || 'Failed to open retrospective';
            showToast(errorMsg, 'danger');
          }
        }
      } catch (error) {
        console.error('Open retrospective error:', error);
        showToast('Failed to open retrospective', 'danger');
      }
    }
    
    function startWorkspaceCountdown(retroId, retroCode, startDate) {
      const timerEl = document.getElementById(`workspace-timer-${retroId}`);
      const actionEl = document.getElementById(`workspace-action-${retroId}`);
      
      if (!timerEl || !actionEl) return;
      
      function updateCountdown() {
        const now = new Date();
        const diffMs = startDate - now;
        
        if (diffMs <= 0) {
          // Time has elapsed - show join button
          timerEl.innerHTML = `
            <small class="text-success">
              <i class="bi bi-check-circle"></i> Started
            </small>
          `;
          actionEl.innerHTML = `
            <button class="btn btn-sm btn-primary" onclick="window.location.href='/retrospective/${retroCode}'">
              <i class="bi bi-play-circle"></i> Join Now
            </button>
          `;
          return;
        }
        
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
        
        let timeStr = '';
        if (days > 0) {
          timeStr = `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
          timeStr = `${hours}h ${minutes}m ${seconds}s`;
        } else {
          timeStr = `${minutes}m ${seconds}s`;
        }
        
        timerEl.innerHTML = `
          <small class="text-info">
            <i class="bi bi-clock"></i> In ${timeStr}
          </small>
        `;
        
        // Schedule next update
        setTimeout(updateCountdown, 1000);
      }
      
      // Initial update
      updateCountdown();
    }

    // ==================== UTILITIES ====================
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
      toast.style.zIndex = '9999';
      toast.style.minWidth = '300px';
      toast.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close modal when clicking outside
    document.getElementById('loginModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLoginModal();
      }
    });

    // ==================== WORKSPACE MANAGEMENT ====================
    
    async function checkAndLoadWorkspaces() {
      if (!authToken) return;
      
      try {
        const response = await fetch('/api/v1/workspaces/', {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          userWorkspaces = await response.json();
          
          if (userWorkspaces.length > 0) {
            // Set first workspace as current
            currentWorkspace = userWorkspaces[0];
            localStorage.setItem('current_workspace', JSON.stringify(currentWorkspace));
          }

          renderWorkspaceList();
        }
      } catch (error) {
        console.error('Load workspaces error:', error);
      }
    }

    function renderWorkspaceList() {
      const container = document.getElementById('workspacesList');
      if (!container) return;
      
      if (!userWorkspaces || userWorkspaces.length === 0) {
        container.innerHTML = '<p class="text-muted">No workspaces yet. Create your first workspace to get started!</p>';
        return;
      }
      
      let html = '<div class="row g-3">';
      userWorkspaces.forEach(workspace => {
        const isActive = currentWorkspace && currentWorkspace.id === workspace.id;
        html += `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 ${isActive ? 'border-primary' : ''}" 
                 onclick="openWorkspace(${workspace.id})" 
                 style="cursor:pointer; transition: all 0.3s; position:relative;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='';">
              <div class="card-body">
                ${isActive ? '<span class="badge bg-primary position-absolute top-0 end-0 m-2">Active</span>' : ''}
                <div class="d-flex align-items-start mb-2">
                  <div class="flex-shrink-0 me-3">
                    <i class="bi bi-building text-primary" style="font-size: 2rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="card-title mb-1">${escapeHtml(workspace.name)}</h5>
                    <p class="card-text text-muted small mb-2">${escapeHtml(workspace.description || 'No description')}</p>
                  </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <small class="text-muted">
                    <i class="bi bi-people me-1"></i>${workspace.member_count || 1} member${(workspace.member_count || 1) > 1 ? 's' : ''}
                  </small>
                  <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openWorkspace(${workspace.id});">
                    Open <i class="bi bi-arrow-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function openWorkspace(workspaceId) {
      if (!userWorkspaces || userWorkspaces.length === 0) return;
      const selected = userWorkspaces.find(w => String(w.id) === String(workspaceId));
      if (selected) {
        currentWorkspace = selected;
        localStorage.setItem('current_workspace', JSON.stringify(currentWorkspace));
        
        // Navigate to workspace detail view
        document.getElementById('workspaceDetailName').textContent = selected.name;
        document.getElementById('workspaceDetailDesc').textContent = selected.description || 'No description';
        
        // Load workspace summary when opening if needed
        // (Explicit loading also occurs when switching to the Summary tab)
        
        // Update tab locks based on user role
        updateWorkspaceTabLocks(selected.my_role);
        
        // Update button locks based on user role
        updateWorkspaceButtonLocks(selected.my_role);
        
        // Show workspace detail section
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById('workspaceDetailSection').classList.add('active');
        
        // Default to onboarding tab
        showWorkspaceTab('onboarding');
      }
    }
    
    function updateWorkspaceButtonLocks(userRole) {
      // Define which roles have access
      const privilegedRoles = ['Scrum Master', 'Project Manager'];
      const isPrivileged = privilegedRoles.includes(userRole);
      
      // Lock Create Retrospective button if not privileged
      const createRetroBtn = document.querySelector('#workspaceDetailSection button[onclick="showCreateRetroModal()"]');
      if (createRetroBtn) {
        if (!isPrivileged) {
          createRetroBtn.disabled = true;
          createRetroBtn.classList.add('opacity-50');
          createRetroBtn.title = 'Requires Scrum Master or Project Manager privileges';
        } else {
          createRetroBtn.disabled = false;
          createRetroBtn.classList.remove('opacity-50');
          createRetroBtn.title = '';
        }
      }
    }
    
    function exitWorkspace() {
      // Go back to dashboard
      showSection('dashboard');
      currentWorkspace = null;
    }
    
    function updateWorkspaceTabLocks(userRole) {
      // Define which roles have access to each feature
      const privilegedRoles = ['Scrum Master', 'Project Manager'];
      const isPrivileged = privilegedRoles.includes(userRole);
      // Owner/facilitator roles no longer used for UI gating; use privileged roles instead
      
      // Tabs that require privileged access
      const lockedTabs = ['retrospectives', 'team'];
      // Tabs that require owner access specifically
      const ownerOnlyTabs = ['onboarding'];
      
      // Tab info for restoring
      const tabInfo = {
        'retrospectives': { icon: 'bi-chat-dots', text: 'Retrospectives' },
        'team': { icon: 'bi-people', text: 'Team Members' },
        'onboarding': { icon: 'bi-rocket-takeoff', text: 'Getting Started' }
      };
      
      // Update privileged tabs
      lockedTabs.forEach(tabName => {
        const tabLink = document.querySelector(`#workspaceTabs a[onclick*="${tabName}"]`);
        if (tabLink) {
          if (!isPrivileged) {
            tabLink.style.pointerEvents = 'none';
            tabLink.style.opacity = '0.5';
            tabLink.innerHTML = `<i class="bi bi-lock"></i> ${tabInfo[tabName].text}`;
            tabLink.title = 'Requires Scrum Master or Project Manager privileges';
          } else {
            tabLink.style.pointerEvents = 'auto';
            tabLink.style.opacity = '1';
            tabLink.innerHTML = `<i class="bi ${tabInfo[tabName].icon}"></i> ${tabInfo[tabName].text}`;
            tabLink.title = '';
          }
        }
      });
      
      // Update owner-only tabs (privileged roles)
      ownerOnlyTabs.forEach(tabName => {
        const tabLink = document.querySelector(`#workspaceTabs a[onclick*="${tabName}"]`);
        if (tabLink) {
          if (!isPrivileged) {
            tabLink.style.pointerEvents = 'none';
            tabLink.style.opacity = '0.5';
            tabLink.innerHTML = `<i class=\"bi bi-lock\"></i> ${tabInfo[tabName].text}`;
            tabLink.title = 'Requires Scrum Master or Project Manager privileges';
          } else {
            tabLink.style.pointerEvents = 'auto';
            tabLink.style.opacity = '1';
            tabLink.innerHTML = `<i class=\"bi ${tabInfo[tabName].icon}\"></i> ${tabInfo[tabName].text}`;
            tabLink.title = '';
          }
        }
      });
    }
    
    function showWorkspaceTab(tabName) {
      // Check if tab is locked
      const privilegedRoles = ['Scrum Master', 'Project Manager'];
      const lockedTabs = ['retrospectives', 'team'];
      const ownerOnlyTabs = ['onboarding'];
      const role = currentWorkspace ? (currentWorkspace.my_role || '') : '';
      const roleLower2 = String(role).toLowerCase();
      const isLockedPriv = lockedTabs.includes(tabName) && currentWorkspace && !privilegedRoles.includes(role);
      const isLockedOwner = ownerOnlyTabs.includes(tabName) && currentWorkspace && !(roleLower2 === 'scrum master' || roleLower2 === 'project manager');
      const isLocked = isLockedPriv || isLockedOwner;
      
      // Hide all tabs
      document.querySelectorAll('.workspace-tab').forEach(tab => tab.classList.remove('active'));
      
      // Show selected tab
      const targetTab = document.getElementById(`workspace-${tabName}-tab`);
      if (targetTab) {
        targetTab.classList.add('active');
        
        // Show lock message if locked
        if (isLocked) {
          const lockMessage = `
            <div class="text-center py-5">
              <i class="bi bi-lock display-1 text-muted"></i>
              <h3 class="mt-3 text-muted">Access Restricted</h3>
              <p class="text-muted">${ownerOnlyTabs.includes(tabName) ? 'This feature requires Scrum master or Project Manager privileges.' : 'This feature requires Scrum Master or Project Manager privileges.'}</p>
            </div>
          `;
          targetTab.innerHTML = lockMessage;
          return; // Don't load data
        }
      }
      
      // Update tab navigation
      const clickedLink = event && event.target ? event.target : document.querySelector(`#workspaceTabs a[onclick*="${tabName}"]`);
      document.querySelectorAll('#workspaceTabs .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      if (clickedLink) clickedLink.classList.add('active');
      
      // Load data for the tab
      if (tabName === 'retrospectives') {
        loadWorkspaceRetros();
      } else if (tabName === 'action-items') {
        loadWorkspaceActionItems();
      } else if (tabName === 'team') {
        loadWorkspaceTeamMembers();
      } else if (tabName === 'onboarding') {
        initWorkspaceWizard();
      } else if (tabName === 'summary') {
        loadWorkspaceSummary();
      }
    }

    // ============== Workspace Onboarding Wizard ==============
    let _workspaceWizardCurrent = 1;
    
    async function initWorkspaceWizard() {
      _workspaceWizardCurrent = 1;
      // Load actual progress from API
      await loadWorkspaceOnboardingProgress();
      showWorkspaceWizardStep(_workspaceWizardCurrent);
    }
    
    async function loadWorkspaceOnboardingProgress() {
      if (!currentWorkspace || !authToken) return;
      
      try {
        const response = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const status = data.status || {};
          
          // Calculate progress based on completed steps
          // Steps: 1) Workspace Setup (always true), 2) AI Summary, 3) Team Members, 4) Retrospective
          const totalSteps = 4;
          let completedSteps = 1; // Workspace setup is always completed
          
          if (status.project_data_imported) completedSteps++;
          if (status.team_members_added) completedSteps++;
          if (status.first_retrospective_scheduled) completedSteps++;
          
          // If onboarding is completed, set to 100%
          if (status.onboarding_completed) {
            completedSteps = totalSteps;
          }
          
          const percent = Math.round((completedSteps / totalSteps) * 100);
          
          // Update progress bar
          const bar = document.getElementById('workspaceProgressBar');
          const label = document.getElementById('workspaceOnboardingProgress');
          if (bar) {
            bar.style.width = percent + '%';
            bar.setAttribute('aria-valuenow', percent);
          }
          if (label) label.textContent = percent + '%';
          
          // Determine which step to show based on progress
          // Find the first incomplete step
          if (!status.project_data_imported) {
            _workspaceWizardCurrent = 2; // AI Summary step
          } else if (!status.team_members_added) {
            _workspaceWizardCurrent = 3; // Team Members step
          } else if (!status.first_retrospective_scheduled) {
            _workspaceWizardCurrent = 4; // Retrospective step
          } else if (status.onboarding_completed) {
            _workspaceWizardCurrent = 4; // Show last step if completed
          } else {
            _workspaceWizardCurrent = 2; // Default to step 2 if workspace is set up
          }
        }
      } catch (error) {
        console.error('Error loading onboarding progress:', error);
        // Default to step 1 if API call fails
        _workspaceWizardCurrent = 1;
      }
    }
    function getWorkspaceWizardTotal() {
      const steps = document.querySelectorAll('#workspace-onboarding-tab .onboarding-step');
      return steps ? steps.length : 0;
    }
    function showWorkspaceWizardStep(stepIndex) {
      const steps = Array.from(document.querySelectorAll('#workspace-onboarding-tab .onboarding-step'));
      if (!steps.length) return;
      const total = steps.length;
      _workspaceWizardCurrent = Math.max(1, Math.min(stepIndex, total));
      steps.forEach((el, idx) => {
        el.style.display = (idx + 1) === _workspaceWizardCurrent ? 'block' : 'none';
      });
      const prevBtn = document.getElementById('onboardingPrevBtn');
      const nextBtn = document.getElementById('onboardingNextBtn');
      const nextButtonText = document.getElementById('nextButtonText');
      const currentStepNum = document.getElementById('currentStepNum');
      const totalStepsNum = document.getElementById('totalStepsNum');
      const onboardingHint = document.getElementById('onboardingHint');
      
      if (prevBtn) prevBtn.disabled = _workspaceWizardCurrent === 1;
      
      const isLastStep = _workspaceWizardCurrent === total;
      if (nextBtn) {
        const buttonText = isLastStep ? 'Finish Setup' : 'Next Step';
        if (nextButtonText) nextButtonText.textContent = buttonText;
        else nextBtn.innerHTML = buttonText + ' <i class="bi bi-arrow-right ms-1"></i>';
      }
      
      // Update step counter
      if (currentStepNum) currentStepNum.textContent = _workspaceWizardCurrent;
      if (totalStepsNum) totalStepsNum.textContent = total;
      
      // Update hint text based on step
      if (onboardingHint) {
        if (isLastStep) {
          onboardingHint.innerHTML = 'Click <strong>"Finish Setup"</strong> to complete onboarding and start using YodaAI!';
        } else {
          const nextStepName = getNextStepName(_workspaceWizardCurrent, total);
          onboardingHint.innerHTML = `Click <strong>"Next Step"</strong> to proceed to: <strong>${nextStepName}</strong>`;
        }
      }
      
      // Update progress bar based on actual completion status
      updateWorkspaceProgressBar();
    }
    
    async function updateWorkspaceProgressBar() {
      if (!currentWorkspace || !authToken) {
        // Fallback to positional calculation if no workspace
        const total = getWorkspaceWizardTotal();
      const percent = Math.round((_workspaceWizardCurrent - 1) / (total - 1 || 1) * 100);
      const bar = document.getElementById('workspaceProgressBar');
      const label = document.getElementById('workspaceOnboardingProgress');
        if (bar) {
          bar.style.width = percent + '%';
          bar.setAttribute('aria-valuenow', percent);
        }
      if (label) label.textContent = percent + '%';
        return;
      }
      
      try {
        const response = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const status = data.status || {};
          
          // Calculate progress based on completed steps
          const totalSteps = 4;
          let completedSteps = 1; // Workspace setup is always completed
          
          if (status.project_data_imported) completedSteps++;
          if (status.team_members_added) completedSteps++;
          if (status.first_retrospective_scheduled) completedSteps++;
          
          // If onboarding is completed, set to 100%
          if (status.onboarding_completed) {
            completedSteps = totalSteps;
          }
          
          const percent = Math.round((completedSteps / totalSteps) * 100);
          
          // Update progress bar
          const bar = document.getElementById('workspaceProgressBar');
          const label = document.getElementById('workspaceOnboardingProgress');
          if (bar) {
            bar.style.width = percent + '%';
            bar.setAttribute('aria-valuenow', percent);
          }
          if (label) label.textContent = percent + '%';
        }
      } catch (error) {
        console.error('Error updating progress bar:', error);
        // Fallback to positional calculation
        const total = getWorkspaceWizardTotal();
        const percent = Math.round((_workspaceWizardCurrent - 1) / (total - 1 || 1) * 100);
        const bar = document.getElementById('workspaceProgressBar');
        const label = document.getElementById('workspaceOnboardingProgress');
        if (bar) {
          bar.style.width = percent + '%';
          bar.setAttribute('aria-valuenow', percent);
        }
        if (label) label.textContent = percent + '%';
      }
    }
    
    function getNextStepName(currentStep, total) {
      const stepNames = {
        1: 'Generate AI Summary',
        2: 'Add Team Members',
        3: 'Create First Retrospective'
      };
      return stepNames[currentStep] || 'the next step';
    }
    let isFinishingOnboarding = false;

    async function nextWorkspaceWizardStep() {
      const total = getWorkspaceWizardTotal();
      if (_workspaceWizardCurrent >= total) {
        // Finish: take user to Retrospectives tab
        if (isFinishingOnboarding) return; // lock to prevent multiple inputs
        isFinishingOnboarding = true;
        
        const nextBtn = document.getElementById('onboardingNextBtn');
        const prevBtn = document.getElementById('onboardingPrevBtn');
        const nextButtonText = document.getElementById('nextButtonText');
        
        if (nextBtn) {
          nextBtn.disabled = true;
          nextBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Finishing...';
        }
        if (prevBtn) prevBtn.disabled = true;
        
        try {
          if (currentWorkspace && authToken) {
            const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/complete`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (resp.ok) {
              showToast('Onboarding completed!', 'success');
            }
          }
        } catch (e) {
          showToast('Failed to complete onboarding', 'danger');
        } finally {
          isFinishingOnboarding = false;
          if (nextBtn) {
            nextBtn.disabled = false;
            // Restore button with icon
            if (nextButtonText) {
              nextBtn.innerHTML = '<span id="nextButtonText">Finish Setup</span> <i class="bi bi-arrow-right ms-1"></i>';
            } else {
              nextBtn.innerHTML = 'Finish Setup <i class="bi bi-arrow-right ms-1"></i>';
            }
          }
          if (prevBtn) prevBtn.disabled = false;
        }
        showWorkspaceTab('retrospectives');
        return;
      }
      showWorkspaceWizardStep(_workspaceWizardCurrent + 1);
    }
    function prevWorkspaceWizardStep() {
      showWorkspaceWizardStep(_workspaceWizardCurrent - 1);
    }
    
    async function loadWorkspaceRetros() {
      if (!currentWorkspace) return;
      try {
        const response = await fetch(`/api/v1/retrospectives/workspace/${currentWorkspace.id}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
          const retros = await response.json();
          const container = document.getElementById('workspaceRetrosList');
          if (container && retros.length > 0) {
            container.innerHTML = retros.map(r => {
              const cardId = `workspace-retro-${r.id}`;
              return `
                <div class="card mb-2" id="${cardId}">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h6 class="mb-1">
                          <i class="bi bi-calendar-event"></i> ${escapeHtml(r.title)}
                        </h6>
                        ${r.sprint_name ? `<small class="text-muted d-block mb-2">${escapeHtml(r.sprint_name)}</small>` : ''}
                        <div class="d-flex gap-3 flex-wrap">
                          <div id="workspace-timer-${r.id}">
                            <small class="text-muted">
                              <i class="bi bi-clock"></i> Loading...
                            </small>
                          </div>
                        </div>
                      </div>
                      <div id="workspace-action-${r.id}">
                        <button class="btn btn-sm btn-secondary" disabled>
                          <i class="bi bi-lock"></i> Waiting
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('');
            
            // Start countdown timers for each retrospective
            retros.forEach(r => {
              const startDate = r.scheduled_start_time ? new Date(r.scheduled_start_time) : null;
              if (startDate) {
                startWorkspaceCountdown(r.id, r.code, startDate);
              }
            });
          } else if (container) {
            container.innerHTML = '<p class="text-muted">No retrospectives yet.</p>';
          }
        }
      } catch (error) {
        console.error('Load workspace retros error:', error);
      }
    }
    
    async function loadWorkspaceActionItems() {
      if (!currentWorkspace) return;
      try {
        const response = await fetch(`/api/v1/action-items/?workspace_id=${currentWorkspace.id}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
          const allItems = await response.json();
          const container = document.getElementById('workspaceActionItemsList');
          if (container && allItems.length > 0) {
            container.innerHTML = allItems.map(item => {
              const priorityBadge = {
                'low': 'success',
                'medium': 'warning', 
                'high': 'danger',
                'critical': 'dark'
              }[item.priority] || 'secondary';

              const statusBadge = {
                'pending': 'secondary',
                'in_progress': 'primary',
                'completed': 'success',
                'cancelled': 'warning',
                'blocked': 'danger'
              }[item.status] || 'secondary';

              const statusText = {
                'pending': 'Pending',
                'in_progress': 'In Progress',
                'completed': 'Completed',
                'cancelled': 'Cancelled',
                'blocked': 'Blocked'
              }[item.status] || item.status;

              const dueDate = item.due_date ? new Date(item.due_date).toLocaleDateString() : 'No due date';
              const isOverdue = item.due_date && new Date(item.due_date) < new Date() && item.status !== 'completed';
              
              const progress = item.progress_percentage || 0;
              let progressColor = 'danger';
              if (progress >= 75) progressColor = 'success';
              else if (progress >= 50) progressColor = 'info';
              else if (progress >= 25) progressColor = 'warning';

              return `
                <div class="card mb-2 ${item.status === 'completed' ? 'bg-light' : ''}">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h6 class="mb-1 ${item.status === 'completed' ? 'text-decoration-line-through text-muted' : ''}">
                          ${escapeHtml(item.title)}
                        </h6>
                        ${item.description ? `<p class="mb-2 text-muted small">${escapeHtml(item.description)}</p>` : ''}
                        <div class="d-flex gap-2 flex-wrap mb-2">
                          <span class="badge bg-${priorityBadge}">${item.priority.toUpperCase()}</span>
                          <span class="badge bg-${statusBadge}">${statusText}</span>
                          <span class="badge bg-info ${isOverdue ? 'bg-danger' : ''}">
                            <i class="bi bi-calendar me-1"></i>${dueDate}
                          </span>
                        </div>
                        ${progress > 0 ? `
                          <div class="mt-2">
                            <small class="text-muted">Progress:</small>
                            <div class="progress" style="height: 8px; margin-top: 4px;">
                              <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                <span class="visually-hidden">${progress}%</span>
                              </div>
                            </div>
                            <small class="text-muted">${progress}% complete</small>
                          </div>
                        ` : ''}
                      </div>
                      <div class="btn-group ms-3">
                        ${item.status !== 'completed' ? `
                          <button class="btn btn-sm btn-success" onclick="markActionItemComplete(${item.id})" title="Complete">
                            <i class="bi bi-check-lg"></i>
                          </button>
                        ` : ''}
                        <button class="btn btn-sm btn-primary" onclick="editActionItem(${item.id})" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteActionItem(${item.id})" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('');
          } else if (container) {
            container.innerHTML = '<p class="text-muted">No action items yet.</p>';
          }
        }
      } catch (error) {
        console.error('Load workspace action items error:', error);
      }
    }
    
    async function loadWorkspaceTeamMembers() {
      if (!currentWorkspace) return;
      try {
        const response = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/members`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
          const members = await response.json();
          const container = document.getElementById('workspaceTeamList');
          if (container && members.length > 0) {
            container.innerHTML = members.map(m => `
              <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                <div>
                  <strong>${escapeHtml(m.full_name || m.email)}</strong>
                  <small class="text-muted ms-2">${escapeHtml(m.role)}</small>
                </div>
              </div>
            `).join('');
          } else if (container) {
            container.innerHTML = '<p class="text-muted">No team members yet.</p>';
          }
        }
      } catch (error) {
        console.error('Load team members error:', error);
      }
    }
    
    function completeWorkspaceStep(step) {
      // TODO: Implement workspace step completion
      showToast('Step completed!', 'success');
    }
    
    function skipWorkspaceStep(step) {
      // TODO: Implement workspace step skipping
      showToast('Step skipped', 'info');
    }
    
    async function uploadAdditionalDocument() {
      const fileInput = document.getElementById('additionalWorkspaceDoc');
      if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        showToast('Please select a file', 'warning');
        return;
      }
      const file = fileInput.files[0];
      const form = new FormData();
      form.append('file', file);
      try {
        const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` },
          body: form
        });
        if (resp.ok) {
          showToast('File uploaded', 'success');
          // Auto-generate AI summary after upload
          const gen = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/generate`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          if (gen.ok) {
            showToast('AI summary generated', 'success');
            // Reflect in onboarding tab UI summary area if present
            const docSummary = document.getElementById('docSummary');
            const docSummaryText = document.getElementById('docSummaryText');
            if (docSummary && docSummaryText) {
              const json = await gen.json().catch(() => null);
              const text = json && json.onboarding_data && json.onboarding_data.ai_summary ? json.onboarding_data.ai_summary : 'Summary created.';
              docSummaryText.textContent = text;
              docSummary.style.display = 'block';
            }
          } else {
            showToast('Failed to generate summary', 'danger');
          }
        } else {
          const msg = await resp.text();
          showToast(msg || 'Failed to upload file', 'danger');
        }
      } catch (e) {
        showToast('Network error uploading file', 'danger');
      }
    }
    
    let isGeneratingSummary = false;
    
    async function generateDocumentSummary() {
      if (!currentWorkspace) return;
      if (isGeneratingSummary) return; // lock to prevent multiple inputs
      
      // Failsafe: Require a file selection (avoid summarizing an existing summary)
      const input = document.getElementById('summaryUploadInput');
      const hasFile = input && input.files && input.files[0];
      if (!hasFile) {
        showToast('Please select a file to upload first', 'warning');
        return;
      }
      
      isGeneratingSummary = true;
      const btn = document.getElementById('generateSummaryBtn');
      const fileInput = document.getElementById('summaryUploadInput');
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...'; }
      if (fileInput) { fileInput.disabled = true; }
      try {
        // If a file is selected, upload it first
        if (hasFile) {
          const form = new FormData();
          form.append('file', input.files[0]);
          const up = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` },
            body: form
          });
          if (!up.ok) {
            let errorMsg = 'Failed to upload file';
            try {
              const errorData = await up.json();
              const detail = errorData.detail || '';
              if (detail.includes('Unable to parse PDF') || detail.includes('scanned') || detail.includes('image-only')) {
                errorMsg = 'PDF file cannot be read. Please ensure the PDF contains selectable text (not a scanned image). Try converting the PDF to a text-based format or use a different file (.txt or .md).';
              } else {
                errorMsg = detail || errorMsg;
              }
            } catch (e) {
              // If JSON parsing fails, try text
              const text = await up.text().catch(() => '');
              if (text.includes('Unable to parse PDF') || text.includes('scanned') || text.includes('image-only')) {
                errorMsg = 'PDF file cannot be read. Please ensure the PDF contains selectable text (not a scanned image). Try converting the PDF to a text-based format or use a different file (.txt or .md).';
              } else if (text) {
                errorMsg = text;
              }
            }
            showToast(errorMsg, 'danger');
            return; // exit early on upload failure
          }
        }

        const gen = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/generate`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (gen.ok) {
          showToast('AI summary generated', 'success');
          const statusDiv = document.getElementById('workspaceDocumentStatus');
          if (statusDiv && !document.getElementById('viewSummaryBtn')) {
            const btn2 = document.createElement('button');
            btn2.className = 'btn btn-outline-primary btn-sm ms-2';
            btn2.id = 'viewSummaryBtn';
            btn2.innerHTML = '<i class="bi bi-file-text"></i> View Summary';
            btn2.onclick = () => showWorkspaceTab('summary');
            statusDiv.appendChild(btn2);
          }
          // Update progress bar after summary generation
          updateWorkspaceProgressBar();
        } else {
          if (gen.status === 403) {
            showToast('You do not have permission (Scrum Master or Project Manager required)', 'danger');
          } else {
            showToast('Failed to generate summary', 'danger');
          }
        }
      } catch (e) {
        showToast('Network error generating summary', 'danger');
      } finally {
        isGeneratingSummary = false;
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-cpu"></i> Generate AI Summary'; }
        if (fileInput) { fileInput.disabled = false; }
      }
    }

    async function loadWorkspaceSummary() {
      if (!currentWorkspace) return;
      const container = document.getElementById('workspaceSummaryContainer');
      if (!container) return;

      const userRole = currentWorkspace.my_role || 'member';

      // Load onboarding summary from canonical endpoint
      let summaryText = '';
      try {
        const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        if (resp.ok) {
          const data = await resp.json();
          const onboardingObj = data && data.onboarding_data ? data.onboarding_data : null;
          if (onboardingObj && typeof onboardingObj === 'object') {
            summaryText = onboardingObj.ai_summary || '';
          } else if (typeof onboardingObj === 'string') {
            summaryText = onboardingObj;
          }
        } else if (resp.status === 403) {
          container.innerHTML = `<p class="text-muted">You do not have access to view this summary.</p>`;
          return;
        }
      } catch (_) {}

      if (summaryText && summaryText.trim() !== '') {
        container.innerHTML = `
          <div class="alert alert-info">
            <strong>AI Summary</strong>
          </div>
          <div class="mb-3">${renderSummaryHtml(summaryText)}</div>
        `;
        return;
      }

      container.innerHTML = `<p class="text-muted">No summary has been uploaded for this workspace yet.</p>`;
    }

    function renderSummaryHtml(text) {
      // Escape HTML first
      const escaped = escapeHtml(text);
      const lines = escaped.split(/\r?\n/);
      const html = [];
      let inList = false;
      const flushList = () => { if (inList) { html.push('</ul>'); inList = false; } };
      const boldRegex = /\*\*(.+?)\*\*/g; // simple **bold**
      for (let raw of lines) {
        const line = raw.trimEnd();
        if (/^[-*]\s+/.test(line)) {
          if (!inList) { html.push('<ul>'); inList = true; }
          const item = line.replace(/^[-*]\s+/, '').replace(boldRegex, '<strong>$1<\/strong>');
          html.push(`<li>${item}</li>`);
        } else if (line === '') {
          flushList();
          html.push('<br>');
        } else {
          flushList();
          html.push(`<p>${line.replace(boldRegex, '<strong>$1<\/strong>')}</p>`);
        }
      }
      flushList();
      return html.join('');
    }

    async function uploadWorkspaceSummarySource() {
      const input = document.getElementById('summaryUploadInput');
      if (!input || !input.files || !input.files[0]) {
        showToast('Please select a file', 'warning');
        return;
      }
      const file = input.files[0];
      const form = new FormData();
      form.append('file', file);
      try {
        const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` },
          body: form
        });
        if (resp.ok) {
          showToast('File uploaded', 'success');
          // Auto-generate AI summary after upload
          const gen = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/generate`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          if (gen.ok) {
            showToast('AI summary generated', 'success');
            const statusDiv = document.getElementById('workspaceDocumentStatus');
            if (statusDiv && !document.getElementById('viewSummaryBtn')) {
              const btn2 = document.createElement('button');
              btn2.className = 'btn btn-outline-primary btn-sm ms-2';
              btn2.id = 'viewSummaryBtn';
              btn2.innerHTML = '<i class="bi bi-file-text"></i> View Summary';
              btn2.onclick = () => showWorkspaceTab('summary');
              statusDiv.appendChild(btn2);
            }
            loadWorkspaceSummary();
          } else {
            showToast('Failed to generate summary', 'danger');
          }
        } else {
          const msg = await resp.text();
          showToast(msg || 'Failed to upload file', 'danger');
        }
      } catch (e) {
        showToast('Network error uploading file', 'danger');
      }
    }

    async function generateWorkspaceSummary() {
      if (!currentWorkspace) return;
      try {
        const resp = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/onboarding/generate`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (resp.ok) {
          showToast('AI summary generated', 'success');
          loadWorkspaceSummary();
        } else {
          showToast('Failed to generate summary', 'danger');
        }
      } catch (e) {
        showToast('Network error generating summary', 'danger');
      }
    }
    
    async function updateWorkspaceSettings() {
      if (!currentWorkspace) return;
      const name = document.getElementById('settingsWorkspaceName').value;
      const desc = document.getElementById('settingsWorkspaceDesc').value;
      
      try {
        const response = await fetch(`/api/v1/workspaces/${currentWorkspace.id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, description: desc })
        });
        if (response.ok) {
          showToast('Settings updated successfully!', 'success');
          await checkAndLoadWorkspaces();
        }
      } catch (error) {
        showToast('Failed to update settings', 'danger');
      }
    }
    
    let emailValidationTimeout;
    let lastValidatedEmail = '';
    
    async function validateInviteEmail(email) {
      const feedbackEl = document.getElementById('inviteEmailFeedback');
      const inviteBtn = document.getElementById('inviteBtn');
      const emailInput = document.getElementById('inviteEmail');
      
      // Clear previous timeout
      if (emailValidationTimeout) {
        clearTimeout(emailValidationTimeout);
      }
      
      // Don't validate if empty or hasn't changed
      if (!email || email.trim() === '') {
        feedbackEl.innerHTML = '';
        feedbackEl.className = 'form-text mt-1';
        emailInput.classList.remove('is-invalid', 'is-valid');
        inviteBtn.disabled = true;
        return;
      }
      
      if (email === lastValidatedEmail) {
        return; // Already validated this email
      }
      
      // Show loading state
      feedbackEl.innerHTML = '<i class="bi bi-hourglass-split"></i> Checking email...';
      feedbackEl.className = 'form-text mt-1 text-info';
      emailInput.classList.remove('is-invalid', 'is-valid');
      inviteBtn.disabled = true;
      
      // Debounce: wait 500ms before making the API call
      emailValidationTimeout = setTimeout(async () => {
        if (!currentWorkspace) {
          feedbackEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please select a workspace first';
          feedbackEl.className = 'form-text mt-1 text-warning';
          inviteBtn.disabled = true;
          return;
        }
        
        try {
          const response = await fetch(
            `/api/v1/workspaces/${currentWorkspace.id}/invitations/validate-email?email=${encodeURIComponent(email)}`,
            {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              }
            }
          );
          
          const data = await response.json();
          lastValidatedEmail = email;
          
          if (data.valid) {
            // Valid email
            feedbackEl.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message}`;
            feedbackEl.className = 'form-text mt-1 text-success';
            emailInput.classList.remove('is-invalid');
            emailInput.classList.add('is-valid');
            inviteBtn.disabled = false;
          } else {
            // Invalid email
            feedbackEl.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${data.message}`;
            feedbackEl.className = 'form-text mt-1 text-danger';
            emailInput.classList.remove('is-valid');
            emailInput.classList.add('is-invalid');
            inviteBtn.disabled = true;
          }
        } catch (error) {
          console.error('Email validation error:', error);
          feedbackEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Unable to validate email';
          feedbackEl.className = 'form-text mt-1 text-warning';
          emailInput.classList.remove('is-invalid', 'is-valid');
          inviteBtn.disabled = true;
        }
      }, 500);
    }
    
    async function inviteTeamMember() {
      if (!currentWorkspace) {
        showToast('Please select a workspace first', 'warning');
        return;
      }
      
      const email = document.getElementById('inviteEmail').value.trim();
      const role = document.getElementById('inviteRole').value;
      
      if (!email) {
        showToast('Please enter an email address', 'warning');
        return;
      }
      
      // Re-validate before submitting
      const emailInput = document.getElementById('inviteEmail');
      if (!emailInput.classList.contains('is-valid')) {
        showToast('Please fix the email validation errors before sending', 'danger');
        return;
      }
      
      const inviteBtn = document.getElementById('inviteBtn');
      const inviteBtnText = document.getElementById('inviteBtnText');
      const originalBtnText = inviteBtnText ? inviteBtnText.textContent : 'Send Invite';
      
      // Show loading state
      if (inviteBtn) {
        inviteBtn.disabled = true;
        if (inviteBtnText) {
          inviteBtnText.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        } else {
          inviteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        }
      }
      
      try {
        const response = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/invitations`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, role })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to invite member');
        }
        
        showToast(`Invitation sent successfully to ${email}!`, 'success');
        document.getElementById('inviteEmail').value = '';
        document.getElementById('inviteEmailFeedback').innerHTML = '';
        document.getElementById('inviteEmailFeedback').className = 'form-text mt-1';
        emailInput.classList.remove('is-invalid', 'is-valid');
        lastValidatedEmail = '';
        
        // Reload team members list
        loadWorkspaceTeamMembers();
        // Update progress bar after adding team member
        updateWorkspaceProgressBar();
      } catch (error) {
        showToast(error.message || 'Failed to send invitation', 'danger');
        // Re-validate to show error state
        validateInviteEmail(email);
      } finally {
        // Restore button state
        if (inviteBtn) {
          inviteBtn.disabled = !emailInput.classList.contains('is-valid');
          if (inviteBtnText) {
            inviteBtnText.textContent = originalBtnText;
          } else {
            inviteBtn.innerHTML = `<i class="bi bi-send-fill me-1"></i> ${originalBtnText}`;
          }
        }
      }
    }
    
    function goToAnalyticsForWorkspace(workspaceId) {
      // Analytics is always overall, not workspace-specific
      showSection('analytics');
      loadAnalytics();
    }

    async function loadAnalytics() {
      const titleEl = document.getElementById('analyticsTitle');
      const insightsEl = document.getElementById('aiInsights');
      
      // Always show overall analytics title
      if (titleEl) {
        titleEl.textContent = 'Analytics & Insights';
      }
      
      // Load overall statistics across all workspaces
      try {
        const headers = { 'Authorization': `Bearer ${authToken}` };
        
        // STEP 1: Immediately show skeleton cards based on workspaces
        const workspacesResponse = await fetch('/api/v1/workspaces/', { headers }).catch(() => null);
        if (workspacesResponse && workspacesResponse.ok) {
          const workspaces = await workspacesResponse.json();
          showInsightsSkeleton(workspaces, insightsEl);
        } else {
          if (insightsEl) {
            insightsEl.innerHTML = '<div class="mb-3"><h6 class="mb-2"><i class="bi bi-lightbulb-fill text-warning"></i> AI Highlights</h6></div>';
          }
        }

        // STEP 2: Load statistics quickly (don't await engagement yet)
        const retrosResponse = await fetch('/api/v1/retrospectives/', { headers }).catch(() => null);
        let retros = [];
        if (retrosResponse && retrosResponse.ok) {
          retros = await retrosResponse.json();
          const total = retros.length;
          
          // Calculate Active: retrospectives that are in progress, scheduled, or not completed
          const active = retros.filter(r => {
            const status = r.status || '';
            const phase = r.current_phase || '';
            // Active if: in_progress, scheduled, or phase is not completed/summary
            return status === 'in_progress' || 
                   status === 'scheduled' ||
                   (status !== 'completed' && phase !== 'completed' && phase !== 'summary' && phase !== '');
          }).length;
          
          // Calculate Completed: retrospectives that are fully completed
          const completed = retros.filter(r => {
            const status = (r.status || '').toLowerCase();
            const phase = (r.current_phase || '').toLowerCase();
            // Completed if status or phase indicates completion
            return status === 'completed' || phase === 'completed' || phase === 'summary';
          }).length;
          
          document.getElementById('totalRetros').textContent = total;
          document.getElementById('activeRetros').textContent = active;
          document.getElementById('completedActions').textContent = completed;
        }

        // STEP 3: Load action items (non-blocking)
        const actionsResponse = await fetch('/api/v1/action-items/', { headers }).catch(() => null);
        let actions = [];
        if (actionsResponse && actionsResponse.ok) {
          actions = await actionsResponse.json();
        }

        // STEP 4: Calculate engagement in background
        calculateEngagement(retros, actions, headers).catch(e => console.error('Engagement calc error:', e));

        // STEP 5: Generate AI Insights progressively
        generateAIInsights(retros, actions, headers, insightsEl).catch(e => console.error('Insights error:', e));
      } catch (error) {
        console.log('Analytics load:', error);
        if (insightsEl) {
          insightsEl.innerHTML = '<p class="text-muted">Complete retrospectives to see AI-powered insights and patterns.</p>';
        }
      }
    }

    async function typewriterEffect(elementId, text, speed = 20) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const textSpan = element.querySelector('.typewriter-text');
      if (textSpan) {
        textSpan.textContent = '';
        for (let i = 0; i < text.length; i++) {
          textSpan.textContent += text.charAt(i);
          await new Promise(r => setTimeout(r, speed));
        }
      }
    }

    function showInsightsSkeleton(workspaces, insightsEl) {
      if (!insightsEl || !workspaces || workspaces.length === 0) {
      if (insightsEl) {
          insightsEl.innerHTML = '<div class="mb-3"><h6 class="mb-2"><i class="bi bi-lightbulb-fill text-warning"></i> AI Highlights</h6></div>';
        }
        return;
      }

      // Show skeleton cards immediately
      let html = '<div class="mb-3">';
      html += '<h6 class="mb-3"><i class="bi bi-lightbulb-fill text-warning"></i> AI Highlights</h6>';
      
      workspaces.forEach((workspace, index) => {
        html += `<div class="card mb-3 ${index > 0 ? 'mt-3' : ''}" style="border-left: 4px solid #667eea;">`;
        html += '<div class="card-body">';
        html += `<h6 class="mb-2"><i class="bi bi-folder-fill text-primary"></i> ${escapeHtml(workspace.name)}</h6>`;
        html += '<p class="mb-2 text-muted"><span class="placeholder col-3"></span></p>';
        html += '<p class="mb-2 text-muted"><span class="placeholder col-7"></span></p>';
        html += '<div class="mb-2"><span class="placeholder col-9"></span></div>';
        html += '<div class="mt-2 p-2 bg-light rounded"><span class="placeholder col-8"></span></div>';
        html += '</div>';
        html += '</div>';
      });
      
      html += '</div>';
      insightsEl.innerHTML = html;
    }

    async function calculateEngagement(retros, actions, headers) {
      try {
        const engagementEl = document.getElementById('engagement');
        if (!engagementEl) return;

        // Ensure arrays are defined
        retros = retros || [];
        actions = actions || [];

        let engagementScore = 0;
        let factors = 0;
        let totalWeight = 0;

        // Factor 1: Action Item Completion Rate (weight: 40%)
        if (actions && actions.length > 0) {
          const completedActions = actions.filter(a => a.status === 'completed').length;
          const actionCompletionRate = (completedActions / actions.length) * 100;
          engagementScore += actionCompletionRate * 0.4;
          totalWeight += 0.4;
          factors++;
        }

        // Factor 2: Retrospective Completion Rate (weight: 35%)
        if (retros && retros.length > 0) {
          const completedRetros = retros.filter(r => {
            const status = r.status || '';
            const phase = r.current_phase || '';
            return status === 'completed' || phase === 'completed' || phase === 'summary';
          }).length;
          const retroCompletionRate = (completedRetros / retros.length) * 100;
          engagementScore += retroCompletionRate * 0.35;
          totalWeight += 0.35;
          factors++;
        }

        // Factor 3: Participation Rate (weight: 25%) - Calculate from participant data
        if (retros && retros.length > 0) {
          let totalParticipants = 0;
          let engagedParticipants = 0;

          // Sample up to 5 most recent retrospectives to calculate participation
          const recentRetros = retros.slice(0, 5);
          
          for (const retro of recentRetros) {
            try {
              const participantsResponse = await fetch(`/api/v1/retrospectives/${retro.id}/participants`, { headers }).catch(() => null);
              if (participantsResponse && participantsResponse.ok) {
                const participants = await participantsResponse.json();
                totalParticipants += participants.length;
                // Count participants who completed input or voting
                engagedParticipants += participants.filter(p => 
                  p.completed_input === true || p.completed_voting === true
                ).length;
              }
            } catch (e) {
              // Skip if participant data not available
            }
          }

          if (totalParticipants > 0) {
            const participationRate = (engagedParticipants / totalParticipants) * 100;
            engagementScore += participationRate * 0.25;
            totalWeight += 0.25;
            factors++;
          }
        }

        // Calculate final engagement score
        let finalEngagement = 0;
        if (totalWeight > 0) {
          // Normalize by total weight used
          finalEngagement = engagementScore / totalWeight;
        } else if (factors === 0) {
          // No data available
          finalEngagement = 0;
        } else {
          // Fallback: simple average if weights don't add up
          finalEngagement = engagementScore / factors;
        }

        // Round to nearest integer
        finalEngagement = Math.round(finalEngagement);
        
        // Ensure it's between 0 and 100
        finalEngagement = Math.max(0, Math.min(100, finalEngagement));
        
        engagementEl.textContent = finalEngagement + '%';
      } catch (error) {
        console.error('Error calculating engagement:', error);
        // Fallback to simple calculation
        const engagementEl = document.getElementById('engagement');
        if (engagementEl) {
          retros = retros || [];
          actions = actions || [];
          
          if (actions.length > 0) {
            const completedActions = actions.filter(a => a.status === 'completed').length;
            const engagement = Math.round((completedActions / actions.length) * 100);
            engagementEl.textContent = engagement + '%';
          } else if (retros.length > 0) {
            const completedRetros = retros.filter(r => {
              const status = r.status || '';
              const phase = r.current_phase || '';
              return status === 'completed' || phase === 'completed' || phase === 'summary';
            }).length;
            const engagement = Math.round((completedRetros / retros.length) * 100);
            engagementEl.textContent = engagement + '%';
          } else {
            engagementEl.textContent = '0%';
          }
        }
      }
    }

    async function generateAIInsights(retros, actions, headers, insightsEl) {
      if (!insightsEl) return;

      try {
        // Fetch all workspaces
        const workspacesResponse = await fetch('/api/v1/workspaces/', { headers }).catch(() => null);
        if (!workspacesResponse || !workspacesResponse.ok) {
          insightsEl.innerHTML = '<p class="text-muted mb-0">Complete retrospectives to see AI-powered insights and patterns.</p>';
          return;
        }

        const workspaces = await workspacesResponse.json();
        if (workspaces.length === 0) {
          insightsEl.innerHTML = '<p class="text-muted mb-0">Create a workspace to start tracking insights.</p>';
          return;
        }

        // Generate data hash to check if insights need to be regenerated
        // Include workspace IDs, all retro IDs, and completed retro IDs to detect completion changes
        const workspaceIds = workspaces.map(w => w.id).sort().join(',');
        const retroIds = retros.map(r => r.id).sort().join(',');
        const completedRetroIds = retros
          .filter(r => {
            const status = (r.status || '').toLowerCase();
            const phase = (r.current_phase || '').toLowerCase();
            return status === 'completed' || phase === 'completed' || phase === 'summary';
          })
          .map(r => r.id)
          .sort()
          .join(',');
        const dataHash = `${workspaceIds}|${retroIds}|${completedRetroIds}`;
        const cacheKey = `yodaai_insights_${currentUser?.id || 'anonymous'}`;
        const hashKey = `yodaai_insights_hash_${currentUser?.id || 'anonymous'}`;

        // Check if we have cached insights with matching hash
        const cachedHash = localStorage.getItem(hashKey);
        const cachedInsights = localStorage.getItem(cacheKey);

        if (cachedHash === dataHash && cachedInsights) {
          // Data hasn't changed, use cached insights
          insightsEl.innerHTML = cachedInsights;
          return;
        }

        // Data has changed or no cache exists, generate new insights

        // Process each workspace
        const workspaceInsights = [];
        
        for (const workspace of workspaces) {
          // Fetch retrospectives for this workspace
          const workspaceRetrosResponse = await fetch(`/api/v1/retrospectives/?workspace_id=${workspace.id}`, { headers }).catch(() => null);
          const workspaceRetros = workspaceRetrosResponse && workspaceRetrosResponse.ok ? await workspaceRetrosResponse.json() : [];
          
          // Fetch action items for this workspace
          const workspaceActionsResponse = await fetch(`/api/v1/action-items/?workspace_id=${workspace.id}`, { headers }).catch(() => null);
          const workspaceActions = workspaceActionsResponse && workspaceActionsResponse.ok ? await workspaceActionsResponse.json() : [];

          // Count completed retrospectives
          const completedRetros = workspaceRetros.filter(r => 
            r.status === 'completed' || r.current_phase === 'completed' || r.current_phase === 'summary'
          );
          const completedCount = completedRetros.length;
          const totalRetros = workspaceRetros.length;

          // Get summary from latest completed retro
          let summary = '';
          if (completedRetros.length > 0) {
            const latestRetro = completedRetros[0];
            summary = `Latest: ${latestRetro.title || latestRetro.sprint_name || 'Completed retrospective'}`;
            
            // Try to get themes from latest retro
            try {
              const groupingResponse = await fetch(`/api/v1/grouping/${latestRetro.id}`, { headers }).catch(() => null);
              if (groupingResponse && groupingResponse.ok) {
                const groupingData = await groupingResponse.json();
                const themes = groupingData.themes || [];
                if (themes.length > 0) {
                  const topThemes = themes.slice(0, 3).map(t => t.theme_title || t.title || '').filter(Boolean);
                  if (topThemes.length > 0) {
                    summary += `. Key themes: ${topThemes.join(', ')}`;
                  }
                }
              }
            } catch (e) {
              // Continue without themes
            }
          } else if (workspaceRetros.length > 0) {
            const inProgressRetros = workspaceRetros.filter(r => r.status === 'in_progress');
            if (inProgressRetros.length > 0) {
              summary = `${inProgressRetros.length} retrospective${inProgressRetros.length > 1 ? 's' : ''} in progress`;
            } else {
              summary = 'No completed retrospectives yet';
            }
          } else {
            summary = 'No retrospectives created yet';
          }

          // Get pending action items
          const pendingActions = workspaceActions.filter(a => 
            a.status === 'pending' || a.status === 'in_progress'
          );
          const overdueActions = pendingActions.filter(a => {
            if (!a.due_date) return false;
            return new Date(a.due_date) < new Date();
          });

          // Generate recommendation
          let recommendation = '';
          if (completedCount === 0 && totalRetros === 0) {
            recommendation = 'Create your first retrospective to start tracking team insights and improvements.';
          } else if (completedCount === 0 && totalRetros > 0) {
            recommendation = 'Complete your in-progress retrospectives to unlock insights and action items.';
          } else if (overdueActions.length > 0) {
            recommendation = `Address ${overdueActions.length} overdue action item${overdueActions.length > 1 ? 's' : ''} to maintain momentum.`;
          } else if (pendingActions.length > 0) {
            const completionRate = workspaceActions.length > 0 
              ? Math.round((workspaceActions.filter(a => a.status === 'completed').length / workspaceActions.length) * 100)
              : 0;
            if (completionRate < 60) {
              recommendation = `Focus on completing ${pendingActions.length} pending action item${pendingActions.length > 1 ? 's' : ''} to improve team velocity.`;
            } else {
              recommendation = `Continue the momentum - ${pendingActions.length} action item${pendingActions.length > 1 ? 's are' : ' is'} in progress.`;
            }
          } else if (completedCount > 0) {
            recommendation = 'Great progress! Consider scheduling your next retrospective to maintain continuous improvement.';
          } else {
            recommendation = 'Start tracking improvements by completing retrospectives and action items.';
          }

          workspaceInsights.push({
            workspace: workspace,
            completedCount: completedCount,
            totalRetros: totalRetros,
            summary: summary,
            pendingActions: pendingActions,
            overdueActions: overdueActions,
            recommendation: recommendation
          });
        }

        // Build HTML organized by workspace with typewriter effect
        let html = '<div class="mb-3">';
        html += '<h6 class="mb-3"><i class="bi bi-lightbulb-fill text-warning"></i> AI Highlights</h6>';
        
        if (workspaceInsights.length === 0) {
          html += '<p class="text-muted mb-0">Complete retrospectives to see AI-powered insights and patterns.</p>';
          html += '</div>';
          insightsEl.innerHTML = html;
          
          // Cache empty insights too
          try {
            localStorage.setItem(cacheKey, html);
            localStorage.setItem(hashKey, dataHash);
          } catch (e) {
            console.warn('Failed to cache insights:', e);
          }
          return;
        } else {
          // Create card structure immediately
          workspaceInsights.forEach((insight, index) => {
            html += `<div class="card mb-3 ${index > 0 ? 'mt-3' : ''}" style="border-left: 4px solid #667eea;" data-workspace-index="${index}">`;
            html += '<div class="card-body">';
            html += `<h6 class="mb-2"><i class="bi bi-folder-fill text-primary"></i> ${escapeHtml(insight.workspace.name)}</h6>`;
            html += `<p class="mb-2" id="retros-count-${index}"><strong>Retros Completed:</strong> <span class="typewriter-text"></span></p>`;
            html += `<p class="mb-2 text-muted" id="summary-${index}"><strong>Summary:</strong> <span class="typewriter-text"></span></p>`;
            html += `<div class="mb-2" id="actions-${index}"></div>`;
            html += `<div class="mt-2 p-2 bg-light rounded" id="recommendation-${index}"></div>`;
            html += '</div></div>';
          });
          html += '</div>';
          insightsEl.innerHTML = html;
          
          // Now populate each card with typewriter effect
          for (let i = 0; i < workspaceInsights.length; i++) {
            const insight = workspaceInsights[i];
            
            // Type Retros Completed
            await typewriterEffect(`retros-count-${i}`, `${insight.completedCount} of ${insight.totalRetros}`, 20);
            await new Promise(r => setTimeout(r, 100));
            
            // Type Summary
            await typewriterEffect(`summary-${i}`, insight.summary, 15);
            await new Promise(r => setTimeout(r, 200));
            
            // Show Action Items
            const actionsEl = document.getElementById(`actions-${i}`);
            if (insight.pendingActions.length > 0) {
              let actionsHtml = `<strong>Action Items to Complete:</strong><ul class="mb-0 mt-1">`;
              for (const action of insight.pendingActions.slice(0, 5)) {
                const isOverdue = insight.overdueActions.some(a => a.id === action.id);
                const dueDateText = action.due_date ? ` (Due: ${new Date(action.due_date).toLocaleDateString()})` : '';
                const overdueBadge = isOverdue ? ' <span class="badge bg-danger">Overdue</span>' : '';
                actionsHtml += `<li>${escapeHtml(action.title || action.description || 'Untitled')}${dueDateText}${overdueBadge}</li>`;
              }
              if (insight.pendingActions.length > 5) {
                actionsHtml += `<li class="text-muted"><em>...and ${insight.pendingActions.length - 5} more</em></li>`;
              }
              actionsHtml += '</ul>';
              actionsEl.innerHTML = actionsHtml;
            } else {
              actionsEl.innerHTML = '<p class="mb-2 text-success"><strong>Action Items:</strong> All completed! </p>';
            }
            await new Promise(r => setTimeout(r, 150));
            
            // Type Recommendation
            const recHtml = `<strong><i class="bi bi-activity text-primary"></i> Recommendation:</strong> <span class="typewriter-text"></span>`;
            document.getElementById(`recommendation-${i}`).innerHTML = recHtml;
            await typewriterEffect(`recommendation-${i}`, insight.recommendation, 15);
            await new Promise(r => setTimeout(r, 150));
          }
        }

        // Cache the generated insights HTML and hash
        try {
          localStorage.setItem(cacheKey, insightsEl.innerHTML);
          localStorage.setItem(hashKey, dataHash);
        } catch (e) {
          console.warn('Failed to cache insights:', e);
        }
      } catch (error) {
        console.error('Error generating insights:', error);
        insightsEl.innerHTML = '<p class="text-muted">Complete retrospectives to see AI-powered insights and patterns.</p>';
      }
    }
    
    function showCreateWorkspaceModal() {
      const modal = document.getElementById('workspaceModal') || createWorkspaceModal();
      modal.style.display = 'flex';
    }
    
    function createWorkspaceModal() {
      const modal = document.createElement('div');
      modal.id = 'workspaceModal';
      modal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;';
      modal.innerHTML = `
        <div style="background:white; padding:28px; border-radius:15px; max-width:520px; width:92%; position:relative;">
          <button aria-label="Close" onclick="document.getElementById('workspaceModal').style.display='none'" style="position:absolute; top:10px; right:12px; font-size:22px; background:none; border:none; cursor:pointer; color:#333">&times;</button>
          <h3 style="color:#667eea; margin-bottom:16px;">Create Your Workspace</h3>
          <p style="color:#666; margin-bottom:20px;">A workspace is required to use YodaAI. Create one now!</p>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Workspace Name *</label>
            <input type="text" id="workspaceName" placeholder="e.g., Engineering Team" 
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Description</label>
            <textarea id="workspaceDesc" placeholder="What is this workspace for?" 
                      style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; min-height:80px;"></textarea>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Your Role *</label>
            <select id="workspaceRole" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
              <option value="Scrum Master">Scrum Master</option>
              <option value="Project Manager">Project Manager</option>
            </select>
            <div style="font-size:12px; color:#777; margin-top:6px;">Only Scrum Master and Project Manager can create a workspace.</div>
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Upload Reference PDF (optional)</label>
            <input type="file" id="workspacePdf" accept="application/pdf" style="width:100%;">
            <div style="font-size:12px; color:#777; margin-top:6px;">This document will be referenced during chats.</div>
          </div>
          
          <div style="display:flex; gap:10px;">
            <button id="createWorkspaceBtn" onclick="createWorkspace()" class="btn btn-primary" style="flex:1;">
              <i class="bi bi-plus-circle"></i> Create Workspace
            </button>
          </div>
          
          <div id="workspaceError" style="display:none; margin-top:15px; padding:10px; background:#fee; border-radius:5px; color:#c00;"></div>
        </div>
      `;
      document.body.appendChild(modal);
      return modal;
    }
    
    async function createWorkspace() {
      const name = document.getElementById('workspaceName').value.trim();
      const description = document.getElementById('workspaceDesc').value.trim();
      const role = document.getElementById('workspaceRole').value;
      const pdfInput = document.getElementById('workspacePdf');
      
      if (!name) {
        document.getElementById('workspaceError').textContent = 'Please enter a workspace name';
        document.getElementById('workspaceError').style.display = 'block';
        return;
      }
      
      // Validate role
      const allowedRoles = ["Scrum Master", "Project Manager"];
      if (!allowedRoles.includes(role)) {
        document.getElementById('workspaceError').textContent = 'Only Scrum Master or Project Manager can create a workspace';
        document.getElementById('workspaceError').style.display = 'block';
        return;
      }
      
      // Show loading state
      const btn = document.getElementById('createWorkspaceBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
      
      try {
        const response = await fetch('/api/v1/workspaces/', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: name,
            description: description,
            your_role: role
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to create workspace');
        }
        
        const workspace = await response.json();
        currentWorkspace = workspace;
        userWorkspaces.push(workspace);
        localStorage.setItem('current_workspace', JSON.stringify(workspace));
        renderWorkspaceList();
        
        // If PDF selected, upload it now
        if (pdfInput && pdfInput.files && pdfInput.files[0]) {
          try {
            const fd = new FormData();
            fd.append('file', pdfInput.files[0]);
            const up = await fetch(`/api/v1/workspaces/${workspace.id}/upload-pdf`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${authToken}` },
              body: fd
            });
            if (!up.ok) {
              const er = await up.json().catch(() => ({}));
              console.warn('PDF upload failed:', er.detail || up.statusText);
            }
          } catch (e) {
            console.warn('PDF upload error:', e);
          }
        }

        document.getElementById('workspaceModal').style.display = 'none';
        
        // Clear form contents
        document.getElementById('workspaceName').value = '';
        document.getElementById('workspaceDesc').value = '';
        document.getElementById('workspacePdf').value = '';
        
        showToast(`Workspace "${workspace.name}" created successfully!`, 'success');
        
        // Show retrospective creation next
        setTimeout(() => {
          showToast('Now create your first retrospective!', 'info');
        }, 1500);
        
      } catch (error) {
        console.error('Create workspace error:', error);
        document.getElementById('workspaceError').textContent = error.message;
        document.getElementById('workspaceError').style.display = 'block';
      } finally {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    // ==================== RETROSPECTIVE CREATION ====================
    
    function showCreateRetroModal() {
      if (!currentWorkspace) {
        showToast('Please create a workspace first!', 'warning');
        showCreateWorkspaceModal();
        return;
      }
      
      const modal = document.getElementById('retroModal') || createRetroModal();
      modal.style.display = 'flex';
    }
    
    function createRetroModal() {
      const modal = document.createElement('div');
      modal.id = 'retroModal';
      modal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;';
      modal.innerHTML = `
        <div style="background:white; padding:40px; border-radius:15px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; -webkit-overflow-scrolling:touch;">
          <h3 style="color:#667eea; margin-bottom:20px;">Create Retrospective</h3>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Title *</label>
            <input type="text" id="retroTitle" placeholder="e.g., Sprint 23 Retrospective" 
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Sprint Name *</label>
            <input type="text" id="retroSprintName" placeholder="e.g., Sprint 23" 
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Description</label>
            <textarea id="retroDescription" placeholder="Optional description" 
                      style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; min-height:60px;"></textarea>
          </div>
          
          <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div style="flex:2;">
              <label style="display:block; margin-bottom:5px; font-weight:600;">Date & Time *</label>
              <input type="datetime-local" id="retroDateTime" 
                     style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
            </div>
            <div style="flex:1;">
              <label style="display:block; margin-bottom:5px; font-weight:600;">Duration (minutes) *</label>
              <input type="number" min="15" step="5" value="60" id="retroDuration" 
                     style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
            </div>
          </div>

          <div style="margin-bottom:15px; padding:12px; border:1px solid #eee; border-radius:8px;">
            <div style="font-weight:600; margin-bottom:8px;">Automated Reminders</div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="remindWeek" checked>
              <label class="form-check-label" for="remindWeek">1 week before</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="remindDay" checked>
              <label class="form-check-label" for="remindDay">24 hours before</label>
            </div>
            <div class="mt-2">
              <label style="display:block; margin-bottom:5px; font-weight:600;">Reminder Subject (optional)</label>
              <input type="text" id="reminderSubject" placeholder="e.g., Upcoming Retrospective: {{title}}" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
            </div>
            <div class="mt-2">
              <label style="display:block; margin-bottom:5px; font-weight:600;">Reminder Message (optional)</label>
              <textarea id="reminderMessage" placeholder="Customize the message shown in reminders" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; min-height:60px;"></textarea>
            </div>
          </div>
          
          <div style="display:flex; gap:10px;">
            <button onclick="closeRetroModal()" class="btn btn-secondary" style="flex:1;">
              Cancel
            </button>
            <button id="createRetroBtn" onclick="createRetrospective()" class="btn btn-primary" style="flex:1;">
              <i class="bi bi-calendar-check"></i> Create Retrospective
            </button>
          </div>
          
          <div id="retroError" style="display:none; margin-top:15px; padding:10px; background:#fee; border-radius:5px; color:#c00;"></div>
        </div>
      `;
      document.body.appendChild(modal);
      return modal;
    }
    
    function closeRetroModal() {
      const modal = document.getElementById('retroModal');
      if (modal) modal.style.display = 'none';
    }
    
    async function createRetrospective() {
      const title = document.getElementById('retroTitle').value.trim();
      const sprintName = document.getElementById('retroSprintName').value.trim();
      const description = document.getElementById('retroDescription').value.trim();
      const dateTime = document.getElementById('retroDateTime').value;
      const durationMinutes = parseInt(document.getElementById('retroDuration').value || '60', 10);
      const remindWeek = document.getElementById('remindWeek').checked;
      const remindDay = document.getElementById('remindDay').checked;
      const reminderSubject = document.getElementById('reminderSubject').value.trim();
      const reminderMessage = document.getElementById('reminderMessage').value.trim();
      
      if (!title || !sprintName || !dateTime || !durationMinutes) {
        document.getElementById('retroError').textContent = 'Please fill in all required fields';
        document.getElementById('retroError').style.display = 'block';
        return;
      }
      
      if (!currentWorkspace) {
        showToast('Please create a workspace first!', 'warning');
        closeRetroModal();
        showCreateWorkspaceModal();
        return;
      }
      
      // Show loading state
      const btn = document.getElementById('createRetroBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
      
      try {
        // Compute start/end times
        const startIso = new Date(dateTime).toISOString();
        const endIso = new Date(new Date(dateTime).getTime() + durationMinutes * 60000).toISOString();

        const response = await fetch('/api/v1/retrospectives/', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            workspace_id: currentWorkspace.id,
            title: title,
            sprint_name: sprintName,
            description: description,
            scheduled_start_time: startIso,
            scheduled_end_time: endIso
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to create retrospective');
        }
        
        const retro = await response.json();
        
        // Also schedule automated reminders (populate existing tables)
        try {
          await fetch('/api/v1/scheduling/schedule', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title: title,
              team_id: currentWorkspace.id,
              scheduled_date: startIso,
              description: description,
              duration_minutes: durationMinutes,
              send_1_week_reminder: remindWeek,
              send_24_hour_reminder: remindDay,
              reminder_subject: reminderSubject || null,
              reminder_message: reminderMessage || null
            })
          });
        } catch (e) {
          // non-blocking
        }
        currentRetrospective = retro;
        
        closeRetroModal();
        
        // Check if scheduled time has arrived
        const scheduledStartTime = new Date(retro.scheduled_start_time);
        const now = new Date();
        
        if (now >= scheduledStartTime) {
          // Start immediately
          showToast(`Retrospective "${retro.title}" created! Starting now...`, 'success');
          setTimeout(() => startRetro(retro.id), 1000);
        } else {
          // Show countdown
          const timeUntilStart = scheduledStartTime - now;
          const hours = Math.floor(timeUntilStart / (1000 * 60 * 60));
          const minutes = Math.floor((timeUntilStart % (1000 * 60 * 60)) / (1000 * 60));
          
          showToast(`Retrospective "${retro.title}" created! Starting in ${hours}h ${minutes}m`, 'success');
          
          // Store for later
          localStorage.setItem('pending_retro', JSON.stringify(retro));
          
          // Redirect to dashboard
          showSection('dashboard');
        }
        
      } catch (error) {
        console.error('Create retro error:', error);
        document.getElementById('retroError').textContent = error.message;
        document.getElementById('retroError').style.display = 'block';
      } finally {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    async function startRetro(retroId) {
      try {
        // Start the retrospective
        const response = await fetch(`/api/v1/retrospectives/${retroId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showToast('Retrospective started! Redirecting...', 'success');
          // Get retrospective code and navigate to retrospective.html
          const retroResponse = await fetch(`/api/v1/retrospectives/${retroId}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (retroResponse.ok) {
            const retroData = await retroResponse.json();
            // Navigate to retrospective with code
            window.location.href = `/retrospective/${retroData.code}`;
          } else {
            // Fallback: try to open retrospective
            openRetrospective(retroId);
          }
        }
      } catch (error) {
        console.error('Start retro error:', error);
        showToast('Failed to start retrospective', 'danger');
      }
    }
    
    // ==================== 4LS CHAT WITH PROGRESS SIDEBAR ====================
    
    async function start4LsChat(retroId) {
      try {
        const response = await fetch('/api/v1/fourls-chat/start?retrospective_id=' + retroId, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          if (response.status === 403 && err && err.detail && err.detail.not_started_until) {
            const until = new Date(err.detail.not_started_until);
            // Show countdown and retry starting automatically at time
            showCountdownBanner(until, () => start4LsChat(retroId));
            return;
          }
          throw new Error((err && (err.detail?.message || err.detail)) || 'Failed to start chat');
        }
        
        const data = await response.json();
        currentChatSession = data.session_id;
        
        // Show 4Ls Chat Interface
        show4LsChatInterface(retroId);
        
      } catch (error) {
        console.error('Start 4Ls chat error:', error);
        showToast('Failed to start chat. Please try again.', 'danger');
      }
    }
    
    function show4LsChatInterface(retroId) {
      // Show retrospectives section
      showSection('retrospectives');
      
      // Hide start button, show chat interface
      document.getElementById('retroStartSection').style.display = 'none';
      document.getElementById('retroChatSection').style.display = 'block';
      
      // Load chat session
      loadChatSession();
    }
    
    async function loadChatSession() {
      if (!currentChatSession) return;
      
      try {
        const response = await fetch(`/api/v1/fourls-chat/${currentChatSession}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update progress with current category
          updateRetroProgressSidebar(data.progress, data.current_category);
          
          // Display messages
          const messagesDiv = document.getElementById('retroChatMessages');
          messagesDiv.innerHTML = '';
          
          data.messages.forEach(msg => {
            addRetroMessage(msg.content, msg.message_type);
          });
        } else {
          const err = await response.json().catch(() => ({}));
          if (response.status === 403 && err && err.detail && err.detail.not_started_until) {
            const until = new Date(err.detail.not_started_until);
            disableRetroInput(true);
            showCountdownBanner(until, () => {
              disableRetroInput(false);
              loadChatSession();
            });
          }
        }
      } catch (error) {
        console.error('Load chat session error:', error);
      }
    }
    
    function updateRetroProgressSidebar(progress, currentCategory = null) {
      progressData = progress;
      
      // Progress sidebar was removed - this function kept for compatibility
      // No longer updates any UI elements since sidebar is gone
    }
    
    function addRetroMessage(message, type) {
      const messagesDiv = document.getElementById('retroChatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const icon = type === 'user' ? 
        '<i class="bi bi-person-circle"></i>' : 
        '<i class="bi bi-robot"></i>';
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${icon}</div>
        <div class="message-content">${message}</div>
      `;
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    async function sendRetroMessage() {
      const input = document.getElementById('retroChatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Show loading state
      const btn = document.getElementById('sendRetroBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
      
      addRetroMessage(message, 'user');
      input.value = '';
      
      try {
        const response = await fetch(`/api/v1/fourls-chat/${currentChatSession}/message`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: message })  // FIXED: Send as object with 'message' key
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Display AI response
          addRetroMessage(data.message, 'assistant');
          
          // Update progress with current category
          updateRetroProgressSidebar(data.progress, data.current_category);
          
          // Check if all completed
          if (data.is_completed) {
            showToast('All categories completed! Click "Finish & Proceed" to continue.', 'success');
          }
        } else {
          const error = await response.json().catch(() => ({}));
          if (response.status === 403 && error && error.detail && error.detail.not_started_until) {
            const until = new Date(error.detail.not_started_until);
            addRetroMessage('Retrospective not started yet. I will be available when the timer ends.', 'assistant');
            disableRetroInput(true);
            showCountdownBanner(until, () => {
              disableRetroInput(false);
              addRetroMessage('We can start now. Please send your message again.', 'assistant');
            });
          } else {
            console.error('API error:', error);
            addRetroMessage('Sorry, I encountered an error: ' + (error.detail || 'Unknown error'), 'assistant');
          }
        }
      } catch (error) {
        console.error('Send message error:', error);
        addRetroMessage('Sorry, I encountered an error. Please try again.', 'assistant');
      } finally {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    async function finishRetroAndProceed() {
      // Show loading state
      const btn = document.getElementById('retroFinishButton');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Finishing...';
      
      try {
        await fetch(`/api/v1/fourls-chat/${currentChatSession}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        showToast('Input complete! Moving to grouping phase...', 'success');
        
        // Move to grouping - show in main area
        setTimeout(() => showGroupingInMain(currentRetrospective.id), 1000);
        
      } catch (error) {
        console.error('Finish chat error:', error);
      } finally {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    function focusRetroCategory(category) {
      // Progress sidebar was removed - this function kept for compatibility
      // No longer updates any UI elements since sidebar is gone
    }

    // ==================== RETRO SCHEDULING GATE HELPERS ====================
    function disableRetroInput(disabled) {
      const input = document.getElementById('retroChatInput');
      const btn = document.getElementById('sendRetroBtn');
      if (input) input.disabled = disabled;
      if (btn) btn.disabled = disabled;
    }

    function showCountdownBanner(untilDate, onReady) {
      let banner = document.getElementById('retroCountdownBanner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'retroCountdownBanner';
        banner.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3 shadow';
        banner.style.zIndex = '9999';
        banner.innerHTML = `
          <i class="bi bi-clock"></i>
          <span id="retroCountdownText">Retrospective starts soon...</span>
        `;
        document.body.appendChild(banner);
      }

      const textEl = banner.querySelector('#retroCountdownText');
      const intervalId = setInterval(() => {
        const now = new Date();
        const diff = untilDate - now;
        if (diff <= 0) {
          clearInterval(intervalId);
          banner.remove();
          if (typeof onReady === 'function') onReady();
          return;
        }
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        const parts = [];
        if (hours > 0) parts.push(`${hours}h`);
        parts.push(`${minutes}m`, `${seconds}s`);
        textEl.textContent = `Retrospective starts in ${parts.join(' ')}. This will unlock automatically.`;
      }, 1000);
    }
    
    // NEW: Show grouping inline in chat area instead of overlay
    async function showGroupingInMain(retroId) {
      // Replace chat area with grouping interface
      const chatSection = document.getElementById('retroChatSection');
      const chatContainer = chatSection.querySelector('.card-body');
      
      chatContainer.innerHTML = `
        <div class="d-flex justify-content-between mb-3">
          <h5><i class="bi bi-diagram-3"></i> AI Theme Grouping</h5>
        </div>
        <p class="text-muted mb-4">AI will analyze all team responses and group them into meaningful themes.</p>
        
        <button id="generateGroupingBtn" onclick="generateGrouping(${retroId})" class="btn btn-primary btn-lg mb-4">
          <i class="bi bi-magic"></i> Generate AI Grouping
        </button>
        
        <div id="groupingResults">
          <!-- Themes will appear here -->
        </div>
      `;
      
      // Load any existing themes
      await loadGroupingResults(retroId);
    }
    
    function closeGroupingOverlay() {
      // No longer needed - keeping for compatibility
    }
    
    // ==================== AI GROUPING INTERFACE ====================
    
    async function showGroupingInterface(retroId) {
      const container = document.getElementById('appContainer');
      container.innerHTML = `
        <div style="padding:40px; max-width:1200px; margin:0 auto;">
          <h2 style="color:#667eea; margin-bottom:10px;">
            <i class="bi bi-diagram-3"></i> AI Theme Grouping
          </h2>
          <p style="color:#666; margin-bottom:30px;">AI will analyze all team responses and group them into meaningful themes.</p>
          
          <button id="generateGroupingBtn" onclick="generateGrouping(${retroId})" class="btn btn-primary btn-lg mb-4">
            <i class="bi bi-magic"></i> Generate AI Grouping
          </button>
          
          <div id="groupingResults" style="margin-top:30px;">
            <!-- Themes will appear here -->
          </div>
        </div>
      `;
      
      // Load any existing themes
      await loadGroupingResults(retroId);
    }
    
    async function generateGrouping(retroId) {
      // Show loading state
      const btn = document.getElementById('generateGroupingBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
      
      showToast('Generating AI grouping... This may take a moment.', 'info');
      
      try {
        const response = await fetch(`/api/v1/grouping/${retroId}/generate`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Grouping failed');
        
        const data = await response.json();
        showToast(`Created ${data.groups_created} theme groups!`, 'success');
        
        // Load and display grouping results with retry (handles DB commit delay)
        await loadGroupingResultsWithRetry(retroId, 5, 600);
        
      } catch (error) {
        console.error('Generate grouping error:', error);
        showToast('Failed to generate grouping. Please try again.', 'danger');
      } finally {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    async function loadGroupingResultsWithRetry(retroId, attempts = 5, delayMs = 600) {
      for (let i = 0; i < attempts; i++) {
        await loadGroupingResults(retroId);
        const container = document.getElementById('groupingResults');
        const hasThemes = container && container.querySelector('.theme-item');
        if (hasThemes) return; // success
        await new Promise(r => setTimeout(r, delayMs));
      }
      // Final fallback message if nothing rendered
      const container = document.getElementById('groupingResults');
      if (container && !container.querySelector('.theme-item')) {
        container.innerHTML = '<div class="alert alert-info">Themes are being prepared. Please try again in a moment.</div>';
      }
    }

    async function loadGroupingResults(retroId) {
      try {
        const response = await fetch(`/api/v1/grouping/${retroId}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error('Load grouping error:', error);
          const container = document.getElementById('groupingResults');
          if (container) {
            container.innerHTML = `<div class="alert alert-warning">Failed to load themes. Please try again.</div>`;
          }
          return;
        }
        
        const data = await response.json();
        displayGroupingResults(data, retroId);
        
      } catch (error) {
        console.error('Load grouping error:', error);
        const container = document.getElementById('groupingResults');
        if (container) {
          container.innerHTML = `<div class="alert alert-warning">Failed to load themes. Please try again.</div>`;
        }
      }
    }
    
    function displayGroupingResults(data, retroId) {
      const container = document.getElementById('groupingResults');
      
      // Group themes by primary_category
      const themesByCategory = {
        'liked': [],
        'learned': [],
        'lacked': [],
        'longed_for': []
      };
      
      data.theme_groups.forEach(theme => {
        const category = theme.primary_category || 'liked';
        if (themesByCategory[category]) {
          themesByCategory[category].push(theme);
        }
      });
      
      let html = '<div id="groupingContainer">';
      
      // Display themes grouped by 4Ls categories
      const categoryConfig = {
        'liked': { name: 'Liked', icon: 'heart-fill' },
        'learned': { name: 'Learned', icon: 'lightbulb-fill' },
        'lacked': { name: 'Lacked', icon: 'exclamation-triangle-fill' },
        'longed_for': { name: 'Longed For', icon: 'star-fill' }
      };
      
      Object.keys(categoryConfig).forEach(category => {
        const config = categoryConfig[category];
        const categoryThemes = themesByCategory[category];
        
        html += `
          <div class="fourls-category ${category === 'longed_for' ? 'longed' : category}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5><i class="bi bi-${config.icon}"></i> ${config.name}</h5>
              <button class="btn btn-sm btn-success" onclick="addTheme('${category}', ${retroId})">
                <i class="bi bi-plus"></i> Add Theme
              </button>
            </div>
            <div id="themes-${category}" class="themes-list">
              ${categoryThemes.map((theme, idx) => `
                <div class="theme-item" data-theme-id="${theme.id}" data-category="${category}">
                  <div class="flex-grow-1">
                    <strong>${escapeHtml(theme.title)}</strong>
                    ${theme.description ? `<br><small class="text-muted">${escapeHtml(theme.description)}</small>` : ''}
                  </div>
                  <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editTheme('${category}', ${theme.id}, ${retroId})" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <i class="bi bi-grip-vertical text-muted"></i>
                  </div>
                </div>
              `).join('')}
              ${categoryThemes.length === 0 ? '<p class="text-muted text-center py-3">No themes yet</p>' : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      html += `
        <button onclick="proceedToVoting(${retroId})" class="btn btn-primary btn-lg mt-4">
          <i class="bi bi-arrow-right"></i> Proceed to Voting
        </button>
      `;
      
      container.innerHTML = html;
      
      // Initialize drag and drop AFTER rendering
      setTimeout(() => {
        ['liked', 'learned', 'lacked', 'longed_for'].forEach(category => {
          const el = document.getElementById(`themes-${category}`);
          if (el) {
            new Sortable(el, {
              animation: 150,
              ghostClass: 'dragging',
              onEnd: function(evt) {
                saveThemeOrder(category, retroId);
              }
            });
          }
        });
      }, 100);
    }
    
    function addTheme(category, retroId) {
      const title = prompt('Enter theme title:');
      if (!title) return;
      const description = prompt('Enter theme description (optional):');
      createTheme(category, title, description || '', retroId);
    }
    
    async function createTheme(category, title, description, retroId) {
      try {
        const response = await fetch(`/api/v1/grouping/${retroId}/themes`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ category, title, description })
        });
        if (response.ok) {
          await loadGroupingResults(retroId);
          showToast('Theme added successfully', 'success');
        }
      } catch (error) {
        console.error('Create theme error:', error);
        showToast('Failed to add theme', 'danger');
      }
    }
    
    function editTheme(category, themeId, retroId) {
      // Get current theme data
      const themeContainer = document.querySelector(`[data-theme-id="${themeId}"]`);
      if (!themeContainer) return;
      
      const titleEl = themeContainer.querySelector('strong');
      const descEl = themeContainer.querySelector('small');
      
      const currentTitle = titleEl ? titleEl.textContent : '';
      const currentDesc = descEl ? descEl.textContent : '';
      
      const newTitle = prompt('Edit theme title:', currentTitle);
      if (!newTitle) return;
      const newDescription = prompt('Edit theme description:', currentDesc);
      updateTheme(themeId, newTitle, newDescription || '', retroId);
    }
    
    async function updateTheme(themeId, title, description, retroId) {
      try {
        const response = await fetch(`/api/v1/grouping/theme/${themeId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, description })
        });
        if (response.ok) {
          await loadGroupingResults(retroId);
          showToast('Theme updated successfully', 'success');
        }
      } catch (error) {
        console.error('Update theme error:', error);
        showToast('Failed to update theme', 'danger');
      }
    }
    
    async function saveThemeOrder(category, retroId) {
      const container = document.getElementById(`themes-${category}`);
      if (!container) return;
      
      const themeIds = Array.from(container.children)
        .map(el => el.dataset.themeId)
        .filter(id => id);
      
      try {
        await fetch(`/api/v1/grouping/${retroId}/themes/reorder`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ category, theme_ids: themeIds })
        });
      } catch (error) {
        console.error('Save theme order error:', error);
      }
    }
    
    async function deleteTheme(themeId, retroId) {
      if (!confirm('Delete this theme? Responses will become ungrouped.')) return;
      
      try {
        const response = await fetch(`/api/v1/grouping/theme/${themeId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showToast('Theme deleted', 'success');
          loadGroupingResults(retroId);
        }
      } catch (error) {
        console.error('Delete theme error:', error);
      }
    }
    
    // ==================== VOTING SYSTEM ====================
    
    // Global state for pending votes (not yet submitted to server)
    let pendingVotes = {}; // {theme_id: vote_count}
    let votesSubmitted = false;
    
    async function proceedToVoting(retroId) {
      try {
        // Start voting session
        await fetch(`/api/v1/voting/${retroId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        showVotingInterface(retroId);
        
      } catch (error) {
        console.error('Start voting error:', error);
      }
    }
    
    async function showVotingInterface(retroId) {
      // Initialize voting state
      pendingVotes = {};
      votesSubmitted = false;
      
      // Replace chat area with voting interface
      const chatSection = document.getElementById('retroChatSection');
      const chatContainer = chatSection.querySelector('.card-body');
      
      chatContainer.innerHTML = `
        <div class="d-flex justify-content-between mb-3">
          <h5><i class="bi bi-hand-thumbs-up"></i> Vote on Themes</h5>
        </div>
        <p class="text-muted mb-4">You have 10 votes to allocate to the most important themes. <strong>Your votes won't be saved until you click Submit.</strong></p>
        
        <div id="voteCounter" class="card mb-4">
          <div class="card-body text-center">
            <h4 class="mb-0">Votes: <span id="votesUsed">0</span>/10 allocated</h4>
            <small class="text-muted" id="voteStatus">Draft mode - not submitted</small>
          </div>
        </div>
        
        <div id="votingThemes">
          <!-- Loading themes... -->
        </div>
        
        <div class="mt-4 mb-3">
          <button id="submitVotesBtn" onclick="submitAllVotes(${retroId})" class="btn btn-primary btn-lg w-100" disabled>
            <i class="bi bi-send"></i> Submit All Votes (<span id="totalPendingVotes">0</span>/10)
          </button>
        </div>
        
        <div id="votingResults" class="mt-4">
          <!-- Results will appear here -->
        </div>
      `;
      
      loadVotingStatus(retroId);
    }
    
    async function loadVotingStatus(retroId) {
      try {
        const response = await fetch(`/api/v1/voting/${retroId}/status`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) return;
        
        const data = await response.json();
        
        // If user already submitted votes, show server data
        if (votesSubmitted) {
          displaySubmittedVotingInterface(data, retroId);
          return;
        }
        
        // Display themes with local vote tracking
        const themesDiv = document.getElementById('votingThemes');
        let html = '';
        
        data.theme_votes.forEach(theme => {
          const pendingCount = pendingVotes[theme.theme_id] || 0;
          html += `
            <div class="card mb-3">
              <div class="card-body">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div style="flex:1;">
                    <h5 style="color:#667eea; margin:0 0 5px 0;">${escapeHtml(theme.theme_title)}</h5>
                    <p style="color:#666; margin:0;">${escapeHtml(theme.theme_description)}</p>
                  </div>
                  <div style="text-align:center; margin-left:20px;">
                    <div style="font-size:20px; font-weight:bold; color:#667eea;">${theme.total_votes}</div>
                    <div style="font-size:12px; color:#888;">total votes</div>
                  </div>
                </div>
                <div style="margin-top:15px; display:flex; align-items:center; gap:10px;">
                  <button onclick="adjustLocalVote(${retroId}, ${theme.theme_id}, 1)" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> +1
                  </button>
                  <button onclick="adjustLocalVote(${retroId}, ${theme.theme_id}, -1)" class="btn btn-sm btn-outline-secondary" ${pendingCount === 0 ? 'disabled' : ''}>
                    <i class="bi bi-dash"></i> -1
                  </button>
                  <span style="color:#666; margin-left:10px;">
                    <strong id="pending-${theme.theme_id}">${pendingCount}</strong> pending
                  </span>
                </div>
              </div>
            </div>
          `;
        });
        
        themesDiv.innerHTML = html;
        
        // Update button state
        updateSubmitButton();
        
      } catch (error) {
        console.error('Load voting status error:', error);
      }
    }
    
    function displaySubmittedVotingInterface(data, retroId) {
      // User has submitted, show read-only view with server data
      const chatSection = document.getElementById('retroChatSection');
      const chatContainer = chatSection.querySelector('.card-body');
      
      // Show coffee cup wait page if not all participants have voted
      if (!data.all_participants_voted) {
        chatContainer.innerHTML = `
          <div class="text-center py-5">
            <div style="font-size: 8rem; animation: float 3s ease-in-out infinite;">
              
            </div>
            <h3 class="mt-4 mb-3" style="color: #667eea;">Grab a Coffee While the Votes Are Being Collected</h3>
            <p class="text-muted mb-4">
              You've submitted your votes! Waiting for other participants to complete their voting.
            </p>
            <div class="alert alert-info d-inline-block">
              <i class="bi bi-people"></i> 
              <strong>${data.participants_who_voted}/${data.total_participants}</strong> participants have voted
            </div>
            <div class="progress mt-3" style="height: 25px; max-width: 400px; margin: 20px auto;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                   role="progressbar" 
                   style="width: ${(data.participants_who_voted / data.total_participants) * 100}%"
                   aria-valuenow="${data.participants_who_voted}" 
                   aria-valuemin="0" 
                   aria-valuemax="${data.total_participants}">
                ${Math.round((data.participants_who_voted / data.total_participants) * 100)}%
              </div>
            </div>
            <p class="text-muted mt-4">
              <small>This page will automatically refresh when everyone has voted</small>
            </p>
          </div>
        `;
        
        // Auto-refresh every 5 seconds
        setTimeout(() => {
          loadVotingStatus(retroId);
        }, 5000);
        return;
      }
      
      // All participants voted - show summary
      let html = `
        <div class="d-flex justify-content-between mb-3">
          <h5><i class="bi bi-hand-thumbs-up"></i> Your Votes (Submitted)</h5>
        </div>
        <div class="alert alert-success">
          <i class="bi bi-check-circle"></i> All participants have completed voting!
        </div>
      `;
      
      data.theme_votes.forEach(theme => {
        if (theme.my_votes > 0) {
          html += `
            <div class="card mb-2">
              <div class="card-body">
                <h6 style="color:#667eea; margin:0;">${escapeHtml(theme.theme_title)}</h6>
                <p class="mb-0"><strong>Your votes:</strong> ${theme.my_votes}</p>
              </div>
            </div>
          `;
        }
      });
      
      chatContainer.innerHTML = html;
    }
    
    function adjustLocalVote(retroId, themeId, delta) {
      // Update local pending votes
      pendingVotes[themeId] = (pendingVotes[themeId] || 0) + delta;
      
      if (pendingVotes[themeId] <= 0) {
        delete pendingVotes[themeId];
      }
      
      // Update UI
      const pendingElement = document.getElementById(`pending-${themeId}`);
      if (pendingElement) {
        pendingElement.textContent = pendingVotes[themeId] || 0;
      }
      
      // Update counter and button
      updateVoteCounter();
      updateSubmitButton();
      
      // Re-enable/decrease buttons
      const card = document.querySelector(`[onclick*="${themeId}"].card`);
      if (card) {
        const decreaseBtn = card.querySelector('[onclick*="-1"]');
        if (decreaseBtn) {
          decreaseBtn.disabled = (pendingVotes[themeId] || 0) === 0;
        }
      }
    }
    
    function updateVoteCounter() {
      const total = Object.values(pendingVotes).reduce((sum, v) => sum + v, 0);
      const votesUsedEl = document.getElementById('votesUsed');
      if (votesUsedEl) {
        votesUsedEl.textContent = total;
      }
      const totalPendingEl = document.getElementById('totalPendingVotes');
      if (totalPendingEl) {
        totalPendingEl.textContent = total;
      }
    }
    
    function updateSubmitButton() {
      const total = Object.values(pendingVotes).reduce((sum, v) => sum + v, 0);
      const submitBtn = document.getElementById('submitVotesBtn');
      if (submitBtn) {
        submitBtn.disabled = total === 0 || total > 10;
      }
      
      const statusEl = document.getElementById('voteStatus');
      if (statusEl) {
        if (total === 0) {
          statusEl.textContent = 'No votes allocated yet';
          statusEl.className = 'text-muted';
        } else if (total > 10) {
          statusEl.textContent = `Too many votes! (${total}/10)`;
          statusEl.className = 'text-danger';
        } else {
          statusEl.textContent = `Draft mode - ${total}/10 votes allocated`;
          statusEl.className = 'text-warning';
        }
      }
    }
    
    async function submitAllVotes(retroId) {
      const total = Object.values(pendingVotes).reduce((sum, v) => sum + v, 0);
      
      if (total === 0) {
        showToast('Please allocate at least one vote', 'warning');
        return;
      }
      
      if (total > 10) {
        showToast('You cannot allocate more than 10 votes', 'danger');
        return;
      }
      
      // Prepare batch request
      const allocations = Object.entries(pendingVotes).map(([theme_id, votes]) => ({
        theme_group_id: parseInt(theme_id),
        votes: votes
      }));
      
      try {
        const response = await fetch(`/api/v1/voting/${retroId}/submit-votes`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            allocations: allocations
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          showToast(data.message, 'success');
          
          // Mark as submitted
          votesSubmitted = true;
          
          // Reload voting status (will show submitted view)
          loadVotingStatus(retroId);
        } else {
          const error = await response.json();
          showToast(error.detail || 'Failed to submit votes', 'danger');
        }
      } catch (error) {
        console.error('Submit votes error:', error);
        showToast('Failed to submit votes', 'danger');
      }
    }
    
    function displayVotingResults(themes) {
      const resultsDiv = document.getElementById('votingResults');
      
      const sorted = [...themes].sort((a, b) => b.total_votes - a.total_votes);
      
      let html = `
        <h4 style="color:#667eea; margin-bottom:20px;">
          <i class="bi bi-trophy"></i> Voting Results (Top Themes for Discussion)
        </h4>
        <div class="list-group">
      `;
      
      sorted.forEach((theme, idx) => {
        if (theme.total_votes >= 3) {  // Min votes for discussion
          html += `
            <div class="list-group-item" style="border-left:4px solid #28a745;">
              <div style="display:flex; justify-content:between; align-items:center;">
                <div style="flex:1;">
                  <h6 style="margin:0; color:#28a745;">#${idx + 1}. ${escapeHtml(theme.theme_title)}</h6>
                  <small style="color:#666;">${theme.total_votes} votes</small>
                </div>
                <span class="badge bg-success">Will Discuss</span>
              </div>
            </div>
          `;
        }
      });
      
      html += '</div>';
      resultsDiv.innerHTML = html;
    }
    
    async function castVote(retroId, themeId, votes) {
      try {
        const response = await fetch(`/api/v1/voting/${retroId}/vote`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            theme_group_id: themeId,
            votes: votes
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          showToast(data.message, 'success');
          
          // Reload voting status
          loadVotingStatus(retroId);
        } else {
          const error = await response.json();
          showToast(error.detail, 'danger');
        }
      } catch (error) {
        console.error('Cast vote error:', error);
        showToast('Failed to cast vote', 'danger');
      }
    }
    
    async function finalizeVoting(retroId) {
      try {
        const response = await fetch(`/api/v1/voting/${retroId}/finalize`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          showToast(`Voting finalized! ${data.discussion_topics_created} topics for discussion.`, 'success');
          
          // Move to discussion
          setTimeout(() => showDiscussionInterface(retroId), 1000);
        }
      } catch (error) {
        console.error('Finalize voting error:', error);
      }
    }
    
    // ==================== DISCUSSION INTERFACE ====================
    
    async function showDiscussionInterface(retroId) {
      // Replace chat area with discussion interface
      const chatSection = document.getElementById('retroChatSection');
      const chatContainer = chatSection.querySelector('.card-body');
      
      chatContainer.innerHTML = `
        <div class="d-flex justify-content-between mb-3">
          <h5><i class="bi bi-chat-quote"></i> Team Discussion</h5>
        </div>
        <p class="text-muted mb-4">Discuss the top-voted themes with your team and YodaAI.</p>
        
        <div id="discussionTopics">
          <!-- Loading topics... -->
        </div>
        
        <div class="da-recommendation mt-4">
          <h5 class="mb-3"><i class="bi bi-book"></i> DA Browser Recommendations</h5>
          <div id="daRecommendations" class="text-muted">Loading recommendations...</div>
        </div>
        
        <button onclick="proceedToSummary(${retroId})" class="btn btn-primary btn-lg mt-4 w-100">
          <i class="bi bi-arrow-right"></i> Proceed to Summary
        </button>
      `;
      
      loadDiscussionTopics(retroId);
      loadDARecommendations(retroId);
    }
    
    async function loadDiscussionTopics(retroId) {
      try {
        const response = await fetch(`/api/v1/discussion/${retroId}/topics`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) return;
        
        const topics = await response.json();
        const container = document.getElementById('discussionTopics');
        
        let html = '';
        topics.forEach(topic => {
          html += `
            <div class="card mb-3" style="border-left:4px solid ${topic.is_discussed ? '#28a745' : '#667eea'};">
              <div class="card-body">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                  <div>
                    <h5 style="color:#667eea; margin:0 0 5px 0;">
                      #${topic.rank}. ${escapeHtml(topic.theme_title)}
                    </h5>
                    <p style="color:#666; margin:0 0 10px 0;">${escapeHtml(topic.theme_description)}</p>
                    <span class="badge bg-primary">${topic.total_votes} votes</span>
                  </div>
                  ${topic.is_discussed ? 
                    '<span class="badge bg-success">Discussed </span>' : 
                    `<button onclick="startDiscussion(${topic.id})" class="btn btn-sm btn-primary">
                      <i class="bi bi-chat"></i> Discuss
                    </button>`
                  }
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Load discussion topics error:', error);
      }
    }
    
    async function startDiscussion(topicId) {
      // For MVP, show simple message
      showToast('Discussion started! In full version, this opens a team chat.', 'info');
    }
    
    async function loadDARecommendations(retroId) {
      try {
        const response = await fetch(`/api/v1/discussion/${retroId}/da-recommendations`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          document.getElementById('daRecommendations').innerHTML = 
            '<p class="text-muted">Unable to load recommendations at this time.</p>';
          return;
        }
        
        const data = await response.json();
        const recommendations = data.content || 'No specific recommendations available at this time.';
        
        // Display recommendations with formatting
        document.getElementById('daRecommendations').innerHTML = 
          `<div class="card border-start border-warning border-4">
            <div class="card-body">
              <div style="white-space: pre-wrap;">${escapeHtml(recommendations)}</div>
            </div>
          </div>`;
        
      } catch (error) {
        console.error('Load DA recommendations error:', error);
        document.getElementById('daRecommendations').innerHTML = 
          '<p class="text-muted">Unable to load recommendations at this time.</p>';
      }
    }
    
    // ==================== SUMMARY GENERATION ====================
    
    async function proceedToSummary(retroId) {
      showToast('Generating AI summary...', 'info');
      
      try {
        const response = await fetch(`/api/v1/discussion/${retroId}/generate-summary`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const summary = await response.json();
          showSummaryInterface(summary, retroId);
        }
      } catch (error) {
        console.error('Generate summary error:', error);
      }
    }
    
    function showSummaryInterface(summary, retroId) {
      // Replace chat area with summary interface
      const chatSection = document.getElementById('retroChatSection');
      const chatContainer = chatSection.querySelector('.card-body');
      
      chatContainer.innerHTML = `
        <div class="d-flex justify-content-between mb-3">
          <h5><i class="bi bi-file-text"></i> Sprint Summary</h5>
        </div>
        <p class="text-muted mb-4">AI-generated insights from your retrospective</p>
        
        <div class="card mb-4" style="border-left:4px solid #667eea;">
          <div class="card-body">
            <h5 style="color:#667eea;">
              <i class="bi bi-graph-up"></i> Overall Assessment - ${escapeHtml(summary.sprint_name || 'Current Sprint')}
            </h5>
            <p style="color:#555; line-height:1.6; margin-top:15px;">${escapeHtml(summary.summary)}</p>
          </div>
        </div>
        
        <div class="card mb-4" style="border-left:4px solid #28a745;">
          <div class="card-body">
            <h5 style="color:#28a745;">
              <i class="bi bi-trophy"></i> Top Achievements
            </h5>
            <ul style="margin-top:15px;">
              ${(summary.achievements || []).map(a => `<li style="margin:8px 0; color:#555;">${escapeHtml(a)}</li>`).join('')}
            </ul>
          </div>
        </div>
        
        <div class="card mb-4" style="border-left:4px solid #ffc107;">
          <div class="card-body">
            <h5 style="color:#ffc107;">
              <i class="bi bi-exclamation-triangle"></i> Main Challenges
            </h5>
            <ul style="margin-top:15px;">
              ${(summary.challenges || []).map(c => `<li style="margin:8px 0; color:#555;">${escapeHtml(c)}</li>`).join('')}
            </ul>
          </div>
        </div>
        
        <div class="card mb-4" style="border-left:4px solid #17a2b8;">
          <div class="card-body">
            <h5 style="color:#17a2b8;">
              <i class="bi bi-lightbulb"></i> Recommendations
            </h5>
            <ul style="margin-top:15px;">
              ${(summary.recommendations || []).map(r => `<li style="margin:8px 0; color:#555;">${escapeHtml(r)}</li>`).join('')}
            </ul>
          </div>
        </div>
        
        <div class="d-flex gap-2">
          <button onclick="downloadSummaryPDF(${retroId})" class="btn btn-primary btn-lg flex-fill">
            <i class="bi bi-download"></i> Download PDF Summary
          </button>
          <button onclick="completeRetrospective()" class="btn btn-success btn-lg flex-fill">
            <i class="bi bi-check-circle"></i> Complete Retrospective
          </button>
        </div>
      `;
    }
    
    async function downloadSummaryPDF(retroId) {
      try {
        const response = await fetch(`/api/v1/discussion/${retroId}/summary/pdf`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to download PDF');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sprint_summary_${retroId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('PDF downloaded successfully!', 'success');
      } catch (error) {
        console.error('Download PDF error:', error);
        showToast('Failed to download PDF', 'danger');
      }
    }
    
    function completeRetrospective() {
      showToast('Retrospective completed! Great work!', 'success');
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    }

    // ==================== ACTION ITEMS ====================
    
    let allActionItems = [];
    let currentActionFilter = 'all';

    async function loadActionItems() {
      if (!authToken) {
        const container = document.getElementById('actionItemsList');
        if (container) {
          container.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-lock text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-3">Please login to view action items</p>
            </div>
          `;
        }
        return;
      }

      try {
        const response = await fetch('/api/v1/action-items/', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          allActionItems = await response.json();
          displayActionItems(allActionItems);
        } else {
          throw new Error('Failed to load action items');
        }
      } catch (error) {
        console.error('Error loading action items:', error);
        const container = document.getElementById('actionItemsList');
        if (container) {
          container.innerHTML = `
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Failed to load action items. ${error.message}
            </div>
          `;
        }
      }
    }

    function displayActionItems(items) {
      const container = document.getElementById('actionItemsList');
      if (!container) return;
      
      if (!items || items.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-check2-square text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3">No action items yet. Create your first one!</p>
          </div>
        `;
        return;
      }

      let html = '<div class="list-group">';
      
      items.forEach(item => {
        const priorityBadge = {
          'low': 'success',
          'medium': 'warning', 
          'high': 'danger',
          'critical': 'dark'
        }[item.priority] || 'secondary';

        const statusBadge = {
          'pending': 'secondary',
          'in_progress': 'primary',
          'completed': 'success',
          'cancelled': 'warning',
          'blocked': 'danger'
        }[item.status] || 'secondary';

        const statusText = {
          'pending': 'Pending',
          'in_progress': 'In Progress',
          'completed': 'Completed',
          'cancelled': 'Cancelled',
          'blocked': 'Blocked'
        }[item.status] || item.status;

        const dueDate = item.due_date ? new Date(item.due_date).toLocaleDateString() : 'No due date';
        const isOverdue = item.due_date && new Date(item.due_date) < new Date() && item.status !== 'completed';
        
        const progress = item.progress_percentage || 0;
        let progressColor = 'danger';
        if (progress >= 75) progressColor = 'success';
        else if (progress >= 50) progressColor = 'info';
        else if (progress >= 25) progressColor = 'warning';

        html += `
          <div class="list-group-item ${item.status === 'completed' ? 'bg-light' : ''}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1 ${item.status === 'completed' ? 'text-decoration-line-through text-muted' : ''}">
                  ${escapeHtml(item.title)}
                </h6>
                ${item.description ? `<p class="mb-2 text-muted small">${escapeHtml(item.description)}</p>` : ''}
                <div class="d-flex gap-2 flex-wrap mb-2">
                  <span class="badge bg-${priorityBadge}">${item.priority.toUpperCase()}</span>
                  <span class="badge bg-${statusBadge}">${statusText}</span>
                  <span class="badge bg-info ${isOverdue ? 'bg-danger' : ''}">
                    <i class="bi bi-calendar me-1"></i>${dueDate}
                  </span>
                </div>
                ${progress > 0 ? `
                  <div class="mt-2">
                    <small class="text-muted">Progress:</small>
                    <div class="progress" style="height: 8px; margin-top: 4px;">
                      <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                        <span class="visually-hidden">${progress}%</span>
                      </div>
                    </div>
                    <small class="text-muted">${progress}% complete</small>
                  </div>
                ` : ''}
              </div>
              <div class="btn-group ms-3">
                ${item.status !== 'completed' ? `
                  <button class="btn btn-sm btn-success" onclick="markActionItemComplete(${item.id})" title="Mark as complete">
                    <i class="bi bi-check-lg"></i>
                  </button>
                ` : ''}
                <button class="btn btn-sm btn-primary" onclick="editActionItem(${item.id})" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteActionItem(${item.id})" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function filterActionItems(status) {
      currentActionFilter = status;
      
      // Update active tab
      document.querySelectorAll('#actionItemTabs .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      const event = window.event || arguments[0];
      if (event && event.target) {
        event.target.classList.add('active');
      }

      let filtered = allActionItems;
      if (status !== 'all') {
        filtered = allActionItems.filter(item => item.status === status);
      }
      
      displayActionItems(filtered);
    }

    async function showCreateActionItemModal() {
      const titleEl = document.getElementById('actionItemModalTitle');
      const formEl = document.getElementById('actionItemForm');
      const idEl = document.getElementById('actionItemId');
      const retroIdEl = document.getElementById('actionItemRetrospectiveId');
      const workspaceIdEl = document.getElementById('actionItemWorkspaceId');
      const progressInput = document.getElementById('actionItemProgress');
      const progressDisplay = document.getElementById('progressDisplay');
      
      if (titleEl) titleEl.textContent = 'Create Action Item';
      if (formEl) formEl.reset();
      if (idEl) idEl.value = '';
      if (retroIdEl) retroIdEl.value = '';
      if (workspaceIdEl) workspaceIdEl.value = '';
      
      // Set workspace context if in workspace view
      if (currentWorkspace && workspaceIdEl) {
        workspaceIdEl.value = currentWorkspace.id;
      }
      
      // Reset progress display
      if (progressInput) progressInput.value = 0;
      if (progressDisplay) updateProgressDisplay(0);
      
      // Load assignees for workspace members
      await loadActionItemAssignees();
      
      const modalEl = document.getElementById('actionItemModal');
      if (modalEl && typeof bootstrap !== 'undefined') {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }
    }
    
    let workspaceMembers = [];
    
    async function loadActionItemAssignees() {
      const assignedSelect = document.getElementById('actionItemAssignedTo');
      if (!assignedSelect) return;
      
      // If in workspace view, load workspace members
      if (currentWorkspace) {
        try {
          const response = await fetch(`/api/v1/workspaces/${currentWorkspace.id}/members`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
          });
          if (response.ok) {
            workspaceMembers = await response.json();
          }
        } catch (error) {
          console.error('Failed to load workspace members:', error);
        }
      }
      
      if (currentWorkspace && workspaceMembers && workspaceMembers.length > 0) {
        assignedSelect.innerHTML = '<option value="">Unassigned</option>';
        workspaceMembers.forEach(member => {
          const option = document.createElement('option');
          option.value = member.user_id || member.id;
          option.textContent = member.full_name || member.email || member.username;
          assignedSelect.appendChild(option);
        });
      } else {
        // Otherwise, just load current user
        assignedSelect.innerHTML = '<option value="">Unassigned</option>';
        if (currentUser) {
          const option = document.createElement('option');
          option.value = currentUser.id || currentUser.uid;
          option.textContent = currentUser.displayName || currentUser.email;
          assignedSelect.appendChild(option);
        }
      }
    }

    async function editActionItem(id) {
      const item = allActionItems.find(i => i.id === id);
      if (!item) return;

      const titleEl = document.getElementById('actionItemModalTitle');
      const idEl = document.getElementById('actionItemId');
      const titleInput = document.getElementById('actionItemTitle');
      const descInput = document.getElementById('actionItemDescription');
      const prioritySelect = document.getElementById('actionItemPriority');
      const statusSelect = document.getElementById('actionItemStatus');
      const dueDateInput = document.getElementById('actionItemDueDate');
      const assignedSelect = document.getElementById('actionItemAssignedTo');
      const progressInput = document.getElementById('actionItemProgress');
      const progressDisplay = document.getElementById('progressDisplay');
      
      if (titleEl) titleEl.textContent = 'Edit Action Item';
      if (idEl) idEl.value = item.id;
      if (titleInput) titleInput.value = item.title;
      if (descInput) descInput.value = item.description || '';
      if (prioritySelect) prioritySelect.value = item.priority || 'medium';
      if (statusSelect) statusSelect.value = item.status || 'pending';
      if (progressInput) progressInput.value = item.progress_percentage || 0;
      if (progressDisplay) updateProgressDisplay(item.progress_percentage || 0);
      
      if (dueDateInput && item.due_date) {
        const date = new Date(item.due_date);
        dueDateInput.value = date.toISOString().split('T')[0];
      }
      
      // Load assignees first, then set the selected value
      await loadActionItemAssignees();
      if (assignedSelect) {
        assignedSelect.value = item.assigned_to || '';
      }

      const modalEl = document.getElementById('actionItemModal');
      if (modalEl && typeof bootstrap !== 'undefined') {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }
    }

    async function saveActionItem() {
      const idEl = document.getElementById('actionItemId');
      const id = idEl ? idEl.value : '';
      const titleInput = document.getElementById('actionItemTitle');
      const title = titleInput ? titleInput.value.trim() : '';
      
      if (!title) {
        showToast('Please enter a title', 'danger');
        return;
      }

      const assignedTo = document.getElementById('actionItemAssignedTo')?.value;
      const workspaceId = document.getElementById('actionItemWorkspaceId')?.value;
      const retroId = document.getElementById('actionItemRetrospectiveId')?.value;
      const progress = document.getElementById('actionItemProgress')?.value;

      const data = {
        title: title,
        description: document.getElementById('actionItemDescription')?.value.trim() || null,
        priority: document.getElementById('actionItemPriority')?.value,
        status: document.getElementById('actionItemStatus')?.value,
        due_date: document.getElementById('actionItemDueDate')?.value || null,
        assigned_to: assignedTo && assignedTo !== '' ? parseInt(assignedTo) : null,
        workspace_id: workspaceId && workspaceId !== '' ? parseInt(workspaceId) : null,
        retrospective_id: retroId && retroId !== '' ? parseInt(retroId) : null,
        progress_percentage: progress ? parseInt(progress) : 0
      };

      try {
        const url = id ? `/api/v1/action-items/${id}` : '/api/v1/action-items/';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          showToast(id ? 'Action item updated!' : 'Action item created!', 'success');
          const modalEl = document.getElementById('actionItemModal');
          if (modalEl && typeof bootstrap !== 'undefined') {
            bootstrap.Modal.getInstance(modalEl).hide();
          }
          await loadActionItems();
          // Also refresh workspace action items if in workspace view
          if (currentWorkspace) {
            await loadWorkspaceActionItems();
          }
        } else {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to save action item');
        }
      } catch (error) {
        console.error('Error saving action item:', error);
        showToast('Failed to save: ' + error.message, 'danger');
      }
    }
    
    function updateProgressDisplay(value) {
      const display = document.getElementById('progressDisplay');
      if (display) {
        display.textContent = value + '%';
        // Update badge color based on progress
        if (value < 25) {
          display.className = 'badge bg-danger';
        } else if (value < 50) {
          display.className = 'badge bg-warning';
        } else if (value < 75) {
          display.className = 'badge bg-info';
        } else {
          display.className = 'badge bg-success';
        }
      }
    }

    async function markActionItemComplete(id) {
      if (!confirm('Mark this action item as complete?')) return;

      try {
        const response = await fetch(`/api/v1/action-items/${id}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          showToast('Action item completed!', 'success');
          await loadActionItems();
          if (currentWorkspace) {
            await loadWorkspaceActionItems();
          }
        } else {
          throw new Error('Failed to complete action item');
        }
      } catch (error) {
        console.error('Error completing action item:', error);
        showToast('Failed to complete: ' + error.message, 'danger');
      }
    }

    async function deleteActionItem(id) {
      if (!confirm('Are you sure you want to delete this action item?')) return;

      try {
        const response = await fetch(`/api/v1/action-items/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          showToast('Action item deleted!', 'success');
          await loadActionItems();
          if (currentWorkspace) {
            await loadWorkspaceActionItems();
          }
        } else {
          throw new Error('Failed to delete action item');
        }
      } catch (error) {
        console.error('Error deleting action item:', error);
        showToast('Failed to delete: ' + error.message, 'danger');
      }
    }

    console.log('YodaAI Application Ready!');
  </script>

</body>

</html>
