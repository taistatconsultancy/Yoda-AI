#!/usr/bin/env python3
"""
Database Clear Script for YodaAI
Clears all data from the Neon database while preserving table structure
"""

import sys
from sqlalchemy import text
from app.database.database import engine, SessionLocal
from app.core.config import settings

def clear_all_data():
    """Clear all data from all tables in the database"""
    
    print("üóëÔ∏è  YodaAI Database Clear Script")
    print("=" * 50)
    print(f"Database: {settings.DATABASE_URL.split('@')[1] if '@' in settings.DATABASE_URL else 'Unknown'}")
    print()
    
    # Confirmation prompt
    confirm = input("‚ö†Ô∏è  WARNING: This will delete ALL data from the database!\n"
                   "Are you sure you want to continue? (type 'YES' to confirm): ")
    
    if confirm != 'YES':
        print("‚ùå Operation cancelled.")
        return False
    
    print("\nüîÑ Starting database cleanup...")
    
    # List of tables to clear (in dependency order to avoid foreign key constraints)
    tables_to_clear = [
        # Clear dependent tables first
        'discussion_messages',
        'discussion_topics', 
        'vote_allocations',
        'voting_sessions',
        'theme_groups',
        'retrospective_responses',
        'chat_messages',
        'chat_sessions',
        'retrospective_participants',
        'retrospectives',
        'action_items',
        'workspace_invitations',
        'workspace_members',
        'workspaces',
        'email_verification_tokens',
        'user_onboarding',
        'users',
        'scheduled_retrospectives',
        'team_preparations',
        'automated_reminders'
    ]
    
    try:
        with engine.connect() as conn:
            # Start transaction
            trans = conn.begin()
            
            try:
                cleared_count = 0
                
                for table in tables_to_clear:
                    try:
                        # Check if table exists
                        result = conn.execute(text(f"""
                            SELECT EXISTS (
                                SELECT FROM information_schema.tables 
                                WHERE table_name = '{table}'
                            );
                        """))
                        
                        table_exists = result.scalar()
                        
                        if table_exists:
                            # Get count before clearing
                            count_result = conn.execute(text(f"SELECT COUNT(*) FROM {table};"))
                            count_before = count_result.scalar()
                            
                            if count_before > 0:
                                # Clear the table
                                conn.execute(text(f"DELETE FROM {table};"))
                                print(f"‚úÖ Cleared {count_before} records from '{table}'")
                                cleared_count += count_before
                            else:
                                print(f"‚ÑπÔ∏è  Table '{table}' is already empty")
                        else:
                            print(f"‚ö†Ô∏è  Table '{table}' does not exist, skipping")
                            
                    except Exception as e:
                        print(f"‚ùå Error clearing table '{table}': {e}")
                        # Continue with other tables
                        continue
                
                # Reset sequences (auto-increment counters)
                print("\nüîÑ Resetting auto-increment sequences...")
                sequences_to_reset = [
                    'users_id_seq',
                    'workspaces_id_seq', 
                    'workspace_members_id_seq',
                    'workspace_invitations_id_seq',
                    'retrospectives_id_seq',
                    'retrospective_participants_id_seq',
                    'chat_sessions_id_seq',
                    'chat_messages_id_seq',
                    'retrospective_responses_id_seq',
                    'theme_groups_id_seq',
                    'voting_sessions_id_seq',
                    'vote_allocations_id_seq',
                    'discussion_topics_id_seq',
                    'discussion_messages_id_seq',
                    'action_items_id_seq',
                    'email_verification_tokens_id_seq',
                    'user_onboarding_id_seq',
                    'scheduled_retrospectives_id_seq',
                    'team_preparations_id_seq',
                    'automated_reminders_id_seq'
                ]
                
                for seq in sequences_to_reset:
                    try:
                        conn.execute(text(f"SELECT setval('{seq}', 1, false);"))
                        print(f"‚úÖ Reset sequence '{seq}'")
                    except Exception as e:
                        # Sequence might not exist, that's okay
                        print(f"‚ÑπÔ∏è  Sequence '{seq}' not found (this is normal)")
                
                # Commit transaction
                trans.commit()
                
                print(f"\nüéâ Database cleanup completed successfully!")
                print(f"üìä Total records cleared: {cleared_count}")
                print("‚úÖ All tables are now empty and ready for fresh data")
                
                return True
                
            except Exception as e:
                # Rollback on error
                trans.rollback()
                print(f"‚ùå Error during cleanup: {e}")
                print("üîÑ Transaction rolled back")
                return False
                
    except Exception as e:
        print(f"‚ùå Database connection error: {e}")
        return False

def show_table_counts():
    """Show current record counts for all tables"""
    
    print("üìä Current Database Record Counts")
    print("=" * 40)
    
    tables_to_check = [
        'users', 'workspaces', 'workspace_members', 'workspace_invitations',
        'retrospectives', 'retrospective_participants', 'chat_sessions', 'chat_messages',
        'retrospective_responses', 'theme_groups', 'voting_sessions', 'vote_allocations',
        'discussion_topics', 'discussion_messages', 'action_items',
        'email_verification_tokens', 'user_onboarding'
    ]
    
    try:
        with engine.connect() as conn:
            total_records = 0
            
            for table in tables_to_check:
                try:
                    result = conn.execute(text(f"SELECT COUNT(*) FROM {table};"))
                    count = result.scalar()
                    print(f"{table:25}: {count:>6} records")
                    total_records += count
                except Exception as e:
                    print(f"{table:25}: ERROR - {e}")
            
            print("-" * 40)
            print(f"{'TOTAL':25}: {total_records:>6} records")
            
    except Exception as e:
        print(f"‚ùå Error checking table counts: {e}")

def main():
    """Main function"""
    
    if len(sys.argv) > 1 and sys.argv[1] == '--count':
        show_table_counts()
        return
    
    print("YodaAI Database Management")
    print("=" * 30)
    print("1. Clear all data")
    print("2. Show record counts")
    print("3. Exit")
    print()
    
    choice = input("Select an option (1-3): ").strip()
    
    if choice == '1':
        clear_all_data()
    elif choice == '2':
        show_table_counts()
    elif choice == '3':
        print("üëã Goodbye!")
    else:
        print("‚ùå Invalid option")

if __name__ == "__main__":
    main()
